<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Fantastic Machinarr</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¨</text></svg>">
    <style>
        /* Theme Variables */
        :root {
            --transition: 0.2s ease;
        }
        
        [data-theme="dark"] {
            --bg: #0c0f1a;
            --bg2: #151928;
            --bg3: #1e2538;
            --bg-hover: #252d42;
            --text: #f0f2f5;
            --text2: #8b92a5;
            --text3: #5c6478;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --success: #10b981;
            --success-bg: rgba(16, 185, 129, 0.15);
            --warn: #f59e0b;
            --warn-bg: rgba(245, 158, 11, 0.15);
            --error: #ef4444;
            --error-bg: rgba(239, 68, 68, 0.15);
            --border: #2a3246;
            --border-focus: #6366f1;
            --card-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            --glow: 0 0 20px rgba(99, 102, 241, 0.15);
        }
        
        [data-theme="light"] {
            --bg: #f8f9fb;
            --bg2: #ffffff;
            --bg3: #f0f1f4;
            --bg-hover: #e8e9ed;
            --text: #1a1d26;
            --text2: #5c6478;
            --text3: #8b92a5;
            --accent: #4f46e5;
            --accent-hover: #6366f1;
            --accent-glow: rgba(79, 70, 229, 0.2);
            --success: #059669;
            --success-bg: rgba(5, 150, 105, 0.12);
            --warn: #d97706;
            --warn-bg: rgba(217, 119, 6, 0.12);
            --error: #dc2626;
            --error-bg: rgba(220, 38, 38, 0.12);
            --border: #e2e4e9;
            --border-focus: #4f46e5;
            --card-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            --glow: 0 0 20px rgba(79, 70, 229, 0.08);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: background var(--transition), color var(--transition);
        }
        
        /* Header */
        header {
            background: var(--bg2);
            border-bottom: 1px solid var(--border);
            padding: 16px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all var(--transition);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .status-dots {
            display: flex;
            gap: 10px;
        }
        
        .dot {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: var(--bg3);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid var(--border);
            transition: all var(--transition);
        }
        
        .dot-ind {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text3);
        }
        
        .dot-ind.on {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }
        
        .dot-ind.off {
            background: var(--error);
        }
        
        .theme-btn, .settings-btn {
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 16px;
            transition: all var(--transition);
            color: var(--text);
        }
        
        .theme-btn:hover, .settings-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }
        
        /* Scoreboard */
        .scoreboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            padding: 24px 28px;
            background: var(--bg2);
            border-bottom: 1px solid var(--border);
        }
        
        .score-card {
            background: var(--bg3);
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all var(--transition);
        }
        
        .score-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }
        
        .score-val {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -1px;
        }
        
        .score-label {
            font-size: 12px;
            color: var(--text2);
            margin-top: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .score-card.hot {
            border-left: 4px solid var(--error);
        }
        
        .score-card.api {
            border-left: 4px solid var(--accent);
        }
        
        /* Main layout */
        main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            padding: 24px 28px;
        }
        
        @media (max-width: 1024px) {
            main { grid-template-columns: 1fr; }
            .scoreboard { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* Panels */
        .panel {
            background: var(--bg2);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all var(--transition);
        }
        
        .panel:hover {
            box-shadow: var(--card-shadow);
        }
        
        .panel-head {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg3);
        }
        
        .panel-title {
            font-weight: 600;
            font-size: 15px;
            letter-spacing: -0.2px;
        }
        
        .panel-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .panel-body.flush { padding: 0; }
        
        .panel-body::-webkit-scrollbar {
            width: 6px;
        }
        
        .panel-body::-webkit-scrollbar-track {
            background: var(--bg3);
        }
        
        .panel-body::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        /* Tiers */
        .tiers {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
        }
        
        .tier {
            flex: 1;
            min-width: 90px;
            background: var(--bg3);
            padding: 18px 14px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all var(--transition);
        }
        
        .tier:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        
        .tier-emoji { font-size: 28px; }
        .tier-count { font-size: 26px; font-weight: 700; margin: 6px 0; }
        .tier-name { font-size: 11px; color: var(--text2); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        
        /* Items list */
        .item {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
            gap: 14px;
            transition: all var(--transition);
        }
        
        .item:last-child { border: none; }
        .item:hover { background: var(--bg-hover); }
        
        .item-icon { font-size: 22px; }
        .item-info { flex: 1; min-width: 0; }
        .item-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-meta { font-size: 12px; color: var(--text2); margin-top: 3px; }
        
        .item-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .item-badge.hot { background: var(--error-bg); color: var(--error); }
        .item-badge.warm { background: var(--warn-bg); color: var(--warn); }
        .item-badge.cool { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .item-badge.cold { background: var(--accent-glow); color: var(--accent); }
        .item-badge.issue { background: var(--error-bg); color: var(--error); }
        
        /* Buttons */
        .btn {
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all var(--transition);
        }
        
        .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 8px; }
        
        .btn-pri {
            background: var(--accent);
            color: #fff;
        }
        
        .btn-pri:hover {
            background: var(--accent-hover);
            box-shadow: 0 4px 12px var(--accent-glow);
        }
        
        .btn-sec {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-sec:hover {
            background: var(--bg-hover);
            border-color: var(--text3);
        }
        
        /* Empty state */
        .empty {
            text-align: center;
            padding: 50px 24px;
            color: var(--text2);
        }
        
        .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.6; }
        
        /* Logs */
        .log {
            padding: 10px 14px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 12px;
            border-bottom: 1px solid var(--border);
            transition: all var(--transition);
        }
        
        .log:hover { background: var(--bg-hover); }
        .log-time { color: var(--text3); margin-right: 10px; }
        
        .log-level {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .log-level.INFO { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .log-level.WARNING { background: var(--warn-bg); color: var(--warn); }
        .log-level.ERROR { background: var(--error-bg); color: var(--error); }
        .log-level.DEBUG { background: rgba(156,163,175,0.15); color: #9ca3af; }
        
        /* Storage */
        .storage-bar { margin-bottom: 18px; }
        .storage-head { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .storage-path { font-family: monospace; color: var(--text2); }
        
        .bar {
            height: 10px;
            background: var(--bg3);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .bar-fill {
            height: 100%;
            background: var(--success);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        .bar-fill.warn { background: var(--warn); }
        .bar-fill.crit { background: var(--error); }
        
        /* Modals */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: var(--bg2);
            border-radius: 16px;
            padding: 28px;
            max-width: 520px;
            width: 90%;
            border: 1px solid var(--border);
            box-shadow: var(--card-shadow);
        }
        
        .modal h3 {
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .modal-actions .btn { flex: 1; }
        
        /* Settings modal inputs */
        .settings-field {
            margin-bottom: 18px;
        }
        
        .settings-field label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .settings-field input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            transition: all var(--transition);
        }
        
        .settings-field input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        .settings-field .hint {
            font-size: 12px;
            color: var(--text3);
            margin-top: 6px;
        }
        
        /* Spinner */
        .spinner {
            width: 28px;
            height: 28px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 24px auto;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Full width panel */
        .full-width { grid-column: 1 / -1; }
        
        /* Version footer */
        .version-footer {
            text-align: center;
            padding: 16px;
            font-size: 11px;
            color: var(--text3);
            border-top: 1px solid var(--border);
            background: var(--bg2);
        }
    </style>
</head>
<body>
    <header>
        <div class="logo"><span>üé¨</span> The Fantastic Machinarr</div>
        <div class="header-right">
            <div class="status-dots" id="status-dots"></div>
            <button class="theme-btn" onclick="toggleTheme()" title="Toggle theme">üåô</button>
            <button class="settings-btn" onclick="openSettingsModal()" title="Settings">‚öôÔ∏è</button>
        </div>
    </header>
    
    <div class="scoreboard">
        <div class="score-card hot">
            <div class="score-val" id="finds-today">0</div>
            <div class="score-label">Finds Today</div>
        </div>
        <div class="score-card">
            <div class="score-val" id="finds-total">0</div>
            <div class="score-label">Total Finds</div>
        </div>
        <div class="score-card api">
            <div class="score-val" id="api-used">0</div>
            <div class="score-label">API Hits Today</div>
        </div>
        <div class="score-card">
            <div class="score-val" id="api-limit">500</div>
            <div class="score-label">Daily Limit</div>
        </div>
    </div>
    
    <main>
        <!-- Tier Summary -->
        <div class="panel">
            <div class="panel-head">
                <span class="panel-title">Missing Content by Tier</span>
                <button class="btn btn-sm btn-sec" onclick="runSearch()">üîç Run Search</button>
            </div>
            <div class="panel-body">
                <div class="tiers">
                    <div class="tier"><div class="tier-emoji">üî•</div><div class="tier-count" id="tier-hot">-</div><div class="tier-name">Hot</div></div>
                    <div class="tier"><div class="tier-emoji">‚òÄÔ∏è</div><div class="tier-count" id="tier-warm">-</div><div class="tier-name">Warm</div></div>
                    <div class="tier"><div class="tier-emoji">‚ùÑÔ∏è</div><div class="tier-count" id="tier-cool">-</div><div class="tier-name">Cool</div></div>
                    <div class="tier"><div class="tier-emoji">üßä</div><div class="tier-count" id="tier-cold">-</div><div class="tier-name">Cold</div></div>
                </div>
            </div>
        </div>
        
        <!-- Stuck Queue Items -->
        <div class="panel">
            <div class="panel-head">
                <span class="panel-title">‚ö†Ô∏è Queue Issues</span>
                <span id="stuck-count" style="color:var(--text2);font-size:13px">0 items</span>
            </div>
            <div class="panel-body flush" id="stuck-list">
                <div class="empty"><div class="empty-icon">‚úÖ</div><p>No stuck items</p></div>
            </div>
        </div>
        
        <!-- Manual Interventions -->
        <div class="panel">
            <div class="panel-head">
                <span class="panel-title">üñêÔ∏è Manual Intervention</span>
                <span id="intervention-count" style="color:var(--text2);font-size:13px">0 items</span>
            </div>
            <div class="panel-body flush" id="intervention-list">
                <div class="empty"><div class="empty-icon">üëç</div><p>No intervention needed</p></div>
            </div>
        </div>
        
        <!-- Storage -->
        <div class="panel">
            <div class="panel-head">
                <span class="panel-title">üíæ Storage</span>
            </div>
            <div class="panel-body" id="storage-list">
                <div class="spinner"></div>
            </div>
        </div>
        
        <!-- Recent Finds - Separate Prominent Pane -->
        <div class="panel">
            <div class="panel-head">
                <span class="panel-title">üéâ Recent Finds</span>
                <span id="finds-count" style="color:var(--text2);font-size:13px">0 items</span>
            </div>
            <div class="panel-body flush" id="finds-list" style="max-height:350px">
                <div class="empty"><div class="empty-icon">üîç</div><p>No finds yet - TFM is working on it!</p></div>
            </div>
        </div>
        
        <!-- Recent Searches -->
        <div class="panel">
            <div class="panel-head">
                <span class="panel-title">üîé Recent Searches</span>
            </div>
            <div class="panel-body flush" id="search-list" style="max-height:350px">
                <div class="empty"><div class="empty-icon">‚è≥</div><p>No searches yet</p></div>
            </div>
        </div>
        
        <!-- Debug Logs -->
        <div class="panel full-width">
            <div class="panel-head">
                <span class="panel-title">üìã Debug Logs</span>
                <select id="log-filter" onchange="loadLogs()" style="background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:5px 10px;border-radius:4px">
                    <option value="">All</option>
                    <option value="ERROR">Errors</option>
                    <option value="WARNING">Warnings</option>
                    <option value="INFO">Info</option>
                    <option value="DEBUG">Debug</option>
                </select>
            </div>
            <div class="panel-body flush" id="log-list" style="max-height:300px">
                <div class="spinner"></div>
            </div>
        </div>
    </main>
    
    <!-- Intervention Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h3 id="modal-title">Manual Intervention</h3>
            <p id="modal-desc"></p>
            <div id="modal-details"></div>
            <div class="modal-actions" id="modal-actions"></div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content" style="max-width: 680px; max-height: 85vh; overflow-y: auto;">
            <h3>‚öôÔ∏è Settings</h3>
            
            <div class="settings-field">
                <label>üé® Theme</label>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-sec" id="theme-dark-btn" onclick="setTheme('dark')" style="flex:1;">üåô Dark</button>
                    <button class="btn btn-sec" id="theme-light-btn" onclick="setTheme('light')" style="flex:1;">‚òÄÔ∏è Light</button>
                </div>
            </div>
            
            <div class="settings-field">
                <label>üìä Daily API Limit</label>
                <input type="number" id="settings-api-limit" value="500" min="50" max="50000">
                <div class="hint">TFM spreads searches throughout the day to stay within this limit.</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="settings-field" style="margin-bottom: 0;">
                    <label>üîç Searches Per Cycle</label>
                    <input type="number" id="settings-per-cycle" value="10" min="1" max="50">
                </div>
                <div class="settings-field" style="margin-bottom: 0;">
                    <label>‚è±Ô∏è Cycle Interval (min)</label>
                    <input type="number" id="settings-interval" value="60" min="15" max="360">
                </div>
            </div>
            
            <h4 style="margin: 24px 0 12px; font-size: 14px;">üéØ Search Tier Configuration</h4>
            <div class="hint" style="margin-bottom: 12px;">Define age ranges (in days) and search frequency for each tier.</div>
            
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                <div style="background: var(--bg3); padding: 12px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px;">üî•</div>
                    <div style="font-weight: 600; margin: 4px 0;">Hot</div>
                    <div style="display: flex; gap: 4px; margin: 8px 0;">
                        <input type="number" id="settings-hot-min" value="0" min="0" style="width: 50%; padding: 6px; font-size: 11px;" disabled>
                        <input type="number" id="settings-hot-max" value="90" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                    </div>
                    <div style="font-size: 10px; color: var(--text3);">days old</div>
                    <select id="settings-hot-interval" style="width: 100%; padding: 6px; margin-top: 8px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                        <option value="30">30 min</option>
                        <option value="60" selected>1 hour</option>
                        <option value="120">2 hours</option>
                        <option value="180">3 hours</option>
                        <option value="360">6 hours</option>
                    </select>
                </div>
                <div style="background: var(--bg3); padding: 12px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px;">‚òÄÔ∏è</div>
                    <div style="font-weight: 600; margin: 4px 0;">Warm</div>
                    <div style="display: flex; gap: 4px; margin: 8px 0;">
                        <input type="number" id="settings-warm-min" value="90" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                        <input type="number" id="settings-warm-max" value="365" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                    </div>
                    <div style="font-size: 10px; color: var(--text3);">days old</div>
                    <select id="settings-warm-interval" style="width: 100%; padding: 6px; margin-top: 8px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                        <option value="180">3 hours</option>
                        <option value="360" selected>6 hours</option>
                        <option value="720">12 hours</option>
                        <option value="1440">Daily</option>
                    </select>
                </div>
                <div style="background: var(--bg3); padding: 12px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px;">‚ùÑÔ∏è</div>
                    <div style="font-weight: 600; margin: 4px 0;">Cool</div>
                    <div style="display: flex; gap: 4px; margin: 8px 0;">
                        <input type="number" id="settings-cool-min" value="365" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                        <input type="number" id="settings-cool-max" value="1095" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                    </div>
                    <div style="font-size: 10px; color: var(--text3);">days old</div>
                    <select id="settings-cool-interval" style="width: 100%; padding: 6px; margin-top: 8px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                        <option value="720">12 hours</option>
                        <option value="1440" selected>Daily</option>
                        <option value="2880">2 days</option>
                        <option value="4320">3 days</option>
                    </select>
                </div>
                <div style="background: var(--bg3); padding: 12px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px;">üßä</div>
                    <div style="font-weight: 600; margin: 4px 0;">Cold</div>
                    <div style="display: flex; gap: 4px; margin: 8px 0;">
                        <input type="number" id="settings-cold-min" value="1095" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                        <input type="text" value="‚àû" style="width: 50%; padding: 6px; font-size: 11px; text-align: center;" disabled>
                    </div>
                    <div style="font-size: 10px; color: var(--text3);">days old</div>
                    <select id="settings-cold-interval" style="width: 100%; padding: 6px; margin-top: 8px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                        <option value="4320">3 days</option>
                        <option value="10080" selected>Weekly</option>
                        <option value="20160">2 weeks</option>
                        <option value="43200">Monthly</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-actions" style="margin-top: 24px;">
                <button class="btn btn-sec" onclick="closeSettingsModal()">Cancel</button>
                <button class="btn btn-pri" onclick="saveSettings()">Save Settings</button>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); text-align: center;">
                <a href="/setup" style="color: var(--text2); font-size: 13px; text-decoration: none;">Run Setup Wizard Again ‚Üí</a>
            </div>
        </div>
    </div>
    
    <script>
        // Theme management
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            setTheme(current === 'dark' ? 'light' : 'dark');
        }
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('tfm-theme', theme);
            document.querySelector('.theme-btn').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            updateThemeButtons();
        }
        
        function updateThemeButtons() {
            const theme = document.documentElement.getAttribute('data-theme');
            const darkBtn = document.getElementById('theme-dark-btn');
            const lightBtn = document.getElementById('theme-light-btn');
            if (darkBtn && lightBtn) {
                darkBtn.style.background = theme === 'dark' ? 'var(--accent)' : '';
                darkBtn.style.color = theme === 'dark' ? '#fff' : '';
                lightBtn.style.background = theme === 'light' ? 'var(--accent)' : '';
                lightBtn.style.color = theme === 'light' ? '#fff' : '';
            }
        }
        
        // Load saved theme
        const savedTheme = localStorage.getItem('tfm-theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.querySelector('.theme-btn').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    
        async function api(endpoint, method = 'GET', data = null) {
            const opts = { method, headers: {'Content-Type': 'application/json'} };
            if (data) opts.body = JSON.stringify(data);
            const r = await fetch('/api/' + endpoint, opts);
            return r.json();
        }
        
        function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        function fmt(iso) { try { return new Date(iso).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); } catch { return ''; } }
        
        async function loadStatus() {
            const data = await api('status');
            const dots = document.getElementById('status-dots');
            let html = '';
            for (const [key, svc] of Object.entries(data.services || {})) {
                html += `<div class="dot"><span class="dot-ind ${svc.connected ? 'on' : 'off'}"></span>${svc.name}</div>`;
            }
            dots.innerHTML = html;
        }
        
        async function loadDashboard() {
            const data = await api('dashboard');
            if (data.scoreboard) {
                document.getElementById('finds-today').textContent = data.scoreboard.finds_today;
                document.getElementById('finds-total').textContent = data.scoreboard.finds_total;
                document.getElementById('api-used').textContent = data.scoreboard.api_hits_today;
                document.getElementById('api-limit').textContent = data.scoreboard.api_limit;
            }
            if (data.tiers) {
                document.getElementById('tier-hot').textContent = data.tiers.hot?.count ?? 0;
                document.getElementById('tier-warm').textContent = data.tiers.warm?.count ?? 0;
                document.getElementById('tier-cool').textContent = data.tiers.cool?.count ?? 0;
                document.getElementById('tier-cold').textContent = data.tiers.cold?.count ?? 0;
            }
        }
        
        async function loadQueue() {
            const data = await api('queue');
            const el = document.getElementById('stuck-list');
            document.getElementById('stuck-count').textContent = `${data.total_stuck || 0} items`;
            
            if (!data.stuck_items?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">‚úÖ</div><p>No stuck items</p></div>';
                return;
            }
            
            el.innerHTML = data.stuck_items.slice(0, 20).map(item => `
                <div class="item">
                    <div class="item-icon">‚ö†Ô∏è</div>
                    <div class="item-info">
                        <div class="item-title">${esc(item.title)}</div>
                        <div class="item-meta">${item.issues.join(', ')} ‚Ä¢ ${item.stuck_minutes}m stuck</div>
                    </div>
                    ${item.can_auto_resolve ? '<span class="item-badge" style="background:rgba(34,197,94,0.2);color:#22c55e">Auto</span>' : ''}
                    <button class="btn btn-sm btn-sec" onclick="resolveItem('${item.source}',${item.queue_id})">Resolve</button>
                </div>
            `).join('');
        }
        
        async function loadInterventions() {
            const data = await api('interventions');
            const el = document.getElementById('intervention-list');
            document.getElementById('intervention-count').textContent = `${data.count || 0} items`;
            
            if (!data.items?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üëç</div><p>No intervention needed</p></div>';
                return;
            }
            
            el.innerHTML = data.items.slice(0, 20).map(item => `
                <div class="item">
                    <div class="item-icon">üñêÔ∏è</div>
                    <div class="item-info">
                        <div class="item-title">${esc(item.title)}</div>
                        <div class="item-meta">${esc(item.reason)}</div>
                    </div>
                    <button class="btn btn-sm btn-pri" onclick="showIntervention(${JSON.stringify(item).replace(/"/g, '&quot;')})">Actions</button>
                </div>
            `).join('');
        }
        
        async function loadStorage() {
            const data = await api('storage');
            const el = document.getElementById('storage-list');
            
            if (!data.paths?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üíæ</div><p>No storage info</p></div>';
                return;
            }
            
            el.innerHTML = data.paths.map(p => {
                const pct = 100 - (p.free_gb / (p.free_gb + 100)) * 100; // Rough estimate
                const cls = pct > 90 ? 'crit' : pct > 75 ? 'warn' : '';
                return `
                <div class="storage-bar">
                    <div class="storage-head">
                        <span class="storage-path">${esc(p.path)}</span>
                        <span>${p.free_gb} GB free</span>
                    </div>
                    <div class="bar"><div class="bar-fill ${cls}" style="width:${100-pct}%"></div></div>
                </div>`;
            }).join('');
        }
        
        async function loadFinds() {
            const data = await api('finds?limit=30');
            const el = document.getElementById('finds-list');
            document.getElementById('finds-count').textContent = `${data.finds?.length || 0} items`;
            
            if (!data.finds?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><p>No finds yet - TFM is working on it!</p></div>';
                return;
            }
            
            const typeIcons = {
                'auto': 'ü§ñ',
                'manual': 'üñêÔ∏è',
                'rss': 'üì°',
                'search': 'üîé'
            };
            
            const typeLabels = {
                'auto': 'Auto-resolved',
                'manual': 'Manual intervention',
                'rss': 'RSS sync',
                'search': 'Scheduled search'
            };
            
            el.innerHTML = data.finds.reverse().map(f => `
                <div class="item">
                    <div class="item-icon">üéâ</div>
                    <div class="item-info">
                        <div class="item-title">${esc(f.title)}</div>
                        <div class="item-meta">
                            ${typeIcons[f.resolution_type] || '‚úÖ'} ${typeLabels[f.resolution_type] || f.resolution_type}
                            ${f.resolution_detail ? ' ‚Ä¢ ' + esc(f.resolution_detail) : ''}
                            ‚Ä¢ ${fmt(f.timestamp)}
                        </div>
                    </div>
                    <span class="item-badge" style="background:rgba(34,197,94,0.2);color:#22c55e">${f.source}</span>
                </div>
            `).join('');
        }
        
        async function loadSearches() {
            const data = await api('searches?limit=20');
            const el = document.getElementById('search-list');
            
            if (!data.searches?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">‚è≥</div><p>No searches yet</p></div>';
                return;
            }
            
            el.innerHTML = data.searches.reverse().map(s => `
                <div class="item">
                    <div class="item-icon">${s.success ? '‚úÖ' : '‚ùå'}</div>
                    <div class="item-info">
                        <div class="item-title">${esc(s.title)}</div>
                        <div class="item-meta">${s.tier_emoji} ${s.tier} ‚Ä¢ ${s.source} ‚Ä¢ ${fmt(s.timestamp)}</div>
                    </div>
                </div>
            `).join('');
        }
        
        async function loadLogs() {
            const level = document.getElementById('log-filter').value;
            const data = await api('logs?limit=100' + (level ? '&level=' + level : ''));
            const el = document.getElementById('log-list');
            
            if (!data.logs?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üìã</div><p>No logs</p></div>';
                return;
            }
            
            el.innerHTML = data.logs.reverse().map(l => `
                <div class="log">
                    <span class="log-time">${fmt(l.timestamp)}</span>
                    <span class="log-level ${l.level}">${l.level}</span>
                    ${esc(l.message)}
                </div>
            `).join('');
        }
        
        async function runSearch() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Searching...';
            
            const data = await api('search', 'POST', {type: 'cycle'});
            
            btn.disabled = false;
            btn.textContent = 'üîç Run Search';
            
            alert(`Searched ${data.searched || 0} items`);
            loadDashboard();
            loadSearches();
        }
        
        async function resolveItem(source, queueId) {
            const data = await api('resolve', 'POST', {source, queue_id: queueId, action: 'blocklist_retry'});
            if (data.success) {
                loadQueue();
            } else {
                alert('Failed: ' + data.message);
            }
        }
        
        function showIntervention(item) {
            document.getElementById('modal-title').textContent = item.title;
            document.getElementById('modal-desc').textContent = item.reason;
            document.getElementById('modal-details').innerHTML = `<p style="color:var(--text2);font-size:13px;margin-top:10px">${JSON.stringify(item.details)}</p>`;
            
            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-sec" onclick="dismissIntervention('${item.source}',${item.id},'${item.intervention_type}')">Dismiss</button>
                <button class="btn btn-pri" onclick="closeModal()">Close</button>
            `;
            
            document.getElementById('modal').classList.add('show');
        }
        
        async function dismissIntervention(source, id, type) {
            await api('intervention/dismiss', 'POST', {source, id, type});
            closeModal();
            loadInterventions();
        }
        
        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }
        
        async function openSettingsModal() {
            // Load current settings
            const data = await api('settings');
            if (data.search) {
                document.getElementById('settings-api-limit').value = data.search.daily_api_limit || 500;
                document.getElementById('settings-per-cycle').value = data.search.searches_per_cycle || 10;
                document.getElementById('settings-interval').value = data.search.cycle_interval_minutes || 60;
            }
            if (data.tiers) {
                // Hot
                document.getElementById('settings-hot-max').value = data.tiers.hot?.max_days || 90;
                document.getElementById('settings-hot-interval').value = data.tiers.hot?.interval_minutes || 60;
                // Warm
                document.getElementById('settings-warm-min').value = data.tiers.warm?.min_days || 90;
                document.getElementById('settings-warm-max').value = data.tiers.warm?.max_days || 365;
                document.getElementById('settings-warm-interval').value = data.tiers.warm?.interval_minutes || 360;
                // Cool
                document.getElementById('settings-cool-min').value = data.tiers.cool?.min_days || 365;
                document.getElementById('settings-cool-max').value = data.tiers.cool?.max_days || 1095;
                document.getElementById('settings-cool-interval').value = data.tiers.cool?.interval_minutes || 1440;
                // Cold
                document.getElementById('settings-cold-min').value = data.tiers.cold?.min_days || 1095;
                document.getElementById('settings-cold-interval').value = data.tiers.cold?.interval_minutes || 10080;
            }
            updateThemeButtons();
            document.getElementById('settings-modal').classList.add('show');
        }
        
        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('show');
        }
        
        async function saveSettings() {
            const settings = {
                search: {
                    daily_api_limit: parseInt(document.getElementById('settings-api-limit').value) || 500,
                    searches_per_cycle: parseInt(document.getElementById('settings-per-cycle').value) || 10,
                    cycle_interval_minutes: parseInt(document.getElementById('settings-interval').value) || 60
                },
                tiers: {
                    hot: {
                        min_days: 0,
                        max_days: parseInt(document.getElementById('settings-hot-max').value) || 90,
                        interval_minutes: parseInt(document.getElementById('settings-hot-interval').value) || 60
                    },
                    warm: {
                        min_days: parseInt(document.getElementById('settings-warm-min').value) || 90,
                        max_days: parseInt(document.getElementById('settings-warm-max').value) || 365,
                        interval_minutes: parseInt(document.getElementById('settings-warm-interval').value) || 360
                    },
                    cool: {
                        min_days: parseInt(document.getElementById('settings-cool-min').value) || 365,
                        max_days: parseInt(document.getElementById('settings-cool-max').value) || 1095,
                        interval_minutes: parseInt(document.getElementById('settings-cool-interval').value) || 1440
                    },
                    cold: {
                        min_days: parseInt(document.getElementById('settings-cold-min').value) || 1095,
                        max_days: null,
                        interval_minutes: parseInt(document.getElementById('settings-cold-interval').value) || 10080
                    }
                }
            };
            const result = await api('settings', 'POST', settings);
            if (result.success) {
                closeSettingsModal();
                loadDashboard(); // Refresh to show new limit
            } else {
                alert('Failed to save settings: ' + result.message);
            }
        }
        
        // Close modals when clicking outside
        document.getElementById('settings-modal').addEventListener('click', function(e) {
            if (e.target === this) closeSettingsModal();
        });
        
        // Initial load
        loadStatus();
        loadDashboard();
        loadQueue();
        loadInterventions();
        loadStorage();
        loadFinds();
        loadSearches();
        loadLogs();
        
        // Refresh periodically
        setInterval(loadStatus, 30000);
        setInterval(loadDashboard, 60000);
        setInterval(loadQueue, 60000);
        setInterval(loadFinds, 60000);
        setInterval(loadLogs, 30000);
    </script>
    <div class="version-footer">The Fantastic Machinarr v1.0.6b</div>
</body>
</html>
