<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Fantastic Machinarr</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¨</text></svg>">
    <style>
        /* Theme Variables */
        :root {
            --transition: 0.2s ease;
        }
        
        [data-theme="dark"] {
            --bg: #0c0f1a;
            --bg2: #151928;
            --bg3: #1e2538;
            --bg-hover: #252d42;
            --text: #f0f2f5;
            --text2: #8b92a5;
            --text3: #5c6478;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --success: #10b981;
            --success-bg: rgba(16, 185, 129, 0.15);
            --warn: #f59e0b;
            --warn-bg: rgba(245, 158, 11, 0.15);
            --error: #ef4444;
            --error-bg: rgba(239, 68, 68, 0.15);
            --border: #2a3246;
            --border-focus: #6366f1;
            --card-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            --glow: 0 0 20px rgba(99, 102, 241, 0.15);
        }
        
        [data-theme="light"] {
            --bg: #c8cdd5;
            --bg2: #d8dce3;
            --bg3: #bec4ce;
            --bg-hover: #b5bcc8;
            --text: #1a1f2e;
            --text2: #3d4556;
            --text3: #5a6275;
            --accent: #4f54b5;
            --accent-hover: #6266c7;
            --accent-glow: rgba(79, 84, 181, 0.3);
            --success: #0d7d73;
            --success-bg: rgba(13, 125, 115, 0.18);
            --warn: #b57a04;
            --warn-bg: rgba(181, 122, 4, 0.18);
            --error: #c42020;
            --error-bg: rgba(196, 32, 32, 0.18);
            --border: #a8b0bc;
            --border-focus: #4f54b5;
            --card-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);
            --glow: 0 0 20px rgba(79, 84, 181, 0.15);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: background var(--transition), color var(--transition);
        }
        
        /* Header */
        header {
            background: var(--bg2);
            border-bottom: 1px solid var(--border);
            padding: 16px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all var(--transition);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .status-dots {
            display: flex;
            gap: 10px;
        }
        
        .dot {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: var(--bg3);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid var(--border);
            transition: all var(--transition);
        }
        
        .dot-ind {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text3);
        }
        
        .dot-ind.on {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }
        
        .dot-ind.off {
            background: var(--error);
        }
        
        .theme-btn, .settings-btn {
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 16px;
            transition: all var(--transition);
            color: var(--text);
        }
        
        .theme-btn:hover, .settings-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }
        
        /* Scoreboard */
        .scoreboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            padding: 24px 28px;
            background: var(--bg2);
            border-bottom: 1px solid var(--border);
        }
        
        .score-card {
            background: var(--bg3);
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all var(--transition);
        }
        
        .score-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }
        
        .score-val {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -1px;
        }
        
        .score-label {
            font-size: 12px;
            color: var(--text2);
            margin-top: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .score-card.hot {
            border-left: 4px solid var(--error);
        }
        
        .score-card.api {
            border-left: 4px solid var(--accent);
        }
        
        /* Main layout - all full width rows */
        main {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 24px 28px;
        }
        
        @media (max-width: 1024px) {
            .scoreboard { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* Panels */
        .panel {
            background: var(--bg2);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all var(--transition);
        }
        
        .panel:hover {
            box-shadow: var(--card-shadow);
        }
        
        .panel-head {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg3);
        }
        
        .panel-title {
            font-weight: 600;
            font-size: 15px;
            letter-spacing: -0.2px;
        }
        
        .panel-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .panel-body.flush { padding: 0; }
        
        .panel-body::-webkit-scrollbar {
            width: 6px;
        }
        
        .panel-body::-webkit-scrollbar-track {
            background: var(--bg3);
        }
        
        .panel-body::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        /* Panel Row - side by side panels */
        .panel-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .panel.half {
            margin-bottom: 0;
        }
        
        @media (max-width: 900px) {
            .panel-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* Compact Scoreboard */
        .scoreboard.compact {
            padding: 12px 20px;
            gap: 16px;
        }
        
        .scoreboard.compact .score-card {
            padding: 12px 16px;
            min-width: 100px;
        }
        
        .scoreboard.compact .score-val {
            font-size: 28px;
        }
        
        .scoreboard.compact .score-label {
            font-size: 10px;
        }
        
        .score-breakdown {
            font-size: 10px;
            color: var(--text3);
            margin-top: 2px;
        }
        
        .score-card.status {
            background: var(--bg3);
        }
        
        .score-card.status .score-val {
            font-size: 24px;
        }
        
        .score-card.status.active {
            background: var(--success-bg);
            border-color: var(--success);
        }
        
        .score-card.status.paused {
            background: var(--warn-bg);
            border-color: var(--warn);
        }
        
        .score-card.status.exhausted {
            background: var(--error-bg);
            border-color: var(--error);
        }
        
        /* Storage Summary */
        .storage-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .storage-item {
            background: var(--bg3);
            padding: 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        
        .storage-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .storage-item-label {
            font-weight: 600;
            font-size: 13px;
        }
        
        .storage-item-value {
            font-size: 12px;
            color: var(--text2);
        }
        
        .storage-bar {
            height: 8px;
            background: var(--bg);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .storage-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .storage-bar-fill.ok { background: var(--success); }
        .storage-bar-fill.warn { background: var(--warn); }
        .storage-bar-fill.critical { background: var(--error); }
        
        .storage-details {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text3);
        }
        
        /* Tiers */
        .tiers {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
        }
        
        .tier {
            flex: 1;
            min-width: 90px;
            background: var(--bg3);
            padding: 18px 14px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all var(--transition);
        }
        
        .tier:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        
        .tier-emoji { font-size: 28px; }
        .tier-count { font-size: 26px; font-weight: 700; margin: 6px 0; }
        .tier-name { font-size: 11px; color: var(--text2); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .tier-desc { font-size: 10px; color: var(--text3); margin-top: 4px; }
        .tier-breakdown {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            font-size: 10px;
            color: var(--text2);
        }
        .tier-breakdown span { display: flex; align-items: center; gap: 4px; }
        
        /* Horizontal tier layout */
        .tiers.tiers-horizontal {
            gap: 12px;
        }
        .tiers.tiers-horizontal .tier {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            border-radius: 10px;
            text-align: left;
        }
        .tiers.tiers-horizontal .tier-emoji { 
            font-size: 28px; 
            flex-shrink: 0;
        }
        .tiers.tiers-horizontal .tier-info {
            display: flex;
            align-items: baseline;
            gap: 10px;
            flex: 1;
        }
        .tiers.tiers-horizontal .tier-count { 
            font-size: 28px; 
            font-weight: 700; 
            margin: 0;
            line-height: 1;
        }
        .tiers.tiers-horizontal .tier-labels {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .tiers.tiers-horizontal .tier-name { 
            font-size: 13px; 
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .tiers.tiers-horizontal .tier-desc { 
            font-size: 11px; 
            margin-top: 0;
            color: var(--text3);
        }
        .tiers.tiers-horizontal .tier-breakdown {
            font-size: 10px;
            color: var(--text2);
            margin-top: 2px;
            display: flex;
            gap: 8px;
            border: none;
            padding: 0;
        }
        .tiers.tiers-horizontal .tier-breakdown span {
            display: inline;
        }
        
        /* Lifecycle states */
        .lifecycle-state {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .lifecycle-state.searching { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .lifecycle-state.cooldown { background: var(--bg3); color: var(--text2); }
        .lifecycle-state.escalating { background: var(--warn-bg); color: var(--warn); }
        .lifecycle-state.needs_attention { background: var(--error-bg); color: var(--error); }
        .lifecycle-state.found { background: var(--success-bg); color: var(--success); }
        .lifecycle-state.error { background: var(--error-bg); color: var(--error); }
        
        /* Search filters */
        .search-filters {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-filters input[type="text"] {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 13px;
            min-width: 200px;
        }
        .search-filters input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .search-filters select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
        }
        
        /* Items list */
        .item {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
            gap: 14px;
            transition: all var(--transition);
        }
        
        .item:last-child { border: none; }
        .item:hover { background: var(--bg-hover); }
        
        .item-icon { font-size: 22px; }
        .item-info { flex: 1; min-width: 0; }
        .item-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-meta { font-size: 12px; color: var(--text2); margin-top: 3px; }
        
        .item-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .item-badge.hot { background: var(--error-bg); color: var(--error); }
        .item-badge.warm { background: var(--warn-bg); color: var(--warn); }
        .item-badge.cool { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .item-badge.cold { background: var(--accent-glow); color: var(--accent); }
        .item-badge.issue { background: var(--error-bg); color: var(--error); }
        
        /* Buttons */
        .btn {
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all var(--transition);
        }
        
        .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 8px; }
        
        .btn-pri {
            background: var(--accent);
            color: #fff;
        }
        
        .btn-pri:hover {
            background: var(--accent-hover);
            box-shadow: 0 4px 12px var(--accent-glow);
        }
        
        .btn-sec {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-sec:hover {
            background: var(--bg-hover);
            border-color: var(--text3);
        }
        
        /* Empty state */
        .empty {
            text-align: center;
            padding: 50px 24px;
            color: var(--text2);
        }
        
        .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.6; }
        
        /* Logs */
        .log {
            padding: 10px 14px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 12px;
            border-bottom: 1px solid var(--border);
            transition: all var(--transition);
        }
        
        .log:hover { background: var(--bg-hover); }
        .log-time { color: var(--text3); margin-right: 10px; }
        
        .log-level {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .log-level.INFO { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .log-level.WARNING { background: var(--warn-bg); color: var(--warn); }
        .log-level.ERROR { background: var(--error-bg); color: var(--error); }
        .log-level.DEBUG { background: rgba(156,163,175,0.15); color: #9ca3af; }
        
        /* Compact row for tier + storage */
        .compact-row {
            display: flex;
            gap: 16px;
        }
        
        .compact-row .panel {
            margin-bottom: 0;
        }
        
        /* Data Tables */
        .data-table-wrap {
            overflow-x: auto;
            overflow-y: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .data-table th {
            text-align: left;
            padding: 10px 12px;
            background: var(--bg3);
            color: var(--text2);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        
        .data-table tr:hover td {
            background: var(--bg-hover);
        }
        
        .data-table .col-time { width: 140px; color: var(--text3); font-size: 12px; white-space: nowrap; }
        .data-table .col-type { width: 90px; }
        .data-table .col-source { width: 80px; }
        .data-table .col-tier { width: 70px; text-align: center; }
        .data-table .col-status { width: 80px; text-align: center; }
        .data-table .col-action { width: 100px; text-align: right; }
        .data-table .col-title { min-width: 200px; }
        .data-table .col-issue { min-width: 150px; color: var(--text2); font-size: 12px; }
        
        .data-table .title-main { font-weight: 500; color: var(--text); }
        .data-table .title-ep { color: var(--text2); font-size: 12px; margin-top: 2px; }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .badge-success { background: rgba(34,197,94,0.15); color: #22c55e; }
        .badge-error { background: var(--error-bg); color: var(--error); }
        .badge-warn { background: var(--warn-bg); color: var(--warn); }
        .badge-info { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .badge-hot { background: var(--error-bg); color: var(--error); }
        .badge-warm { background: var(--warn-bg); color: var(--warn); }
        .badge-cool { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .badge-cold { background: var(--accent-glow); color: var(--accent); }
        .badge-sonarr { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .badge-radarr { background: rgba(249,115,22,0.15); color: #f97316; }
        .badge-missing { background: var(--error-bg); color: var(--error); }
        .badge-upgrade { background: rgba(139,92,246,0.15); color: #8b5cf6; }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg3);
            border-top: 1px solid var(--border);
            position: sticky;
            bottom: 0;
            flex-shrink: 0;
            min-height: 44px;
        }
        
        .page-info {
            font-size: 12px;
            color: var(--text2);
            min-width: 160px;
            text-align: center;
        }
        
        .pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        /* Auto-resolve countdown */
        .countdown {
            font-size: 11px;
            color: var(--text3);
            background: var(--bg);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }
        
        .countdown.soon {
            background: rgba(34,197,94,0.15);
            color: #22c55e;
        }
        
        /* Urgent intervention rows */
        .data-table tr.urgent-row td {
            background: rgba(239,68,68,0.05);
        }
        
        .data-table tr.urgent-row:hover td {
            background: rgba(239,68,68,0.1);
        }
        
        /* Storage */
        .storage-bar { margin-bottom: 18px; }
        .storage-head { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .storage-path { font-family: monospace; color: var(--text2); }
        
        .bar {
            height: 10px;
            background: var(--bg3);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .bar-fill {
            height: 100%;
            background: var(--success);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        .bar-fill.warn { background: var(--warn); }
        .bar-fill.crit { background: var(--error); }
        
        /* Modals */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: var(--bg2);
            border-radius: 16px;
            padding: 28px;
            max-width: 520px;
            width: 90%;
            border: 1px solid var(--border);
            box-shadow: var(--card-shadow);
        }
        
        .modal h3 {
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .modal-actions .btn { flex: 1; }
        
        /* Initialization Overlay */
        .init-overlay {
            position: fixed;
            inset: 0;
            background: rgba(12, 15, 26, 0.95);
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .init-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        .init-content {
            text-align: center;
            max-width: 400px;
            padding: 40px;
        }
        
        .init-logo {
            font-size: 64px;
            margin-bottom: 24px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .init-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        
        .init-status {
            color: var(--text2);
            font-size: 14px;
            margin-bottom: 24px;
        }
        
        .init-progress {
            width: 100%;
            height: 6px;
            background: var(--bg3);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 16px;
        }
        
        .init-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-hover));
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .init-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
            text-align: left;
            font-size: 13px;
            margin-top: 16px;
        }
        
        .init-step {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text3);
            transition: color 0.3s ease;
        }
        
        .init-step.active {
            color: var(--text);
        }
        
        .init-step.done {
            color: var(--success);
        }
        
        .init-step-icon {
            width: 20px;
            text-align: center;
        }
        
        .init-timer {
            margin-top: 20px;
            font-size: 14px;
            color: var(--text2);
            font-weight: 500;
        }
        
        /* Settings modal inputs */
        .settings-field {
            margin-bottom: 18px;
        }
        
        .settings-field label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .settings-field input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            transition: all var(--transition);
        }
        
        .settings-field input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        .settings-field .hint {
            font-size: 12px;
            color: var(--text3);
            margin-top: 6px;
        }
        
        /* Spinner */
        .spinner {
            width: 28px;
            height: 28px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 24px auto;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Full width panel */
        .full-width { grid-column: 1 / -1; }
        
        /* Toggle switch */
        .toggle {
            width: 48px;
            height: 26px;
            background: var(--border);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .toggle.on {
            background: var(--accent);
        }
        
        .toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle.on::after {
            transform: translateX(22px);
        }
        
        /* Version footer */
        .version-footer {
            text-align: center;
            padding: 16px;
            font-size: 11px;
            color: var(--text3);
            border-top: 1px solid var(--border);
            background: var(--bg2);
        }
        
        /* Activity Status Bar */
        .activity-bar {
            background: var(--bg3);
            border-bottom: 1px solid var(--border);
            padding: 8px 24px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--text2);
        }
        
        .activity-icon {
            font-size: 16px;
        }
        
        .activity-text {
            font-weight: 500;
            color: var(--text);
        }
        
        .activity-detail {
            color: var(--text3);
            font-size: 12px;
        }
        
        .activity-bar.searching {
            background: linear-gradient(90deg, var(--bg3), rgba(99, 102, 241, 0.1), var(--bg3));
            background-size: 200% 100%;
            animation: searching-pulse 2s ease-in-out infinite;
        }
        
        .activity-bar.finding {
            background: rgba(34, 197, 94, 0.1);
        }
        
        @keyframes searching-pulse {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
    </style>
</head>
<body>
    <!-- Initialization Overlay -->
    <div class="init-overlay" id="init-overlay">
        <div class="init-content">
            <div class="init-logo">üé¨</div>
            <div class="init-title">The Fantastic Machinarr</div>
            <div class="init-status" id="init-status">Starting up...</div>
            <div class="init-progress">
                <div class="init-progress-bar" id="init-progress"></div>
            </div>
            <div class="init-steps">
                <div class="init-step" id="init-step-config">
                    <span class="init-step-icon">‚è≥</span>
                    <span>Loading configuration...</span>
                </div>
                <div class="init-step" id="init-step-services">
                    <span class="init-step-icon">‚è≥</span>
                    <span>Connecting to services...</span>
                </div>
                <div class="init-step" id="init-step-data">
                    <span class="init-step-icon">‚è≥</span>
                    <span>Fetching library data...</span>
                </div>
                <div class="init-step" id="init-step-ui">
                    <span class="init-step-icon">‚è≥</span>
                    <span>Preparing dashboard...</span>
                </div>
            </div>
            <div class="init-timer" id="init-timer">60s</div>
        </div>
    </div>

    <header>
        <div class="logo"><span>üé¨</span> The Fantastic Machinarr</div>
        <div class="header-right">
            <div class="status-dots" id="status-dots"></div>
            <button class="theme-btn" onclick="toggleTheme()" title="Toggle theme">üåô</button>
            <button class="settings-btn" onclick="openSettingsModal()" title="Settings">‚öôÔ∏è</button>
        </div>
    </header>
    
    <!-- Compact Scoreboard -->
    <div class="scoreboard compact">
        <div class="score-card hot">
            <div class="score-val" id="finds-today">0</div>
            <div class="score-label">Finds Today</div>
            <div class="score-breakdown" id="finds-today-breakdown"></div>
        </div>
        <div class="score-card">
            <div class="score-val" id="finds-total">0</div>
            <div class="score-label">Total Finds</div>
            <div class="score-breakdown" id="finds-total-breakdown"></div>
        </div>
        <div class="score-card api">
            <div class="score-val"><span id="api-used">0</span><span style="color:var(--text3);font-size:16px"> / <span id="api-limit">500</span></span></div>
            <div class="score-label">API Calls</div>
        </div>
        <div class="score-card status" id="status-card">
            <div class="score-val" id="status-indicator">‚è≥</div>
            <div class="score-label" id="status-text">Initializing...</div>
        </div>
    </div>
    
    <!-- Real-time Activity Status Bar -->
    <div class="activity-bar" id="activity-bar">
        <span class="activity-icon" id="activity-icon">üí§</span>
        <span class="activity-text" id="activity-text">Idle</span>
        <span class="activity-detail" id="activity-detail"></span>
    </div>
    
    <main>
        <!-- Row 1: Missing Content by Tier -->
        <div class="panel">
            <div class="panel-head" style="padding: 10px 16px;">
                <span class="panel-title">üéØ Missing Content by Tier</span>
                <span id="tier-total-label" style="color:var(--text2);font-size:12px">Loading...</span>
            </div>
            <div class="panel-body" style="padding: 12px 16px;">
                <div class="tiers tiers-horizontal">
                    <div class="tier">
                        <div class="tier-emoji">üî•</div>
                        <div class="tier-info">
                            <div class="tier-count" id="tier-hot">-</div>
                            <div class="tier-labels">
                                <div class="tier-name">Hot</div>
                                <div class="tier-desc">0-90 days</div>
                                <div class="tier-breakdown"><span>üì∫</span><span id="tier-hot-sonarr">-</span> <span>üé¨</span><span id="tier-hot-radarr">-</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="tier">
                        <div class="tier-emoji">‚òÄÔ∏è</div>
                        <div class="tier-info">
                            <div class="tier-count" id="tier-warm">-</div>
                            <div class="tier-labels">
                                <div class="tier-name">Warm</div>
                                <div class="tier-desc">90-365 days</div>
                                <div class="tier-breakdown"><span>üì∫</span><span id="tier-warm-sonarr">-</span> <span>üé¨</span><span id="tier-warm-radarr">-</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="tier">
                        <div class="tier-emoji">‚ùÑÔ∏è</div>
                        <div class="tier-info">
                            <div class="tier-count" id="tier-cool">-</div>
                            <div class="tier-labels">
                                <div class="tier-name">Cool</div>
                                <div class="tier-desc">1-3 years</div>
                                <div class="tier-breakdown"><span>üì∫</span><span id="tier-cool-sonarr">-</span> <span>üé¨</span><span id="tier-cool-radarr">-</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="tier">
                        <div class="tier-emoji">üßä</div>
                        <div class="tier-info">
                            <div class="tier-count" id="tier-cold">-</div>
                            <div class="tier-labels">
                                <div class="tier-name">Cold</div>
                                <div class="tier-desc">3+ years</div>
                                <div class="tier-breakdown"><span>üì∫</span><span id="tier-cold-sonarr">-</span> <span>üé¨</span><span id="tier-cold-radarr">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Row 2: Search Activity (full width table with filters) -->
        <div class="panel">
            <div class="panel-head">
                <div style="display:flex;align-items:center;gap:12px">
                    <span class="panel-title">üîÑ Search Activity</span>
                    <button class="btn btn-sm btn-pri" onclick="runSearch()">Search Now</button>
                </div>
                <div style="display:flex;gap:12px;align-items:center">
                    <input type="text" id="search-filter-text" placeholder="Search by title..." style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:12px;width:150px" onkeyup="filterSearchActivity()">
                    <select id="search-filter-tier" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:12px" onchange="filterSearchActivity()">
                        <option value="">All Tiers</option>
                        <option value="hot">üî• Hot</option>
                        <option value="warm">‚òÄÔ∏è Warm</option>
                        <option value="cool">‚ùÑÔ∏è Cool</option>
                        <option value="cold">üßä Cold</option>
                    </select>
                    <select id="search-filter-source" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:12px" onchange="filterSearchActivity()">
                        <option value="">All Sources</option>
                        <option value="sonarr">üì∫ Sonarr</option>
                        <option value="radarr">üé¨ Radarr</option>
                    </select>
                </div>
            </div>
            <div class="panel-body flush">
                <div class="data-table-wrap" id="search-list" style="max-height:280px">
                    <div class="empty"><div class="empty-icon">‚è≥</div><p>No search activity yet</p></div>
                </div>
            </div>
        </div>
        
        <!-- Row 3: Recent Finds (full width table) -->
        <div class="panel">
            <div class="panel-head">
                <span class="panel-title">üéâ Recent Finds</span>
                <span id="finds-count" style="color:var(--text2);font-size:13px">0 items</span>
            </div>
            <div class="panel-body flush">
                <div class="data-table-wrap" id="finds-list" style="max-height:220px">
                    <div class="empty"><div class="empty-icon">üîç</div><p>No finds yet - TFM is working on it!</p></div>
                </div>
            </div>
        </div>
        
        <!-- Row 4: Queue Issues (full width table) -->
        <div class="panel">
            <div class="panel-head">
                <span class="panel-title">‚ö†Ô∏è Queue Issues</span>
                <span id="stuck-count" style="color:var(--text2);font-size:13px">0 items</span>
            </div>
            <div class="panel-body flush">
                <div class="data-table-wrap" id="stuck-list" style="max-height:250px">
                    <div class="empty"><div class="empty-icon">‚úÖ</div><p>No stuck items</p></div>
                </div>
            </div>
        </div>
        
        <!-- Row 5: Manual Intervention (full width table) -->
        <div class="panel">
            <div class="panel-head">
                <span class="panel-title">üñêÔ∏è Manual Intervention</span>
                <span id="intervention-count" style="color:var(--text2);font-size:13px">0 items</span>
            </div>
            <div class="panel-body flush">
                <div class="data-table-wrap" id="intervention-list" style="max-height:250px">
                    <div class="empty"><div class="empty-icon">üëç</div><p>No intervention needed</p></div>
                </div>
            </div>
        </div>
        
        <!-- Row 6: Debug Logs -->
        <div class="panel full-width">
            <div class="panel-head">
                <span class="panel-title">üìã Debug Logs</span>
                <select id="log-filter" onchange="loadLogs()" style="background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:5px 10px;border-radius:4px">
                    <option value="">All</option>
                    <option value="ERROR">Errors</option>
                    <option value="WARNING">Warnings</option>
                    <option value="INFO">Info</option>
                    <option value="DEBUG">Debug</option>
                </select>
            </div>
            <div class="panel-body flush" id="log-list" style="max-height:300px">
                <div class="spinner"></div>
            </div>
        </div>
    </main>
    
    <!-- Intervention Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h3 id="modal-title">Manual Intervention</h3>
            <p id="modal-desc"></p>
            <div id="modal-details"></div>
            <div class="modal-actions" id="modal-actions"></div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content" style="max-width: 680px; max-height: 85vh; overflow-y: auto;">
            <h3>‚öôÔ∏è Settings</h3>
            
            <div class="settings-field">
                <label>üé® Theme</label>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-sec" id="theme-dark-btn" onclick="setTheme('dark')" style="flex:1;">üåô Dark</button>
                    <button class="btn btn-sec" id="theme-light-btn" onclick="setTheme('light')" style="flex:1;">‚òÄÔ∏è Light</button>
                </div>
            </div>
            
            <div class="settings-field">
                <label>üìä Daily API Limit</label>
                <input type="number" id="settings-api-limit" value="500" min="50" max="50000" onchange="updateSettingsPacingPresets()">
                <div class="hint">TFM spreads searches throughout the day to stay within this limit.</div>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label style="font-size: 13px; font-weight: 600; display: block; margin-bottom: 8px;">‚ö° Pacing Presets</label>
                <div id="settings-pacing-presets" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="settings-field" style="margin-bottom: 0;">
                    <label>üîç Searches Per Cycle</label>
                    <input type="number" id="settings-per-cycle" value="10" min="1" max="5000">
                </div>
                <div class="settings-field" style="margin-bottom: 0;">
                    <label>‚è±Ô∏è Cycle Interval (min)</label>
                    <input type="number" id="settings-interval" value="60" min="5" max="360">
                </div>
            </div>
            
            <h4 style="margin: 24px 0 12px; font-size: 14px;">üéØ Search Tier Configuration</h4>
            <div class="hint" style="margin-bottom: 12px;">Define age ranges (in days) and search frequency for each tier.</div>
            
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                <div style="background: var(--bg3); padding: 12px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px;">üî•</div>
                    <div style="font-weight: 600; margin: 4px 0;">Hot</div>
                    <div style="display: flex; gap: 4px; margin: 8px 0;">
                        <input type="number" id="settings-hot-min" value="0" min="0" style="width: 50%; padding: 6px; font-size: 11px;" disabled>
                        <input type="number" id="settings-hot-max" value="90" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                    </div>
                    <div style="font-size: 10px; color: var(--text3);">days old</div>
                    <select id="settings-hot-interval" style="width: 100%; padding: 6px; margin-top: 8px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                        <option value="30">30 min</option>
                        <option value="60" selected>1 hour</option>
                        <option value="120">2 hours</option>
                        <option value="180">3 hours</option>
                        <option value="360">6 hours</option>
                    </select>
                </div>
                <div style="background: var(--bg3); padding: 12px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px;">‚òÄÔ∏è</div>
                    <div style="font-weight: 600; margin: 4px 0;">Warm</div>
                    <div style="display: flex; gap: 4px; margin: 8px 0;">
                        <input type="number" id="settings-warm-min" value="90" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                        <input type="number" id="settings-warm-max" value="365" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                    </div>
                    <div style="font-size: 10px; color: var(--text3);">days old</div>
                    <select id="settings-warm-interval" style="width: 100%; padding: 6px; margin-top: 8px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                        <option value="180">3 hours</option>
                        <option value="360" selected>6 hours</option>
                        <option value="720">12 hours</option>
                        <option value="1440">Daily</option>
                    </select>
                </div>
                <div style="background: var(--bg3); padding: 12px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px;">‚ùÑÔ∏è</div>
                    <div style="font-weight: 600; margin: 4px 0;">Cool</div>
                    <div style="display: flex; gap: 4px; margin: 8px 0;">
                        <input type="number" id="settings-cool-min" value="365" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                        <input type="number" id="settings-cool-max" value="1095" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                    </div>
                    <div style="font-size: 10px; color: var(--text3);">days old</div>
                    <select id="settings-cool-interval" style="width: 100%; padding: 6px; margin-top: 8px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                        <option value="720">12 hours</option>
                        <option value="1440" selected>Daily</option>
                        <option value="2880">2 days</option>
                        <option value="4320">3 days</option>
                    </select>
                </div>
                <div style="background: var(--bg3); padding: 12px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px;">üßä</div>
                    <div style="font-weight: 600; margin: 4px 0;">Cold</div>
                    <div style="display: flex; gap: 4px; margin: 8px 0;">
                        <input type="number" id="settings-cold-min" value="1095" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                        <input type="text" value="‚àû" style="width: 50%; padding: 6px; font-size: 11px; text-align: center;" disabled>
                    </div>
                    <div style="font-size: 10px; color: var(--text3);">days old</div>
                    <select id="settings-cold-interval" style="width: 100%; padding: 6px; margin-top: 8px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                        <option value="4320">3 days</option>
                        <option value="10080" selected>Weekly</option>
                        <option value="20160">2 weeks</option>
                        <option value="43200">Monthly</option>
                    </select>
                </div>
            </div>
            
            <h4 style="margin: 24px 0 12px; font-size: 14px;">üò¥ Quiet Hours</h4>
            <div style="background: var(--bg3); padding: 14px; border-radius: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div>
                        <div style="font-weight: 500;">Pause searching during certain hours</div>
                        <div class="hint" style="margin-top: 4px;">TFM will stop searching between these hours (server time)</div>
                    </div>
                    <div class="toggle" id="settings-quiet-toggle" onclick="this.classList.toggle('on')" style="width: 48px; height: 26px; background: var(--border); border-radius: 13px; position: relative; cursor: pointer;"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label style="font-size: 12px; display: block; margin-bottom: 4px;">Start</label>
                        <select id="settings-quiet-start" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                            <option value="0">00:00</option><option value="1">01:00</option><option value="2" selected>02:00</option><option value="3">03:00</option><option value="4">04:00</option><option value="5">05:00</option><option value="6">06:00</option><option value="7">07:00</option><option value="8">08:00</option><option value="9">09:00</option><option value="10">10:00</option><option value="11">11:00</option><option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option><option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option><option value="20">20:00</option><option value="21">21:00</option><option value="22">22:00</option><option value="23">23:00</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; display: block; margin-bottom: 4px;">End</label>
                        <select id="settings-quiet-end" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                            <option value="0">00:00</option><option value="1">01:00</option><option value="2">02:00</option><option value="3">03:00</option><option value="4">04:00</option><option value="5">05:00</option><option value="6">06:00</option><option value="7" selected>07:00</option><option value="8">08:00</option><option value="9">09:00</option><option value="10">10:00</option><option value="11">11:00</option><option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option><option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option><option value="20">20:00</option><option value="21">21:00</option><option value="22">22:00</option><option value="23">23:00</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions" style="margin-top: 24px;">
                <button class="btn btn-sec" onclick="closeSettingsModal()">Cancel</button>
                <button class="btn btn-pri" onclick="saveSettings()">Save Settings</button>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); text-align: center;">
                <a href="/setup" style="color: var(--text2); font-size: 13px; text-decoration: none;">Run Setup Wizard Again ‚Üí</a>
            </div>
        </div>
    </div>
    
    <script>
        // Theme management
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            setTheme(current === 'dark' ? 'light' : 'dark');
        }
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('tfm-theme', theme);
            document.querySelector('.theme-btn').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            updateThemeButtons();
        }
        
        function updateThemeButtons() {
            const theme = document.documentElement.getAttribute('data-theme');
            const darkBtn = document.getElementById('theme-dark-btn');
            const lightBtn = document.getElementById('theme-light-btn');
            if (darkBtn && lightBtn) {
                darkBtn.style.background = theme === 'dark' ? 'var(--accent)' : '';
                darkBtn.style.color = theme === 'dark' ? '#fff' : '';
                lightBtn.style.background = theme === 'light' ? 'var(--accent)' : '';
                lightBtn.style.color = theme === 'light' ? '#fff' : '';
            }
        }
        
        // Load saved theme
        const savedTheme = localStorage.getItem('tfm-theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.querySelector('.theme-btn').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        
        // Pagination state - store up to 500 items, show 10 per page
        const PAGE_SIZE = 10;
        const MAX_ITEMS = 500;
        const paginationState = {
            searches: { items: [], page: 0 },
            finds: { items: [], page: 0 },
            queue: { items: [], page: 0 },
            interventions: { items: [], page: 0 }
        };
        
        function renderPagination(containerId, state, renderFn) {
            const totalPages = Math.ceil(state.items.length / PAGE_SIZE);
            const start = state.page * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pageItems = state.items.slice(start, end);
            
            const paginationHtml = totalPages > 1 ? `
                <div class="pagination">
                    <button class="btn btn-sm btn-sec" onclick="pageNav('${containerId}', -1)" ${state.page === 0 ? 'disabled' : ''}>‚Üê Prev</button>
                    <span class="page-info">Page ${state.page + 1} of ${totalPages} (${state.items.length} total)</span>
                    <button class="btn btn-sm btn-sec" onclick="pageNav('${containerId}', 1)" ${state.page >= totalPages - 1 ? 'disabled' : ''}>Next ‚Üí</button>
                </div>
            ` : '';
            
            return { pageItems, paginationHtml };
        }
        
        function pageNav(containerId, direction) {
            const stateKey = containerId.replace('-list', '').replace('stuck', 'queue').replace('intervention', 'interventions');
            const state = paginationState[stateKey];
            if (!state) return;
            
            const totalPages = Math.ceil(state.items.length / PAGE_SIZE);
            state.page = Math.max(0, Math.min(totalPages - 1, state.page + direction));
            
            // Re-render the appropriate list
            if (stateKey === 'searches') renderSearchesPage();
            else if (stateKey === 'finds') renderFindsPage();
            else if (stateKey === 'queue') renderQueuePage();
            else if (stateKey === 'interventions') renderInterventionsPage();
        }
    
        async function api(endpoint, method = 'GET', data = null) {
            const opts = { method, headers: {'Content-Type': 'application/json'} };
            if (data) opts.body = JSON.stringify(data);
            const r = await fetch('/api/' + endpoint, opts);
            return r.json();
        }
        
        function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        function fmt(iso) { try { return new Date(iso).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); } catch { return ''; } }
        
        async function loadStatus() {
            const data = await api('status');
            const dots = document.getElementById('status-dots');
            let html = '';
            for (const [key, svc] of Object.entries(data.services || {})) {
                html += `<div class="dot"><span class="dot-ind ${svc.connected ? 'on' : 'off'}"></span>${svc.name}</div>`;
            }
            dots.innerHTML = html;
        }
        
        async function loadDashboard() {
            const data = await api('dashboard');
            if (data.scoreboard) {
                document.getElementById('finds-today').textContent = data.scoreboard.finds_today;
                document.getElementById('finds-total').textContent = data.scoreboard.finds_total;
                document.getElementById('api-used').textContent = data.scoreboard.api_hits_today;
                document.getElementById('api-limit').textContent = data.scoreboard.api_limit;
                
                // Finds breakdown for both cards
                if (data.scoreboard.finds_by_source) {
                    const sonarr = data.scoreboard.finds_by_source.sonarr || 0;
                    const radarr = data.scoreboard.finds_by_source.radarr || 0;
                    const breakdownText = `üì∫ ${sonarr} ‚Ä¢ üé¨ ${radarr}`;
                    
                    const todayBreakdown = document.getElementById('finds-today-breakdown');
                    const totalBreakdown = document.getElementById('finds-total-breakdown');
                    if (todayBreakdown) todayBreakdown.textContent = breakdownText;
                    if (totalBreakdown) totalBreakdown.textContent = breakdownText;
                }
                
                // Update status indicator
                updateStatusIndicator(data.scoreboard, data.scheduler);
            }
            if (data.tiers) {
                // Update tier totals
                const tiers = data.tiers;
                document.getElementById('tier-hot').textContent = (tiers.hot?.total ?? 0).toLocaleString();
                document.getElementById('tier-warm').textContent = (tiers.warm?.total ?? 0).toLocaleString();
                document.getElementById('tier-cool').textContent = (tiers.cool?.total ?? 0).toLocaleString();
                document.getElementById('tier-cold').textContent = (tiers.cold?.total ?? 0).toLocaleString();
                
                // Update per-tier Sonarr/Radarr breakdowns
                document.getElementById('tier-hot-sonarr').textContent = (tiers.hot?.sonarr ?? 0).toLocaleString();
                document.getElementById('tier-hot-radarr').textContent = (tiers.hot?.radarr ?? 0).toLocaleString();
                document.getElementById('tier-warm-sonarr').textContent = (tiers.warm?.sonarr ?? 0).toLocaleString();
                document.getElementById('tier-warm-radarr').textContent = (tiers.warm?.radarr ?? 0).toLocaleString();
                document.getElementById('tier-cool-sonarr').textContent = (tiers.cool?.sonarr ?? 0).toLocaleString();
                document.getElementById('tier-cool-radarr').textContent = (tiers.cool?.radarr ?? 0).toLocaleString();
                document.getElementById('tier-cold-sonarr').textContent = (tiers.cold?.sonarr ?? 0).toLocaleString();
                document.getElementById('tier-cold-radarr').textContent = (tiers.cold?.radarr ?? 0).toLocaleString();
                
                // Calculate total for header label
                const total = (tiers.hot?.total ?? 0) + (tiers.warm?.total ?? 0) + 
                             (tiers.cool?.total ?? 0) + (tiers.cold?.total ?? 0);
                const totalSonarr = (tiers.hot?.sonarr ?? 0) + (tiers.warm?.sonarr ?? 0) + 
                                   (tiers.cool?.sonarr ?? 0) + (tiers.cold?.sonarr ?? 0);
                const totalRadarr = (tiers.hot?.radarr ?? 0) + (tiers.warm?.radarr ?? 0) + 
                                   (tiers.cool?.radarr ?? 0) + (tiers.cold?.radarr ?? 0);
                
                const tierLabel = document.getElementById('tier-total-label');
                if (tierLabel) {
                    tierLabel.textContent = `${total.toLocaleString()} total (üì∫ ${totalSonarr.toLocaleString()} ‚Ä¢ üé¨ ${totalRadarr.toLocaleString()})`;
                }
            }
        }
        
        function updateStatusIndicator(scoreboard, scheduler) {
            const card = document.getElementById('status-card');
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            
            const apiUsed = scoreboard.api_hits_today || 0;
            const apiLimit = scoreboard.api_limit || 500;
            const apiRemaining = apiLimit - apiUsed;
            
            // Check if API exhausted
            if (apiRemaining <= 0) {
                card.className = 'score-card status exhausted';
                indicator.textContent = 'üí§';
                // Calculate time until midnight reset
                const now = new Date();
                const midnight = new Date(now);
                midnight.setHours(24, 0, 0, 0);
                const hoursUntilReset = Math.ceil((midnight - now) / (1000 * 60 * 60));
                text.textContent = `Resets in ${hoursUntilReset}h`;
                updateActivityBar('sleeping', 'API limit reached', `Resets at midnight (${hoursUntilReset}h)`);
                return;
            }
            
            // Check scheduler for next run
            if (scheduler && scheduler.tasks) {
                const searchTask = scheduler.tasks.find(t => t.name === 'search_cycle');
                if (searchTask && searchTask.next_run) {
                    // next_run is in UTC - append Z if not present
                    let nextRunStr = searchTask.next_run;
                    if (!nextRunStr.endsWith('Z') && !nextRunStr.includes('+')) {
                        nextRunStr += 'Z';
                    }
                    const nextRun = new Date(nextRunStr);
                    const now = new Date();
                    const minsUntil = Math.max(0, Math.round((nextRun - now) / 60000));
                    
                    if (minsUntil <= 1) {
                        card.className = 'score-card status active';
                        indicator.textContent = 'üîç';
                        text.textContent = 'Searching...';
                        updateActivityBar('searching', 'Running search cycle', 'Checking for missing content and upgrades...');
                    } else {
                        card.className = 'score-card status';
                        indicator.textContent = '‚è±Ô∏è';
                        text.textContent = `Next: ${minsUntil}m`;
                        updateActivityBar('idle', 'Waiting for next cycle', `Next search in ${minsUntil} minutes`);
                    }
                    return;
                }
            }
            
            // Default - active
            card.className = 'score-card status active';
            indicator.textContent = '‚úÖ';
            text.textContent = 'Active';
            updateActivityBar('idle', 'Ready', 'Scheduler active');
        }
        
        function updateActivityBar(state, mainText, detail) {
            const bar = document.getElementById('activity-bar');
            const icon = document.getElementById('activity-icon');
            const text = document.getElementById('activity-text');
            const detailEl = document.getElementById('activity-detail');
            
            bar.className = 'activity-bar';
            
            switch(state) {
                case 'searching':
                    bar.classList.add('searching');
                    icon.textContent = 'üîç';
                    break;
                case 'finding':
                    bar.classList.add('finding');
                    icon.textContent = 'üéâ';
                    break;
                case 'sleeping':
                    icon.textContent = 'üí§';
                    break;
                case 'checking':
                    icon.textContent = 'üì°';
                    break;
                case 'idle':
                default:
                    icon.textContent = '‚è≥';
                    break;
            }
            
            text.textContent = mainText || 'Idle';
            detailEl.textContent = detail || '';
        }
        
        async function loadQueue() {
            const data = await api('queue');
            const el = document.getElementById('stuck-list');
            document.getElementById('stuck-count').textContent = `${data.total_stuck || 0} items`;
            
            if (!data.stuck_items?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">‚úÖ</div><p>No stuck items</p></div>';
                paginationState.queue.items = [];
                return;
            }
            
            paginationState.queue.items = data.stuck_items.slice(0, MAX_ITEMS);
            paginationState.queue.page = 0;
            renderQueuePage();
        }
        
        function renderQueuePage() {
            const el = document.getElementById('stuck-list');
            const state = paginationState.queue;
            const { pageItems, paginationHtml } = renderPagination('stuck-list', state, null);
            
            if (!pageItems.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">‚úÖ</div><p>No stuck items</p></div>';
                return;
            }
            
            el.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="col-time">Stuck</th>
                            <th class="col-source">Source</th>
                            <th class="col-title">Title</th>
                            <th class="col-issue">Issue</th>
                            <th class="col-action">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pageItems.map(item => {
                            const autoResolveHtml = item.can_auto_resolve 
                                ? (item.auto_resolve_in_minutes !== null && item.auto_resolve_in_minutes > 0
                                    ? `<span class="countdown ${item.auto_resolve_in_minutes <= 5 ? 'soon' : ''}">‚è±Ô∏è ${item.auto_resolve_in_minutes}m</span>`
                                    : '<span class="countdown soon">‚è±Ô∏è Now!</span>')
                                : '';
                            
                            // Show issues, or fall back to tracked_status/status
                            let issueText = item.issues && item.issues.length > 0 
                                ? item.issues.join(', ').replace(/_/g, ' ')
                                : item.tracked_status || item.status || 'downloading';
                            
                            return `
                            <tr>
                                <td class="col-time">${item.stuck_minutes}m</td>
                                <td class="col-source"><span class="badge badge-${item.source}">${item.source}</span></td>
                                <td class="col-title">
                                    <div class="title-main">${esc(item.title)}</div>
                                </td>
                                <td class="col-issue">
                                    <span class="badge badge-warn">${esc(issueText)}</span>
                                    ${item.can_auto_resolve ? '<span class="badge badge-success" style="margin-left:4px">Auto</span>' : ''}
                                    ${autoResolveHtml}
                                </td>
                                <td class="col-action">
                                    <button class="btn btn-sm btn-sec" onclick="resolveItem('${item.source}',${item.queue_id})">Resolve</button>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
                ${paginationHtml}
            `;
        }
        
        async function loadInterventions() {
            const data = await api('interventions');
            const el = document.getElementById('intervention-list');
            
            // Show breakdown of urgent vs long-missing
            const urgentCount = data.urgent_count || 0;
            const longMissingCount = data.long_missing_count || 0;
            let countText = `${data.count || 0} items`;
            if (urgentCount > 0 && longMissingCount > 0) {
                countText = `${urgentCount} urgent, ${longMissingCount} long-missing`;
            } else if (urgentCount > 0) {
                countText = `${urgentCount} urgent`;
            } else if (longMissingCount > 0) {
                countText = `${longMissingCount} long-missing`;
            }
            document.getElementById('intervention-count').textContent = countText;
            
            if (!data.items?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üëç</div><p>No intervention needed</p></div>';
                paginationState.interventions.items = [];
                return;
            }
            
            paginationState.interventions.items = data.items.slice(0, MAX_ITEMS);
            paginationState.interventions.page = 0;
            renderInterventionsPage();
        }
        
        function renderInterventionsPage() {
            const el = document.getElementById('intervention-list');
            const state = paginationState.interventions;
            const { pageItems, paginationHtml } = renderPagination('intervention-list', state, null);
            
            if (!pageItems.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üëç</div><p>No intervention needed</p></div>';
                return;
            }
            
            el.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="col-type">Type</th>
                            <th class="col-source">Source</th>
                            <th class="col-title">Title</th>
                            <th class="col-issue">Why Intervention Needed</th>
                            <th class="col-action">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pageItems.map(item => {
                            const isUrgent = item.urgency === 'high';
                            const isLongMissing = item.intervention_type === 'long_missing';
                            const typeIcon = isLongMissing ? 'üìÖ' : (isUrgent ? 'üö®' : '‚ö†Ô∏è');
                            const typeBadge = isLongMissing ? 'badge-info' : 'badge-error';
                            const typeLabel = isLongMissing 
                                ? `${item.details?.months_missing || '?'}+ months` 
                                : 'Search Failed';
                            const tierInfo = item.details?.tier_emoji ? `${item.details.tier_emoji} ${item.details.tier}` : '';
                            
                            return `
                            <tr class="${isUrgent ? 'urgent-row' : ''}">
                                <td class="col-type">
                                    <span class="badge ${typeBadge}">${typeIcon} ${typeLabel}</span>
                                </td>
                                <td class="col-source"><span class="badge badge-${item.source}">${item.source}</span></td>
                                <td class="col-title">
                                    <div class="title-main">${esc(item.title)}</div>
                                    ${tierInfo ? '<div style="font-size:11px;color:var(--text3);margin-top:2px">' + tierInfo + '</div>' : ''}
                                </td>
                                <td class="col-issue">
                                    <div style="font-size:12px;color:var(--text2)">${esc(item.reason)}</div>
                                    ${item.details?.search_count ? '<div style="font-size:11px;color:var(--text3);margin-top:2px">Searched ' + item.details.search_count + ' times</div>' : ''}
                                </td>
                                <td class="col-action">
                                    <button class="btn btn-sm ${isUrgent ? 'btn-pri' : 'btn-sec'}" onclick="showIntervention(${JSON.stringify(item).replace(/"/g, '&quot;')})">Actions</button>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
                ${paginationHtml}
            `;
        }
        
        async function loadStorage() {
            const data = await api('storage');
            const el = document.getElementById('storage-list');
            
            if (!data.paths?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üíæ</div><p>No storage info available</p></div>';
                return;
            }
            
            // Group by unique free space value (same filesystem)
            const uniqueFS = {};
            data.paths.forEach(p => {
                const key = p.free_gb;
                if (!uniqueFS[key]) {
                    uniqueFS[key] = {
                        free_gb: p.free_gb,
                        paths: [],
                        tvPaths: 0,
                        moviePaths: 0
                    };
                }
                uniqueFS[key].paths.push(p.path);
                
                const pathLower = p.path.toLowerCase();
                if (pathLower.includes('/tv') || pathLower.includes('/series')) {
                    uniqueFS[key].tvPaths++;
                } else if (pathLower.includes('/movie')) {
                    uniqueFS[key].moviePaths++;
                }
            });
            
            const filesystems = Object.values(uniqueFS);
            
            // Display each unique filesystem
            el.innerHTML = filesystems.map(fs => {
                const freeGB = fs.free_gb;
                const freeTB = (freeGB / 1000).toFixed(1);
                const displayFree = freeGB >= 1000 ? `${freeTB} TB` : `${freeGB} GB`;
                
                // Determine what type of media
                let mediaType = '';
                if (fs.tvPaths > 0 && fs.moviePaths > 0) {
                    mediaType = 'üì∫ TV & üé¨ Movies';
                } else if (fs.tvPaths > 0) {
                    mediaType = 'üì∫ TV Shows';
                } else if (fs.moviePaths > 0) {
                    mediaType = 'üé¨ Movies';
                } else {
                    mediaType = 'üíæ Media';
                }
                
                // Status indicator
                const status = freeGB < 100 ? 'üî¥' : freeGB < 500 ? 'üü°' : 'üü¢';
                
                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border);">
                        <div>
                            <div style="font-weight: 500;">${status} ${mediaType}</div>
                            <div style="font-size: 11px; color: var(--text3); margin-top: 2px;">${fs.paths.length} folder(s)</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: 600;">${displayFree}</div>
                            <div style="font-size: 11px; color: var(--text3);">available</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function loadFinds() {
            const data = await api('finds?limit=500');
            const el = document.getElementById('finds-list');
            document.getElementById('finds-count').textContent = `${data.finds?.length || 0} items`;
            
            if (!data.finds?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><p>No finds yet - TFM is working on it!</p></div>';
                return;
            }
            
            // Store items (newest first)
            paginationState.finds.items = data.finds.reverse().slice(0, MAX_ITEMS);
            paginationState.finds.page = 0;
            renderFindsPage();
        }
        
        function renderFindsPage() {
            const el = document.getElementById('finds-list');
            const state = paginationState.finds;
            const { pageItems, paginationHtml } = renderPagination('finds-list', state, null);
            
            const typeLabels = {
                'auto': 'ü§ñ Auto',
                'manual': 'üñêÔ∏è Manual',
                'rss': 'üì° RSS',
                'search': 'üîé Search'
            };
            
            if (!pageItems.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><p>No finds yet</p></div>';
                return;
            }
            
            el.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="col-time">Time</th>
                            <th class="col-type">How Found</th>
                            <th class="col-source">Source</th>
                            <th class="col-title">Title</th>
                            <th class="col-issue">Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pageItems.map(f => `
                            <tr>
                                <td class="col-time">${fmt(f.timestamp)}</td>
                                <td class="col-type">${typeLabels[f.resolution_type] || '‚úÖ ' + f.resolution_type}</td>
                                <td class="col-source"><span class="badge badge-${f.source}">${f.source}</span></td>
                                <td class="col-title">
                                    <div class="title-main">${esc(f.title)}</div>
                                </td>
                                <td class="col-issue">${f.resolution_detail ? esc(f.resolution_detail) : '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${paginationHtml}
            `;
        }
        
        async function loadSearches() {
            const data = await api('searches?limit=500');
            const el = document.getElementById('search-list');
            
            if (!data.searches?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">‚è≥</div><p>No search activity yet</p></div>';
                return;
            }
            
            // Store items (newest first) and reset to page 0 on fresh load
            paginationState.searches.items = data.searches.reverse().slice(0, MAX_ITEMS);
            paginationState.searches.page = 0;
            renderSearchesPage();
        }
        
        function filterSearchActivity() {
            const textFilter = document.getElementById('search-filter-text').value.toLowerCase();
            const tierFilter = document.getElementById('search-filter-tier').value;
            const sourceFilter = document.getElementById('search-filter-source').value;
            
            // Re-filter from original items
            paginationState.searches.page = 0;
            renderSearchesPage(textFilter, tierFilter, sourceFilter);
        }
        
        function getLifecycleDisplay(s) {
            const state = s.lifecycle_state || 'searched';
            const stateMap = {
                'searching': { label: 'üîÑ Searching', class: 'searching' },
                'searched': { label: 'üîç Searched', class: 'cooldown' },
                'cooldown': { label: `‚è≥ Cooldown ${s.cooldown_minutes ? Math.round(s.cooldown_minutes/60) + 'h' : ''}`, class: 'cooldown' },
                'escalating': { label: `‚ö†Ô∏è Escalating (${s.attempt_number}/${s.max_attempts})`, class: 'escalating' },
                'needs_attention': { label: 'üñêÔ∏è Needs Attention', class: 'needs_attention' },
                'found': { label: '‚úÖ Found!', class: 'found' },
                'error': { label: '‚ùå Error', class: 'error' },
            };
            const display = stateMap[state] || stateMap['searched'];
            return `<span class="lifecycle-state ${display.class}">${display.label}</span>`;
        }
        
        function renderSearchesPage(textFilter = '', tierFilter = '', sourceFilter = '') {
            const el = document.getElementById('search-list');
            let items = paginationState.searches.items;
            
            // Apply filters
            if (textFilter || tierFilter || sourceFilter) {
                items = items.filter(s => {
                    if (textFilter && !s.title.toLowerCase().includes(textFilter)) return false;
                    if (tierFilter && s.tier !== tierFilter) return false;
                    if (sourceFilter && s.source !== sourceFilter) return false;
                    return true;
                });
            }
            
            const state = { ...paginationState.searches, items };
            const { pageItems, paginationHtml } = renderPagination('search-list', state, null);
            
            if (!pageItems.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><p>No matching search activity</p></div>';
                return;
            }
            
            el.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="col-time" style="cursor:pointer" onclick="sortSearches('timestamp')">Time</th>
                            <th class="col-source">Source</th>
                            <th class="col-title" style="cursor:pointer" onclick="sortSearches('title')">Title</th>
                            <th class="col-episode">Episode</th>
                            <th class="col-tier" style="cursor:pointer" onclick="sortSearches('tier')">Tier</th>
                            <th class="col-status">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pageItems.map(s => {
                            const episodeCode = s.formatted_code || '-';
                            const yearMatch = s.title.match(/\((\d{4})\)/);
                            const year = yearMatch ? yearMatch[1] : '';
                            return `
                            <tr>
                                <td class="col-time">${fmt(s.timestamp)}</td>
                                <td class="col-source"><span class="badge badge-${s.source}">${s.source === 'sonarr' ? 'üì∫' : 'üé¨'} ${s.source}</span></td>
                                <td class="col-title">
                                    <div class="title-main">${esc(s.title)}</div>
                                    ${year ? `<div class="title-year" style="font-size:11px;color:var(--text3)">${year}</div>` : ''}
                                </td>
                                <td class="col-episode" style="font-family:monospace;font-size:12px">${episodeCode}</td>
                                <td class="col-tier"><span class="badge badge-${s.tier}">${s.tier_emoji} ${s.tier}</span></td>
                                <td class="col-status">${getLifecycleDisplay(s)}</td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
                ${paginationHtml}
            `;
        }
        
        let searchSortField = 'timestamp';
        let searchSortAsc = false;
        
        function sortSearches(field) {
            if (searchSortField === field) {
                searchSortAsc = !searchSortAsc;
            } else {
                searchSortField = field;
                searchSortAsc = true;
            }
            
            paginationState.searches.items.sort((a, b) => {
                let va = a[field] || '';
                let vb = b[field] || '';
                if (field === 'timestamp') {
                    va = new Date(va);
                    vb = new Date(vb);
                }
                if (va < vb) return searchSortAsc ? -1 : 1;
                if (va > vb) return searchSortAsc ? 1 : -1;
                return 0;
            });
            
            paginationState.searches.page = 0;
            filterSearchActivity();
        }
        
        async function loadLogs() {
            const level = document.getElementById('log-filter').value;
            const data = await api('logs?limit=100' + (level ? '&level=' + level : ''));
            const el = document.getElementById('log-list');
            
            if (!data.logs?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üìã</div><p>No logs</p></div>';
                return;
            }
            
            el.innerHTML = data.logs.reverse().map(l => `
                <div class="log">
                    <span class="log-time">${fmt(l.timestamp)}</span>
                    <span class="log-level ${l.level}">${l.level}</span>
                    ${esc(l.message)}
                </div>
            `).join('');
        }
        
        async function runSearch() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Searching...';
            
            updateActivityBar('searching', 'Manual search triggered', 'Searching for missing content and upgrades...');
            
            const data = await api('search', 'POST', {type: 'cycle'});
            
            btn.disabled = false;
            btn.textContent = 'Search Now';
            
            if (data.searched > 0) {
                updateActivityBar('finding', `Searched ${data.searched} items`, `${data.successful || 0} searches triggered successfully`);
            } else {
                updateActivityBar('idle', 'Search complete', 'No items needed searching');
            }
            
            alert(`Searched ${data.searched || 0} items`);
            loadDashboard();
            loadSearches();
        }
        
        async function resolveItem(source, queueId) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '...';
            
            try {
                const data = await api('resolve', 'POST', {source, queue_id: queueId, action: 'blocklist_retry'});
                if (data.success) {
                    btn.textContent = '‚úì';
                    btn.style.background = 'var(--success)';
                    setTimeout(() => loadQueue(), 1000);
                } else {
                    btn.textContent = '‚úó';
                    btn.style.background = 'var(--error)';
                    alert('Failed: ' + (data.message || 'Unknown error'));
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                        btn.disabled = false;
                    }, 2000);
                }
            } catch (e) {
                btn.textContent = '‚úó';
                btn.style.background = 'var(--error)';
                alert('Error: ' + e.message);
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.disabled = false;
                }, 2000);
            }
        }
        
        function showIntervention(item) {
            document.getElementById('modal-title').textContent = item.title;
            document.getElementById('modal-desc').textContent = item.reason;
            document.getElementById('modal-details').innerHTML = `<p style="color:var(--text2);font-size:13px;margin-top:10px">${JSON.stringify(item.details)}</p>`;
            
            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-sec" onclick="dismissIntervention('${item.source}',${item.id},'${item.intervention_type}')">Dismiss</button>
                <button class="btn btn-pri" onclick="closeModal()">Close</button>
            `;
            
            document.getElementById('modal').classList.add('show');
        }
        
        async function dismissIntervention(source, id, type) {
            await api('intervention/dismiss', 'POST', {source, id, type});
            closeModal();
            loadInterventions();
        }
        
        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }
        
        async function openSettingsModal() {
            // Load current settings
            const data = await api('settings');
            if (data.search) {
                document.getElementById('settings-api-limit').value = data.search.daily_api_limit || 500;
                document.getElementById('settings-per-cycle').value = data.search.searches_per_cycle || 10;
                document.getElementById('settings-interval').value = data.search.cycle_interval_minutes || 30;
            }
            if (data.tiers) {
                // Hot
                document.getElementById('settings-hot-max').value = data.tiers.hot?.max_days || 90;
                document.getElementById('settings-hot-interval').value = data.tiers.hot?.interval_minutes || 60;
                // Warm
                document.getElementById('settings-warm-min').value = data.tiers.warm?.min_days || 90;
                document.getElementById('settings-warm-max').value = data.tiers.warm?.max_days || 365;
                document.getElementById('settings-warm-interval').value = data.tiers.warm?.interval_minutes || 360;
                // Cool
                document.getElementById('settings-cool-min').value = data.tiers.cool?.min_days || 365;
                document.getElementById('settings-cool-max').value = data.tiers.cool?.max_days || 1095;
                document.getElementById('settings-cool-interval').value = data.tiers.cool?.interval_minutes || 1440;
                // Cold
                document.getElementById('settings-cold-min').value = data.tiers.cold?.min_days || 1095;
                document.getElementById('settings-cold-interval').value = data.tiers.cold?.interval_minutes || 10080;
            }
            // Quiet hours
            if (data.quiet_hours) {
                const toggle = document.getElementById('settings-quiet-toggle');
                if (data.quiet_hours.enabled) {
                    toggle.classList.add('on');
                } else {
                    toggle.classList.remove('on');
                }
                document.getElementById('settings-quiet-start').value = data.quiet_hours.start_hour ?? 2;
                document.getElementById('settings-quiet-end').value = data.quiet_hours.end_hour ?? 7;
            }
            updateThemeButtons();
            updateSettingsPacingPresets();
            document.getElementById('settings-modal').classList.add('show');
        }
        
        function updateSettingsPacingPresets() {
            const apiLimit = parseInt(document.getElementById('settings-api-limit').value) || 500;
            const currentSearches = parseInt(document.getElementById('settings-per-cycle').value) || 10;
            const currentInterval = parseInt(document.getElementById('settings-interval').value) || 60;
            
            // Calculate presets based on API limit
            const steady = { searches: Math.round(apiLimit / 24), interval: 60, hours: 24 };
            const fast = { searches: Math.round(apiLimit / 12), interval: 60, hours: 12 };
            const faster = { searches: Math.round(apiLimit / 6), interval: 60, hours: 6 };
            const blazing = { searches: Math.round(apiLimit / 6), interval: 30, hours: 3 };
            
            const presets = [
                { name: 'Steady', emoji: 'üê¢', ...steady, recommended: true },
                { name: 'Fast', emoji: 'üêá', ...fast },
                { name: 'Faster', emoji: 'üöÄ', ...faster },
                { name: 'Blazing', emoji: '‚ö°', ...blazing }
            ];
            
            const container = document.getElementById('settings-pacing-presets');
            container.innerHTML = presets.map(p => {
                const isSelected = currentSearches === p.searches && currentInterval === p.interval;
                return `
                    <div onclick="applySettingsPacing(${p.searches}, ${p.interval})" 
                         style="background: var(--bg3); padding: 10px 8px; border-radius: 8px; cursor: pointer; 
                                border: 2px solid ${isSelected ? 'var(--accent)' : 'transparent'}; text-align: center;
                                transition: all 0.2s;">
                        <div style="font-size: 16px;">${p.emoji}</div>
                        <div style="font-weight: 500; font-size: 12px; margin: 2px 0;">${p.name}</div>
                        <div style="color: var(--text3); font-size: 10px;">${p.searches} / ${p.interval} min</div>
                        <div style="color: var(--text3); font-size: 10px;">${p.hours} hours</div>
                        ${p.recommended ? '<div style="color: var(--success); font-size: 9px; margin-top: 2px;">‚úì Recommended</div>' : ''}
                    </div>
                `;
            }).join('');
        }
        
        function applySettingsPacing(searches, interval) {
            document.getElementById('settings-per-cycle').value = searches;
            document.getElementById('settings-interval').value = interval;
            updateSettingsPacingPresets();
        }
        
        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('show');
        }
        
        async function saveSettings() {
            const settings = {
                search: {
                    daily_api_limit: parseInt(document.getElementById('settings-api-limit').value) || 500,
                    searches_per_cycle: parseInt(document.getElementById('settings-per-cycle').value) || 10,
                    cycle_interval_minutes: parseInt(document.getElementById('settings-interval').value) || 30
                },
                tiers: {
                    hot: {
                        min_days: 0,
                        max_days: parseInt(document.getElementById('settings-hot-max').value) || 90,
                        interval_minutes: parseInt(document.getElementById('settings-hot-interval').value) || 60
                    },
                    warm: {
                        min_days: parseInt(document.getElementById('settings-warm-min').value) || 90,
                        max_days: parseInt(document.getElementById('settings-warm-max').value) || 365,
                        interval_minutes: parseInt(document.getElementById('settings-warm-interval').value) || 360
                    },
                    cool: {
                        min_days: parseInt(document.getElementById('settings-cool-min').value) || 365,
                        max_days: parseInt(document.getElementById('settings-cool-max').value) || 1095,
                        interval_minutes: parseInt(document.getElementById('settings-cool-interval').value) || 1440
                    },
                    cold: {
                        min_days: parseInt(document.getElementById('settings-cold-min').value) || 1095,
                        max_days: null,
                        interval_minutes: parseInt(document.getElementById('settings-cold-interval').value) || 10080
                    }
                },
                quiet_hours: {
                    enabled: document.getElementById('settings-quiet-toggle').classList.contains('on'),
                    start_hour: parseInt(document.getElementById('settings-quiet-start').value) || 2,
                    end_hour: parseInt(document.getElementById('settings-quiet-end').value) || 7
                }
            };
            const result = await api('settings', 'POST', settings);
            if (result.success) {
                closeSettingsModal();
                loadDashboard(); // Refresh to show new limit
            } else {
                alert('Failed to save settings: ' + result.message);
            }
        }
        
        // Close modals when clicking outside
        document.getElementById('settings-modal').addEventListener('click', function(e) {
            if (e.target === this) closeSettingsModal();
        });
        
        // ============ Initialization System ============
        const initState = {
            startTime: Date.now(),
            dismissed: false,
            maxTime: 60000  // 60 second max
        };
        
        function updateInitStep(step, status) {
            const el = document.getElementById(`init-step-${step}`);
            if (!el) return;
            
            const icon = el.querySelector('.init-step-icon');
            el.classList.remove('active', 'done');
            
            if (status === 'active') {
                el.classList.add('active');
                icon.textContent = 'üîÑ';
            } else if (status === 'done') {
                el.classList.add('done');
                icon.textContent = '‚úì';
            } else if (status === 'skip') {
                el.classList.add('done');
                icon.textContent = '‚è≠Ô∏è';
            }
        }
        
        function hideInitOverlay() {
            if (initState.dismissed) return;
            initState.dismissed = true;
            
            const overlay = document.getElementById('init-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 500);
            }
        }
        
        async function initializeApp() {
            const statusEl = document.getElementById('init-status');
            const timerEl = document.getElementById('init-timer');
            const progressBar = document.getElementById('init-progress');
            
            // Countdown timer from 60
            const updateTimer = setInterval(() => {
                if (initState.dismissed) {
                    clearInterval(updateTimer);
                    return;
                }
                const elapsed = Date.now() - initState.startTime;
                const remaining = Math.max(0, Math.ceil((initState.maxTime - elapsed) / 1000));
                if (timerEl) timerEl.textContent = `${remaining}s`;
            }, 200);
            
            try {
                // Step 1: Load configuration
                updateInitStep('config', 'active');
                if (statusEl) statusEl.textContent = 'Loading configuration...';
                if (progressBar) progressBar.style.width = '10%';
                
                await loadStatus();
                updateInitStep('config', 'done');
                
                // Step 2: Connect to services
                updateInitStep('services', 'active');
                if (statusEl) statusEl.textContent = 'Connecting to services...';
                if (progressBar) progressBar.style.width = '25%';
                
                const status = await api('status');
                
                let sonarrOk = false;
                let radarrOk = false;
                
                if (status.services) {
                    for (const [key, svc] of Object.entries(status.services)) {
                        if (key.startsWith('sonarr') && svc.connected) sonarrOk = true;
                        if (key.startsWith('radarr') && svc.connected) radarrOk = true;
                    }
                }
                
                if (!sonarrOk && !radarrOk) {
                    updateInitStep('services', 'done');
                    if (statusEl) statusEl.textContent = 'No services connected - check settings';
                    if (progressBar) {
                        progressBar.style.width = '100%';
                        progressBar.style.background = 'var(--warn)';
                    }
                    clearInterval(updateTimer);
                    await new Promise(r => setTimeout(r, 2000));
                    hideInitOverlay();
                    loadDashboard();
                    loadQueue();
                    loadFinds();
                    loadSearches();
                    loadLogs();
                    return;
                }
                
                updateInitStep('services', 'done');
                
                // Load scoreboard data
                if (progressBar) progressBar.style.width = '35%';
                try {
                    const data = await api('scoreboard');
                    if (data.scoreboard) {
                        document.getElementById('finds-today').textContent = data.scoreboard.finds_today || 0;
                        document.getElementById('finds-total').textContent = data.scoreboard.finds_total || 0;
                        document.getElementById('api-used').textContent = data.scoreboard.api_hits_today || 0;
                        document.getElementById('api-limit').textContent = data.scoreboard.api_limit || 500;
                        
                        if (data.scoreboard.finds_by_source) {
                            const sonarr = data.scoreboard.finds_by_source.sonarr || 0;
                            const radarr = data.scoreboard.finds_by_source.radarr || 0;
                            const breakdownText = `üì∫ ${sonarr} ‚Ä¢ üé¨ ${radarr}`;
                            const todayBreakdown = document.getElementById('finds-today-breakdown');
                            const totalBreakdown = document.getElementById('finds-total-breakdown');
                            if (todayBreakdown) todayBreakdown.textContent = breakdownText;
                            if (totalBreakdown) totalBreakdown.textContent = breakdownText;
                        }
                        
                        updateStatusIndicator(data.scoreboard, data.scheduler);
                    }
                } catch (e) {
                    console.warn('Scoreboard load failed:', e);
                }
                
                // Step 3: Fetch library data (the potentially slow part)
                updateInitStep('data', 'active');
                if (statusEl) statusEl.textContent = 'Counting missing content (this may take a moment)...';
                if (progressBar) progressBar.style.width = '50%';
                
                // Calculate remaining time for tier data
                const elapsed = Date.now() - initState.startTime;
                const remainingTime = Math.max(5000, initState.maxTime - elapsed);
                
                const tierPromise = loadDashboard();
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('timeout')), remainingTime)
                );
                
                try {
                    await Promise.race([tierPromise, timeoutPromise]);
                    updateInitStep('data', 'done');
                    if (progressBar) progressBar.style.width = '75%';
                } catch (e) {
                    if (e.message === 'timeout') {
                        console.warn('Tier data timeout - proceeding without');
                        updateInitStep('data', 'skip');
                        document.getElementById('tier-total-label').textContent = 'Loading in background...';
                    }
                }
                
                // Load queue
                await loadQueue();
                
                // Step 4: Prepare dashboard
                updateInitStep('ui', 'active');
                if (statusEl) statusEl.textContent = 'Preparing dashboard...';
                if (progressBar) progressBar.style.width = '90%';
                
                await Promise.all([
                    loadInterventions(),
                    loadFinds(),
                    loadSearches(),
                    loadLogs()
                ]);
                
                updateInitStep('ui', 'done');
                
                // Done!
                if (progressBar) progressBar.style.width = '100%';
                if (statusEl) statusEl.textContent = 'Ready!';
                
                clearInterval(updateTimer);
                if (timerEl) timerEl.textContent = '‚úì';
                await new Promise(r => setTimeout(r, 400));
                hideInitOverlay();
                
                // Trigger first search automatically after a short delay
                setTimeout(() => {
                    console.log('Triggering initial search cycle...');
                    runSearch();
                }, 2000);
                
            } catch (error) {
                console.error('Initialization error:', error);
                if (statusEl) statusEl.textContent = 'Error - ' + (error.message || 'check settings');
                if (progressBar) {
                    progressBar.style.width = '100%';
                    progressBar.style.background = 'var(--error)';
                }
                clearInterval(updateTimer);
                
                await new Promise(r => setTimeout(r, 2000));
                hideInitOverlay();
                
                loadDashboard();
                loadQueue();
                loadFinds();
                loadSearches();
                loadLogs();
            }
        }
        
        // Start initialization
        initializeApp();
        
        // Refresh periodically
        setTimeout(() => {
            setInterval(loadStatus, 30000);
            setInterval(loadDashboard, 60000);
            setInterval(loadQueue, 60000);
            setInterval(loadFinds, 60000);
            setInterval(loadSearches, 60000);
            setInterval(loadLogs, 30000);
        }, 5000);
    </script>
    <div class="version-footer">The Fantastic Machinarr v1.0.34</div>
</body>
</html>
