<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Fantastic Machinarr</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¨</text></svg>">
    <style>
        /* Theme Variables */
        :root {
            --transition: 0.2s ease;
        }
        
        [data-theme="dark"] {
            --bg: #0c0f1a;
            --bg2: #151928;
            --bg3: #1e2538;
            --bg-hover: #252d42;
            --text: #f0f2f5;
            --text2: #8b92a5;
            --text3: #5c6478;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --success: #10b981;
            --success-bg: rgba(16, 185, 129, 0.15);
            --warn: #f59e0b;
            --warn-bg: rgba(245, 158, 11, 0.15);
            --error: #ef4444;
            --error-bg: rgba(239, 68, 68, 0.15);
            --border: #2a3246;
            --border-focus: #6366f1;
            --card-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            --glow: 0 0 20px rgba(99, 102, 241, 0.15);
        }
        
        [data-theme="light"] {
            --bg: #f4ede4;
            --bg2: #e8dfd3;
            --bg3: #d4c4b0;
            --bg-hover: #c9b89e;
            --text: #3d3028;
            --text2: #5c4d3d;
            --text3: #7a6b5a;
            --accent: #8b6914;
            --accent-hover: #a07818;
            --accent-glow: rgba(139, 105, 20, 0.25);
            --success: #5a7a32;
            --success-bg: rgba(90, 122, 50, 0.15);
            --warn: #b8860b;
            --warn-bg: rgba(184, 134, 11, 0.15);
            --error: #a04040;
            --error-bg: rgba(160, 64, 64, 0.15);
            --border: #c4b5a0;
            --border-focus: #8b6914;
            --card-shadow: 0 2px 12px rgba(61, 48, 40, 0.08);
            --glow: 0 0 15px rgba(139, 105, 20, 0.1);
        }
        
        [data-theme="win98"] {
            --bg: #008080;
            --bg2: #c0c0c0;
            --bg3: #808080;
            --bg-hover: #b0b0b0;
            --text: #000000;
            --text2: #222222;
            --text3: #444444;
            --accent: #000080;
            --accent-hover: #0000aa;
            --accent-glow: rgba(0, 0, 128, 0.3);
            --success: #008000;
            --success-bg: rgba(0, 128, 0, 0.2);
            --warn: #808000;
            --warn-bg: rgba(128, 128, 0, 0.2);
            --error: #800000;
            --error-bg: rgba(128, 0, 0, 0.2);
            --border: #808080;
            --border-focus: #000080;
            --card-shadow: inset -1px -1px #0a0a0a, inset 1px 1px #ffffff, inset -2px -2px #808080, inset 2px 2px #dfdfdf;
            --glow: none;
        }
        
        /* Windows 98 specific styling */
        [data-theme="win98"] .panel,
        [data-theme="win98"] .score-card,
        [data-theme="win98"] .modal-content {
            border-radius: 0;
            border: none;
            box-shadow: inset -1px -1px #0a0a0a, inset 1px 1px #ffffff, inset -2px -2px #808080, inset 2px 2px #dfdfdf;
        }
        
        [data-theme="win98"] .panel-head {
            background: linear-gradient(90deg, #000080, #1084d0);
            color: #ffffff;
            font-weight: bold;
        }
        
        [data-theme="win98"] .panel-title {
            color: #ffffff;
        }
        
        [data-theme="win98"] .btn {
            border-radius: 0;
            box-shadow: inset -1px -1px #0a0a0a, inset 1px 1px #ffffff, inset -2px -2px #808080, inset 2px 2px #dfdfdf;
        }
        
        [data-theme="win98"] .btn:active {
            box-shadow: inset 1px 1px #0a0a0a, inset -1px -1px #ffffff, inset 2px 2px #808080, inset -2px -2px #dfdfdf;
        }
        
        [data-theme="win98"] .btn-pri {
            background: #c0c0c0;
            color: #000000;
        }
        
        [data-theme="win98"] .btn-sec {
            background: #c0c0c0;
            color: #000000;
            border: none;
        }
        
        [data-theme="win98"] header {
            background: #c0c0c0;
            box-shadow: inset -1px -1px #0a0a0a, inset 1px 1px #ffffff;
        }
        
        [data-theme="win98"] .activity-bar {
            border-radius: 0;
            box-shadow: inset 1px 1px #808080, inset -1px -1px #ffffff;
            background: #c0c0c0;
        }
        
        [data-theme="win98"] input,
        [data-theme="win98"] select {
            border-radius: 0;
            box-shadow: inset 1px 1px #808080, inset -1px -1px #ffffff, inset 2px 2px #0a0a0a, inset -2px -2px #dfdfdf;
            background: #ffffff;
        }
        
        [data-theme="win98"] body {
            font-family: 'MS Sans Serif', 'Segoe UI', Tahoma, sans-serif;
        }
        
        [data-theme="win98"] .logo span {
            font-family: 'MS Sans Serif', Tahoma, sans-serif;
        }
        
        [data-theme="win98"] .data-table {
            border: 2px solid;
            border-color: #808080 #ffffff #ffffff #808080;
        }
        
        [data-theme="win98"] .data-table th {
            background: #c0c0c0;
            border-bottom: 2px solid;
            border-color: #ffffff #808080 #808080 #ffffff;
        }
        
        [data-theme="win98"] .badge {
            border-radius: 0;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: background var(--transition), color var(--transition);
        }
        
        /* Header */
        header {
            background: var(--bg2);
            border-bottom: 1px solid var(--border);
            padding: 16px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all var(--transition);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        /* Update Banner */
        .update-banner {
            display: none;
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }
        
        .update-banner.visible {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
        }
        
        .update-banner a {
            color: white;
            text-decoration: underline;
            font-weight: 600;
        }
        
        .update-banner a:hover {
            opacity: 0.9;
        }
        
        .update-banner .dismiss-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .update-banner .dismiss-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .status-dots {
            display: flex;
            gap: 10px;
        }
        
        .dot {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: var(--bg3);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid var(--border);
            transition: all var(--transition);
        }
        
        .dot-ind {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text3);
        }
        
        .dot-ind.on {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }
        
        .dot-ind.off {
            background: var(--error);
        }
        
        .theme-btn, .settings-btn {
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 16px;
            transition: all var(--transition);
            color: var(--text);
        }
        
        .theme-btn:hover, .settings-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }
        
        /* Scoreboard */
        .scoreboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            padding: 24px 28px;
            background: var(--bg2);
            border-bottom: 1px solid var(--border);
        }
        
        .score-card {
            background: var(--bg3);
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all var(--transition);
        }
        
        .score-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }
        
        .score-val {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -1px;
        }
        
        .score-label {
            font-size: 12px;
            color: var(--text2);
            margin-top: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .score-card.hot {
            border-left: 4px solid var(--error);
        }
        
        .score-card.api {
            border-left: 4px solid var(--accent);
        }
        
        /* Main layout - all full width rows */
        main {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 24px 28px;
        }
        
        @media (max-width: 1024px) {
            .scoreboard { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* Panels */
        .panel {
            background: var(--bg2);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all var(--transition);
        }
        
        .panel:hover {
            box-shadow: var(--card-shadow);
        }
        
        .panel-head {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg3);
        }
        
        .panel-title {
            font-weight: 600;
            font-size: 15px;
            letter-spacing: -0.2px;
        }
        
        /* Expand hint shown when more than 5 items */
        .expand-hint {
            text-align: center;
            padding: 8px;
            color: var(--text3);
            font-size: 12px;
            border-top: 1px solid var(--border);
            cursor: pointer;
            transition: all var(--transition);
        }
        
        .expand-hint:hover {
            background: var(--bg-hover);
            color: var(--accent);
        }
        
        .panel-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .panel-body.flush { padding: 0; }
        
        .panel-body::-webkit-scrollbar {
            width: 6px;
        }
        
        .panel-body::-webkit-scrollbar-track {
            background: var(--bg3);
        }
        
        .panel-body::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        /* Panel Row - side by side panels */
        .panel-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .panel.half {
            margin-bottom: 0;
        }
        
        @media (max-width: 900px) {
            .panel-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* Compact Scoreboard */
        .scoreboard.compact {
            padding: 12px 20px;
            gap: 16px;
        }
        
        .scoreboard.compact .score-card {
            padding: 12px 16px;
            min-width: 100px;
        }
        
        .scoreboard.compact .score-val {
            font-size: 28px;
        }
        
        .scoreboard.compact .score-label {
            font-size: 10px;
        }
        
        .score-breakdown {
            font-size: 10px;
            color: var(--text3);
            margin-top: 2px;
        }
        
        .score-card.status {
            background: var(--bg3);
        }
        
        .score-card.status .score-val {
            font-size: 24px;
        }
        
        .score-card.status.active {
            background: var(--success-bg);
            border-color: var(--success);
        }
        
        .score-card.status.paused {
            background: var(--warn-bg);
            border-color: var(--warn);
        }
        
        .score-card.status.exhausted {
            background: var(--error-bg);
            border-color: var(--error);
        }
        
        /* Storage Summary */
        .storage-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .storage-item {
            background: var(--bg3);
            padding: 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        
        .storage-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .storage-item-label {
            font-weight: 600;
            font-size: 13px;
        }
        
        .storage-item-value {
            font-size: 12px;
            color: var(--text2);
        }
        
        .storage-bar {
            height: 8px;
            background: var(--bg);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .storage-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .storage-bar-fill.ok { background: var(--success); }
        .storage-bar-fill.warn { background: var(--warn); }
        .storage-bar-fill.critical { background: var(--error); }
        
        .storage-details {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text3);
        }
        
        /* Tiers */
        .tiers {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
        }
        
        .tier {
            flex: 1;
            min-width: 90px;
            background: var(--bg3);
            padding: 18px 14px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all var(--transition);
        }
        
        .tier:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        
        .tier-emoji { font-size: 28px; }
        .tier-count { font-size: 26px; font-weight: 700; margin: 6px 0; }
        .tier-name { font-size: 11px; color: var(--text2); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .tier-desc { font-size: 10px; color: var(--text3); margin-top: 4px; }
        .tier-breakdown {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            font-size: 10px;
            color: var(--text2);
        }
        .tier-breakdown span { display: flex; align-items: center; gap: 4px; }
        
        /* Horizontal tier layout */
        .tiers.tiers-horizontal {
            gap: 12px;
        }
        .tiers.tiers-horizontal .tier {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            text-align: left;
        }
        .tiers.tiers-horizontal .tier-emoji { 
            font-size: 24px; 
            flex-shrink: 0;
        }
        .tiers.tiers-horizontal .tier-info {
            display: flex;
            align-items: baseline;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }
        .tiers.tiers-horizontal .tier-count { 
            font-size: 24px; 
            font-weight: 700; 
            margin: 0;
            line-height: 1;
            flex-shrink: 0;
        }
        .tiers.tiers-horizontal .tier-labels {
            display: flex;
            flex-direction: column;
            gap: 1px;
            min-width: 0;
            overflow: hidden;
        }
        .tiers.tiers-horizontal .tier-name { 
            font-size: 12px; 
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .tiers.tiers-horizontal .tier-desc { 
            font-size: 10px; 
            margin-top: 0;
            color: var(--text3);
            white-space: nowrap;
        }
        .tiers.tiers-horizontal .tier-breakdown {
            font-size: 9px;
            color: var(--text2);
            margin-top: 1px;
            display: flex;
            gap: 6px;
            border: none;
            padding: 0;
        }
        .tiers.tiers-horizontal .tier-breakdown span {
            display: inline;
        }
        
        /* Mobile: 2x2 grid for tiers */
        @media (max-width: 768px) {
            .tiers.tiers-horizontal {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            .tiers.tiers-horizontal .tier {
                padding: 10px 12px;
                gap: 8px;
            }
            .tiers.tiers-horizontal .tier-emoji {
                font-size: 20px;
            }
            .tiers.tiers-horizontal .tier-count {
                font-size: 20px;
            }
            .tiers.tiers-horizontal .tier-name {
                font-size: 11px;
            }
            .tiers.tiers-horizontal .tier-desc {
                font-size: 9px;
            }
            .scoreboard {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                padding: 10px;
            }
            .scoreboard.compact {
                padding: 10px;
                gap: 8px;
            }
            .score-card {
                padding: 10px;
                min-width: 0;
            }
            .score-val {
                font-size: 24px;
            }
            .score-label {
                font-size: 8px;
            }
            .score-breakdown {
                font-size: 9px;
            }
            header {
                padding: 10px 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .header-right {
                width: 100%;
                justify-content: space-between;
            }
            .logo {
                font-size: 16px;
                gap: 8px;
            }
            .logo span {
                font-size: 20px;
            }
            .status-dots {
                display: flex;
                flex-wrap: wrap;
                gap: 4px;
                flex: 1;
            }
            .dot {
                font-size: 10px;
                padding: 3px 8px;
            }
            .theme-btn, .settings-btn {
                padding: 6px 10px;
                font-size: 14px;
            }
            main {
                padding: 10px;
                gap: 10px;
            }
            .panel-head {
                padding: 8px 12px;
                flex-wrap: wrap;
                gap: 6px;
            }
            .panel-title {
                font-size: 12px;
            }
            .panel-body {
                padding: 10px;
            }
            .activity-bar {
                padding: 8px 12px;
                font-size: 11px;
                flex-wrap: wrap;
                gap: 4px;
            }
            .activity-detail {
                width: 100%;
                margin-left: 0;
            }
            /* Modal mobile styles */
            .modal-content {
                padding: 20px;
                width: 95%;
                max-height: 85vh;
                overflow-y: auto;
            }
            .modal h3 {
                font-size: 16px;
                line-height: 1.3;
                margin-bottom: 12px;
            }
            .modal-actions {
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 16px;
            }
            .modal-actions .btn {
                flex: 1 1 45%;
                min-width: 0;
                padding: 12px 8px;
                font-size: 12px;
                flex-direction: column;
                gap: 4px;
            }
        }
        
        /* Extra small mobile */
        @media (max-width: 400px) {
            .scoreboard {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
                padding: 8px;
            }
            .score-card {
                padding: 8px;
            }
            .score-val {
                font-size: 20px;
            }
            .score-label {
                font-size: 7px;
            }
            .dot {
                font-size: 9px;
                padding: 2px 6px;
            }
        }
        
        /* Lifecycle states */
        .lifecycle-state {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .lifecycle-state.searching { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .lifecycle-state.cooldown { background: var(--bg3); color: var(--text2); }
        .lifecycle-state.escalating { background: var(--warn-bg); color: var(--warn); }
        .lifecycle-state.needs_attention { background: var(--error-bg); color: var(--error); }
        .lifecycle-state.found { background: var(--success-bg); color: var(--success); }
        .lifecycle-state.error { background: var(--error-bg); color: var(--error); }
        
        /* Search filters */
        .search-filters {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-filters input[type="text"] {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 13px;
            min-width: 200px;
        }
        .search-filters input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .search-filters select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
        }
        
        /* Items list */
        .item {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
            gap: 14px;
            transition: all var(--transition);
        }
        
        .item:last-child { border: none; }
        .item:hover { background: var(--bg-hover); }
        
        .item-icon { font-size: 22px; }
        .item-info { flex: 1; min-width: 0; }
        .item-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-meta { font-size: 12px; color: var(--text2); margin-top: 3px; }
        
        .item-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .item-badge.hot { background: var(--error-bg); color: var(--error); }
        .item-badge.warm { background: var(--warn-bg); color: var(--warn); }
        .item-badge.cool { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .item-badge.cold { background: var(--accent-glow); color: var(--accent); }
        .item-badge.issue { background: var(--error-bg); color: var(--error); }
        
        /* Buttons */
        .btn {
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all var(--transition);
        }
        
        .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 8px; }
        
        .btn-pri {
            background: var(--accent);
            color: #fff;
        }
        
        .btn-pri:hover {
            background: var(--accent-hover);
            box-shadow: 0 4px 12px var(--accent-glow);
        }
        
        .btn-sec {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-sec:hover {
            background: var(--bg-hover);
            border-color: var(--text3);
        }
        
        /* Empty state */
        .empty {
            text-align: center;
            padding: 50px 24px;
            color: var(--text2);
        }
        
        .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.6; }
        
        /* Logs */
        .log {
            padding: 10px 14px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 12px;
            border-bottom: 1px solid var(--border);
            transition: all var(--transition);
        }
        
        .log:hover { background: var(--bg-hover); }
        .log-time { color: var(--text3); margin-right: 10px; }
        
        .log-level {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .log-level.INFO { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .log-level.WARNING { background: var(--warn-bg); color: var(--warn); }
        .log-level.ERROR { background: var(--error-bg); color: var(--error); }
        .log-level.DEBUG { background: rgba(156,163,175,0.15); color: #9ca3af; }
        
        /* Compact row for tier + storage */
        .compact-row {
            display: flex;
            gap: 16px;
        }
        
        .compact-row .panel {
            margin-bottom: 0;
        }
        
        /* Data Tables */
        .data-table-wrap {
            overflow-x: auto;
            overflow-y: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .data-table th {
            text-align: left;
            padding: 10px 12px;
            background: var(--bg3);
            color: var(--text2);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        
        .data-table tr:hover td {
            background: var(--bg-hover);
        }
        
        .data-table .col-time { width: 140px; color: var(--text3); font-size: 12px; white-space: nowrap; }
        .data-table .col-type { width: 90px; }
        .data-table .col-source { width: 80px; }
        .data-table .col-tier { width: 70px; text-align: center; }
        .data-table .col-status { width: 80px; text-align: center; }
        .data-table .col-action { width: 100px; text-align: right; }
        .data-table .col-title { min-width: 200px; }
        .data-table .col-issue { min-width: 150px; color: var(--text2); font-size: 12px; }
        
        .data-table .title-main { font-weight: 500; color: var(--text); }
        .data-table .title-ep { color: var(--text2); font-size: 12px; margin-top: 2px; }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .badge-success { background: rgba(34,197,94,0.15); color: #22c55e; }
        .badge-error { background: var(--error-bg); color: var(--error); }
        .badge-warn { background: var(--warn-bg); color: var(--warn); }
        .badge-info { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .badge-hot { background: var(--error-bg); color: var(--error); }
        .badge-warm { background: var(--warn-bg); color: var(--warn); }
        .badge-cool { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .badge-cold { background: var(--accent-glow); color: var(--accent); }
        .badge-sonarr { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .badge-radarr { background: rgba(249,115,22,0.15); color: #f97316; }
        .badge-missing { background: var(--error-bg); color: var(--error); }
        .badge-upgrade { background: rgba(139,92,246,0.15); color: #8b5cf6; }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg3);
            border-top: 1px solid var(--border);
            position: sticky;
            bottom: 0;
            flex-shrink: 0;
            min-height: 44px;
        }
        
        .page-info {
            font-size: 12px;
            color: var(--text2);
            min-width: 160px;
            text-align: center;
        }
        
        .pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        /* Auto-resolve countdown */
        .countdown {
            font-size: 11px;
            color: var(--text3);
            background: var(--bg);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }
        
        .countdown.soon {
            background: rgba(34,197,94,0.15);
            color: #22c55e;
        }
        
        /* Urgent intervention rows */
        .data-table tr.urgent-row td {
            background: rgba(239,68,68,0.05);
        }
        
        .data-table tr.urgent-row:hover td {
            background: rgba(239,68,68,0.1);
        }
        
        /* Storage */
        .storage-bar { margin-bottom: 18px; }
        .storage-head { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .storage-path { font-family: monospace; color: var(--text2); }
        
        .bar {
            height: 10px;
            background: var(--bg3);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .bar-fill {
            height: 100%;
            background: var(--success);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        .bar-fill.warn { background: var(--warn); }
        .bar-fill.crit { background: var(--error); }
        
        /* Modals */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: var(--bg2);
            border-radius: 16px;
            padding: 28px;
            max-width: 520px;
            width: 90%;
            border: 1px solid var(--border);
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }
        
        .modal h3 {
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 600;
            word-break: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .modal-actions .btn { flex: 1; }
        
        /* Expanded Panel Modal */
        .modal.expanded-panel .modal-content {
            max-width: 95vw;
            width: 95vw;
            max-height: 90vh;
            height: 90vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        
        .expanded-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg3);
        }
        
        .expanded-header h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .expanded-header .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .expanded-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        
        .expanded-body .data-table-wrap {
            max-height: none !important;
        }
        
        .expanded-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            border-top: 1px solid var(--border);
            background: var(--bg3);
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .pagination button {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all var(--transition);
        }
        
        .pagination button:hover:not(:disabled) {
            background: var(--bg-hover);
            border-color: var(--accent);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .page-info {
            color: var(--text2);
            font-size: 13px;
            min-width: 120px;
            text-align: center;
        }
        
        .page-size-select {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text2);
            font-size: 13px;
        }
        
        .page-size-select select {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            font-size: 13px;
        }
        
        /* Expand button in panel headers */
        .expand-btn {
            padding: 4px 8px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text2);
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all var(--transition);
        }
        
        .expand-btn:hover {
            background: var(--bg-hover);
            color: var(--text);
            border-color: var(--accent);
        }
        
        .modal-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .modal-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 10px;
            text-align: center;
            min-height: 60px;
        }
        
        .modal-action-btn span:first-child {
            font-size: 20px;
        }
        
        .modal-action-btn span:last-child {
            font-size: 11px;
            line-height: 1.2;
        }
        
        /* Initialization Overlay */
        .init-overlay {
            position: fixed;
            inset: 0;
            background: rgba(12, 15, 26, 0.95);
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .init-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        .init-content {
            text-align: center;
            max-width: 400px;
            padding: 40px;
        }
        
        .init-logo {
            font-size: 64px;
            margin-bottom: 24px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .init-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        
        .init-status {
            color: var(--text2);
            font-size: 14px;
            margin-bottom: 24px;
        }
        
        .init-progress {
            width: 100%;
            height: 6px;
            background: var(--bg3);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 16px;
        }
        
        .init-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-hover));
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .init-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
            text-align: left;
            font-size: 13px;
            margin-top: 16px;
        }
        
        .init-step {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text3);
            transition: color 0.3s ease;
        }
        
        .init-step.active {
            color: var(--text);
        }
        
        .init-step.done {
            color: var(--success);
        }
        
        .init-step-icon {
            width: 20px;
            text-align: center;
        }
        
        .init-timer {
            margin-top: 20px;
            font-size: 14px;
            color: var(--text2);
            font-weight: 500;
        }
        
        /* Settings modal inputs */
        .settings-field {
            margin-bottom: 18px;
        }
        
        .settings-field label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .settings-field input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            transition: all var(--transition);
        }
        
        .settings-field input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        .settings-field .hint {
            font-size: 12px;
            color: var(--text3);
            margin-top: 6px;
        }
        
        /* Spinner */
        .spinner {
            width: 28px;
            height: 28px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 24px auto;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Full width panel */
        .full-width { grid-column: 1 / -1; }
        
        /* Toggle switch */
        .toggle {
            width: 48px;
            height: 26px;
            background: var(--border);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .toggle.on {
            background: var(--accent);
        }
        
        .toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle.on::after {
            transform: translateX(22px);
        }
        
        /* Version footer */
        .version-footer {
            text-align: center;
            padding: 16px;
            font-size: 11px;
            color: var(--text3);
            border-top: 1px solid var(--border);
            background: var(--bg2);
        }
        
        /* Activity Status Bar */
        .activity-bar {
            background: var(--bg3);
            border-bottom: 1px solid var(--border);
            padding: 8px 24px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--text2);
        }
        
        .activity-label {
            font-weight: 600;
            font-size: 16px;
            color: var(--text);
            margin-right: 8px;
        }
        
        .activity-icon {
            font-size: 16px;
        }
        
        .activity-text {
            font-weight: 500;
            color: var(--text);
        }
        
        .activity-detail {
            color: var(--text3);
            font-size: 12px;
        }
        
        .activity-bar.searching {
            background: linear-gradient(90deg, var(--bg3), rgba(99, 102, 241, 0.1), var(--bg3));
            background-size: 200% 100%;
            animation: searching-pulse 2s ease-in-out infinite;
        }
        
        .activity-bar.finding {
            background: rgba(34, 197, 94, 0.1);
        }
        
        @keyframes searching-pulse {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
    </style>
</head>
<body>
    <!-- Initialization Overlay -->
    <div class="init-overlay" id="init-overlay">
        <div class="init-content">
            <div class="init-logo">üé¨</div>
            <div class="init-title">The Fantastic Machinarr</div>
            <div class="init-status" id="init-status">Starting up...</div>
            <div class="init-progress">
                <div class="init-progress-bar" id="init-progress"></div>
            </div>
            <div class="init-steps">
                <div class="init-step" id="init-step-config">
                    <span class="init-step-icon">‚è≥</span>
                    <span>Loading configuration...</span>
                </div>
                <div class="init-step" id="init-step-services">
                    <span class="init-step-icon">‚è≥</span>
                    <span>Connecting to services...</span>
                </div>
                <div class="init-step" id="init-step-data">
                    <span class="init-step-icon">‚è≥</span>
                    <span>Fetching library data...</span>
                </div>
                <div class="init-step" id="init-step-ui">
                    <span class="init-step-icon">‚è≥</span>
                    <span>Preparing dashboard...</span>
                </div>
            </div>
            <div class="init-timer" id="init-timer">60s</div>
        </div>
    </div>

    <header>
        <div class="logo"><span>üé¨</span> The Fantastic Machinarr</div>
        <div class="header-right">
            <div class="status-dots" id="status-dots"></div>
            <button class="theme-btn" onclick="toggleTheme()" title="Toggle theme">üåô</button>
            <button class="settings-btn" onclick="openSettingsModal()" title="Settings">‚öôÔ∏è</button>
        </div>
    </header>
    
    <!-- Update Notification Banner -->
    <div class="update-banner" id="update-banner">
        <span>üéâ <strong>Update Available!</strong> Version <span id="latest-version"></span> is ready.</span>
        <a href="https://github.com/egadgetboy/thefantasticmachinarr/releases" target="_blank">View Release Notes</a>
        <button class="dismiss-btn" onclick="dismissUpdate()">Dismiss</button>
    </div>
    
    <!-- Compact Scoreboard -->
    <div class="scoreboard compact">
        <div class="score-card hot">
            <div class="score-val" id="finds-today">0</div>
            <div class="score-label">Finds Today</div>
            <div class="score-breakdown" id="finds-today-breakdown"></div>
        </div>
        <div class="score-card">
            <div class="score-val" id="finds-total">0</div>
            <div class="score-label">Total Finds</div>
            <div class="score-breakdown" id="finds-total-breakdown"></div>
        </div>
        <div class="score-card api">
            <div class="score-val"><span id="api-used">-</span><span style="color:var(--text3);font-size:16px"> / <span id="api-limit">-</span></span></div>
            <div class="score-label">API Calls</div>
        </div>
        <div class="score-card status" id="status-card">
            <div class="score-val" id="status-indicator">‚è≥</div>
            <div class="score-label" id="status-text">Initializing...</div>
        </div>
    </div>
    
    <!-- Real-time Activity Status Bar -->
    <div class="activity-bar" id="activity-bar">
        <span class="activity-label">Status</span>
        <span class="activity-icon" id="activity-icon">üí§</span>
        <span class="activity-text" id="activity-text">Idle</span>
        <span class="activity-detail" id="activity-detail"></span>
    </div>
    
    <main>
        <!-- Row 1: Content Needing Action by Tier -->
        <div class="panel">
            <div class="panel-head" style="padding: 10px 16px;">
                <span class="panel-title">üéØ Content Needing Action</span>
                <span id="tier-total-label" style="color:var(--text2);font-size:12px">Loading...</span>
            </div>
            <div class="panel-body" style="padding: 12px 16px;">
                <div class="tiers tiers-horizontal">
                    <div class="tier">
                        <div class="tier-emoji">üî•</div>
                        <div class="tier-info">
                            <div class="tier-count" id="tier-hot">-</div>
                            <div class="tier-labels">
                                <div class="tier-name">Hot</div>
                                <div class="tier-desc">0-90 days</div>
                                <div class="tier-breakdown"><span>üîç</span><span id="tier-hot-missing">-</span> <span>‚¨ÜÔ∏è</span><span id="tier-hot-upgrade">-</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="tier">
                        <div class="tier-emoji">‚òÄÔ∏è</div>
                        <div class="tier-info">
                            <div class="tier-count" id="tier-warm">-</div>
                            <div class="tier-labels">
                                <div class="tier-name">Warm</div>
                                <div class="tier-desc">90-365 days</div>
                                <div class="tier-breakdown"><span>üîç</span><span id="tier-warm-missing">-</span> <span>‚¨ÜÔ∏è</span><span id="tier-warm-upgrade">-</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="tier">
                        <div class="tier-emoji">‚ùÑÔ∏è</div>
                        <div class="tier-info">
                            <div class="tier-count" id="tier-cool">-</div>
                            <div class="tier-labels">
                                <div class="tier-name">Cool</div>
                                <div class="tier-desc">1-3 years</div>
                                <div class="tier-breakdown"><span>üîç</span><span id="tier-cool-missing">-</span> <span>‚¨ÜÔ∏è</span><span id="tier-cool-upgrade">-</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="tier">
                        <div class="tier-emoji">üßä</div>
                        <div class="tier-info">
                            <div class="tier-count" id="tier-cold">-</div>
                            <div class="tier-labels">
                                <div class="tier-name">Cold</div>
                                <div class="tier-desc">3+ years</div>
                                <div class="tier-breakdown"><span>üîç</span><span id="tier-cold-missing">-</span> <span>‚¨ÜÔ∏è</span><span id="tier-cold-upgrade">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Row 2: Search History -->
        <div class="panel" id="search-panel">
            <div class="panel-head">
                <div style="display:flex;align-items:center;gap:12px">
                    <span class="panel-title">üîç Search History</span>
                    <button class="btn btn-sm btn-pri" onclick="runSearch()">Search Now</button>
                    <button class="expand-btn" onclick="openExpandedPanel('search')" title="Expand to full view">‚õ∂</button>
                </div>
                <div style="display:flex;gap:12px;align-items:center">
                    <input type="text" id="search-filter-text" placeholder="Filter by title..." style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:12px;width:150px" onkeyup="filterSearchActivity()">
                    <select id="search-filter-tier" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:12px" onchange="filterSearchActivity()">
                        <option value="">All Tiers</option>
                        <option value="hot">üî• Hot</option>
                        <option value="warm">‚òÄÔ∏è Warm</option>
                        <option value="cool">‚ùÑÔ∏è Cool</option>
                        <option value="cold">üßä Cold</option>
                    </select>
                    <select id="search-filter-source" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:12px" onchange="filterSearchActivity()">
                        <option value="">All Sources</option>
                        <option value="sonarr">üì∫ Sonarr</option>
                        <option value="radarr">üé¨ Radarr</option>
                    </select>
                </div>
            </div>
            <div class="panel-body flush">
                <div class="data-table-wrap" id="search-list" style="max-height:280px">
                    <div class="empty"><div class="empty-icon">‚è≥</div><p>No searches yet</p></div>
                </div>
            </div>
        </div>
        
        <!-- Row 3: Downloading Now -->
        <div class="panel" id="downloads-panel">
            <div class="panel-head">
                <div style="display:flex;align-items:center;gap:12px">
                    <span class="panel-title">‚¨áÔ∏è Downloading Now</span>
                    <span id="downloads-count" style="color:var(--text2);font-size:13px">0 items</span>
                    <button class="expand-btn" onclick="openExpandedPanel('downloads')" title="Expand to full view">‚õ∂</button>
                </div>
                <div style="display:flex;gap:12px;align-items:center">
                    <input type="text" id="downloads-filter-text" placeholder="Filter by title..." style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:12px;width:150px" onkeyup="filterDownloads()">
                    <select id="downloads-sort" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:12px" onchange="filterDownloads()">
                        <option value="progress-desc">Finishing Soon</option>
                        <option value="progress-asc">Just Started</option>
                        <option value="title-asc">Title A-Z</option>
                        <option value="title-desc">Title Z-A</option>
                        <option value="eta-asc">ETA Shortest</option>
                    </select>
                    <select id="downloads-filter-source" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:12px" onchange="filterDownloads()">
                        <option value="">All Sources</option>
                        <option value="sonarr">üì∫ Sonarr</option>
                        <option value="radarr">üé¨ Radarr</option>
                        <option value="sabnzbd">üì• SABnzbd</option>
                    </select>
                </div>
            </div>
            <div class="panel-body flush">
                <div class="data-table-wrap" id="downloads-list">
                    <div class="empty"><div class="empty-icon">üì≠</div><p>Nothing downloading</p></div>
                </div>
            </div>
        </div>
        
        <!-- Row 4: Recently Grabbed -->
        <div class="panel" id="finds-panel">
            <div class="panel-head">
                <div style="display:flex;align-items:center;gap:8px">
                    <span class="panel-title">‚úÖ Recently Grabbed</span>
                    <button class="expand-btn" onclick="openExpandedPanel('finds')" title="Expand to full view">‚õ∂</button>
                </div>
                <span id="finds-count" style="color:var(--text2);font-size:13px">0 items</span>
            </div>
            <div class="panel-body flush">
                <div class="data-table-wrap" id="finds-list">
                    <div class="empty"><div class="empty-icon">üîç</div><p>No grabs yet - TFM is working on it!</p></div>
                </div>
            </div>
        </div>
        
        <!-- Row 5: Download Problems -->
        <div class="panel" id="problems-panel">
            <div class="panel-head">
                <div style="display:flex;align-items:center;gap:8px">
                    <span class="panel-title">‚ö†Ô∏è Download Problems</span>
                    <button class="expand-btn" onclick="openExpandedPanel('problems')" title="Expand to full view">‚õ∂</button>
                </div>
                <span id="stuck-count" style="color:var(--text2);font-size:13px">0 items</span>
            </div>
            <div class="panel-body flush">
                <div class="data-table-wrap" id="stuck-list">
                    <div class="empty"><div class="empty-icon">‚úÖ</div><p>No problems</p></div>
                </div>
            </div>
        </div>
        
        <!-- Row 6: Needs Attention -->
        <div class="panel" id="attention-panel">
            <div class="panel-head">
                <div style="display:flex;align-items:center;gap:8px">
                    <span class="panel-title">üñêÔ∏è Needs Attention</span>
                    <button class="expand-btn" onclick="openExpandedPanel('interventions')" title="Expand to full view">‚õ∂</button>
                </div>
                <span id="intervention-count" style="color:var(--text2);font-size:13px">0 items</span>
            </div>
            <div class="panel-body flush">
                <div class="data-table-wrap" id="intervention-list">
                    <div class="empty"><div class="empty-icon">üëç</div><p>Nothing needs attention</p></div>
                </div>
            </div>
        </div>
        
        <!-- Row 7: Debug Logs -->
        <div class="panel full-width">
            <div class="panel-head">
                <span class="panel-title">üìã Debug Logs</span>
                <select id="log-filter" onchange="loadLogs()" style="background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:5px 10px;border-radius:4px">
                    <option value="">All</option>
                    <option value="ERROR">Errors</option>
                    <option value="WARNING">Warnings</option>
                    <option value="INFO">Info</option>
                    <option value="DEBUG">Debug</option>
                </select>
            </div>
            <div class="panel-body flush" id="log-list" style="max-height:300px">
                <div class="spinner"></div>
            </div>
        </div>
    </main>
    
    <!-- Expanded Panel Modal -->
    <div class="modal expanded-panel" id="expanded-modal">
        <div class="modal-content">
            <div class="expanded-header">
                <h3 id="expanded-title">Panel Title</h3>
                <div class="header-controls">
                    <div id="expanded-filters"></div>
                    <button class="btn btn-sec" onclick="closeExpandedPanel()">‚úï Close</button>
                </div>
            </div>
            <div class="expanded-body">
                <div class="data-table-wrap" id="expanded-content"></div>
            </div>
            <div class="expanded-footer">
                <div class="page-size-select">
                    <label>Items per page:</label>
                    <select id="expanded-page-size" onchange="changeExpandedPageSize()">
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                    </select>
                </div>
                <div class="pagination">
                    <button onclick="expandedPageFirst()" title="First page">‚èÆ</button>
                    <button onclick="expandedPagePrev()" title="Previous page">‚óÄ</button>
                    <span class="page-info" id="expanded-page-info">Page 1 of 1</span>
                    <button onclick="expandedPageNext()" title="Next page">‚ñ∂</button>
                    <button onclick="expandedPageLast()" title="Last page">‚è≠</button>
                </div>
                <div id="expanded-total-info" style="color:var(--text2);font-size:13px"></div>
            </div>
        </div>
    </div>
    
    <!-- Intervention Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h3 id="modal-title">Manual Intervention</h3>
            <p id="modal-desc"></p>
            <div id="modal-details"></div>
            <div class="modal-actions" id="modal-actions"></div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content" style="max-width: 680px; max-height: 85vh; overflow-y: auto;">
            <h3>‚öôÔ∏è Settings</h3>
            
            <div class="settings-field">
                <label>üé® Theme</label>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-sec" id="theme-dark-btn" onclick="setTheme('dark')" style="flex:1;">üåô Dark</button>
                    <button class="btn btn-sec" id="theme-light-btn" onclick="setTheme('light')" style="flex:1;">‚òÄÔ∏è Light</button>
                </div>
            </div>
            
            <div class="settings-field">
                <label>üìä Daily API Limit</label>
                <input type="number" id="settings-api-limit" value="500" min="50" max="50000" onchange="updateSettingsPacingPresets()">
                <div class="hint">TFM spreads searches throughout the day to stay within this limit.</div>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label style="font-size: 13px; font-weight: 600; display: block; margin-bottom: 8px;">‚ö° Pacing Presets</label>
                <div id="settings-pacing-presets" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="settings-field" style="margin-bottom: 0;">
                    <label>üîç Searches Per Cycle</label>
                    <input type="number" id="settings-per-cycle" value="10" min="1" max="5000">
                </div>
                <div class="settings-field" style="margin-bottom: 0;">
                    <label>‚è±Ô∏è Cycle Interval (min)</label>
                    <input type="number" id="settings-interval" value="60" min="5" max="360">
                </div>
            </div>
            
            <h4 style="margin: 24px 0 12px; font-size: 14px;">üéØ Search Tier Configuration</h4>
            <div class="hint" style="margin-bottom: 12px;">Define age ranges (in days) and search frequency for each tier.</div>
            
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                <div style="background: var(--bg3); padding: 12px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px;">üî•</div>
                    <div style="font-weight: 600; margin: 4px 0;">Hot</div>
                    <div style="display: flex; gap: 4px; margin: 8px 0;">
                        <input type="number" id="settings-hot-min" value="0" min="0" style="width: 50%; padding: 6px; font-size: 11px;" disabled>
                        <input type="number" id="settings-hot-max" value="90" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                    </div>
                    <div style="font-size: 10px; color: var(--text3);">days old</div>
                    <select id="settings-hot-interval" style="width: 100%; padding: 6px; margin-top: 8px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                        <option value="30">30 min</option>
                        <option value="60" selected>1 hour</option>
                        <option value="120">2 hours</option>
                        <option value="180">3 hours</option>
                        <option value="360">6 hours</option>
                    </select>
                </div>
                <div style="background: var(--bg3); padding: 12px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px;">‚òÄÔ∏è</div>
                    <div style="font-weight: 600; margin: 4px 0;">Warm</div>
                    <div style="display: flex; gap: 4px; margin: 8px 0;">
                        <input type="number" id="settings-warm-min" value="90" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                        <input type="number" id="settings-warm-max" value="365" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                    </div>
                    <div style="font-size: 10px; color: var(--text3);">days old</div>
                    <select id="settings-warm-interval" style="width: 100%; padding: 6px; margin-top: 8px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                        <option value="180">3 hours</option>
                        <option value="360" selected>6 hours</option>
                        <option value="720">12 hours</option>
                        <option value="1440">Daily</option>
                    </select>
                </div>
                <div style="background: var(--bg3); padding: 12px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px;">‚ùÑÔ∏è</div>
                    <div style="font-weight: 600; margin: 4px 0;">Cool</div>
                    <div style="display: flex; gap: 4px; margin: 8px 0;">
                        <input type="number" id="settings-cool-min" value="365" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                        <input type="number" id="settings-cool-max" value="1095" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                    </div>
                    <div style="font-size: 10px; color: var(--text3);">days old</div>
                    <select id="settings-cool-interval" style="width: 100%; padding: 6px; margin-top: 8px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                        <option value="720">12 hours</option>
                        <option value="1440" selected>Daily</option>
                        <option value="2880">2 days</option>
                        <option value="4320">3 days</option>
                    </select>
                </div>
                <div style="background: var(--bg3); padding: 12px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px;">üßä</div>
                    <div style="font-weight: 600; margin: 4px 0;">Cold</div>
                    <div style="display: flex; gap: 4px; margin: 8px 0;">
                        <input type="number" id="settings-cold-min" value="1095" min="1" style="width: 50%; padding: 6px; font-size: 11px;">
                        <input type="text" value="‚àû" style="width: 50%; padding: 6px; font-size: 11px; text-align: center;" disabled>
                    </div>
                    <div style="font-size: 10px; color: var(--text3);">days old</div>
                    <select id="settings-cold-interval" style="width: 100%; padding: 6px; margin-top: 8px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                        <option value="4320">3 days</option>
                        <option value="10080" selected>Weekly</option>
                        <option value="20160">2 weeks</option>
                        <option value="43200">Monthly</option>
                    </select>
                </div>
            </div>
            
            <h4 style="margin: 24px 0 12px; font-size: 14px;">üò¥ Quiet Hours</h4>
            <div style="background: var(--bg3); padding: 14px; border-radius: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div>
                        <div style="font-weight: 500;">Pause searching during certain hours</div>
                        <div class="hint" style="margin-top: 4px;">TFM will stop searching between these hours (server time)</div>
                    </div>
                    <div class="toggle" id="settings-quiet-toggle" onclick="this.classList.toggle('on')" style="width: 48px; height: 26px; background: var(--border); border-radius: 13px; position: relative; cursor: pointer;"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label style="font-size: 12px; display: block; margin-bottom: 4px;">Start</label>
                        <select id="settings-quiet-start" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                            <option value="0">00:00</option><option value="1">01:00</option><option value="2" selected>02:00</option><option value="3">03:00</option><option value="4">04:00</option><option value="5">05:00</option><option value="6">06:00</option><option value="7">07:00</option><option value="8">08:00</option><option value="9">09:00</option><option value="10">10:00</option><option value="11">11:00</option><option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option><option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option><option value="20">20:00</option><option value="21">21:00</option><option value="22">22:00</option><option value="23">23:00</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; display: block; margin-bottom: 4px;">End</label>
                        <select id="settings-quiet-end" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                            <option value="0">00:00</option><option value="1">01:00</option><option value="2">02:00</option><option value="3">03:00</option><option value="4">04:00</option><option value="5">05:00</option><option value="6">06:00</option><option value="7" selected>07:00</option><option value="8">08:00</option><option value="9">09:00</option><option value="10">10:00</option><option value="11">11:00</option><option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option><option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option><option value="20">20:00</option><option value="21">21:00</option><option value="22">22:00</option><option value="23">23:00</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions" style="margin-top: 24px;">
                <button class="btn btn-sec" onclick="closeSettingsModal()">Cancel</button>
                <button class="btn btn-pri" onclick="saveSettings()">Save Settings</button>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); text-align: center;">
                <a href="/setup" style="color: var(--text2); font-size: 13px; text-decoration: none;">Run Setup Wizard Again ‚Üí</a>
            </div>
        </div>
    </div>
    
    <script>
        /*
         * IMPORTANT: localStorage rules for multi-browser/device support
         * ================================================================
         * localStorage is per-browser/device, NOT shared across devices.
         * 
         * ALLOWED in localStorage (personal display preferences):
         *   - tfm-theme: Color theme preference (OK to differ per device)
         *   - UI state like collapsed panels, sort preferences
         * 
         * NEVER store in localStorage (must be server-side):
         *   - Version tracking (would trigger auto-search on every device)
         *   - App state that affects behavior
         *   - Anything that triggers actions or API calls
         * 
         * Use /config/*.json files or API endpoints for shared state.
         */
        
        // Theme management - 3 themes: dark, light, win98
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            let next;
            if (current === 'dark') next = 'light';
            else if (current === 'light') next = 'win98';
            else next = 'dark';
            setTheme(next);
        }
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('tfm-theme', theme);
            // Update button icon
            const icons = { dark: 'üåô', light: '‚òÄÔ∏è', win98: 'ü™ü' };
            document.querySelector('.theme-btn').textContent = icons[theme] || 'üåô';
            updateThemeButtons();
        }
        
        function updateThemeButtons() {
            const theme = document.documentElement.getAttribute('data-theme');
            const darkBtn = document.getElementById('theme-dark-btn');
            const lightBtn = document.getElementById('theme-light-btn');
            const win98Btn = document.getElementById('theme-win98-btn');
            if (darkBtn) {
                darkBtn.style.background = theme === 'dark' ? 'var(--accent)' : '';
                darkBtn.style.color = theme === 'dark' ? '#fff' : '';
            }
            if (lightBtn) {
                lightBtn.style.background = theme === 'light' ? 'var(--accent)' : '';
                lightBtn.style.color = theme === 'light' ? '#fff' : '';
            }
            if (win98Btn) {
                win98Btn.style.background = theme === 'win98' ? 'var(--accent)' : '';
                win98Btn.style.color = theme === 'win98' ? '#fff' : '';
            }
        }
        
        // Load saved theme
        const savedTheme = localStorage.getItem('tfm-theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.querySelector('.theme-btn').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        
        // Format file size to human readable (MB, GB)
        function formatSize(bytes) {
            if (!bytes || isNaN(bytes)) return '-';
            const num = parseFloat(bytes);
            if (num >= 1073741824) return (num / 1073741824).toFixed(2) + ' GB';
            if (num >= 1048576) return (num / 1048576).toFixed(1) + ' MB';
            if (num >= 1024) return (num / 1024).toFixed(0) + ' KB';
            return num + ' B';
        }
        
        // Pagination state - store up to 500 items, show 5 per page in panels
        const PAGE_SIZE = 5;
        const MAX_ITEMS = 500;
        const paginationState = {
            searches: { items: [], page: 0 },
            finds: { items: [], page: 0 },
            queue: { items: [], page: 0 },
            interventions: { items: [], page: 0 }
        };
        
        // Map container IDs to panel types for expand
        const containerToPanelType = {
            'search-list': 'search',
            'finds-list': 'finds',
            'stuck-list': 'problems',
            'intervention-list': 'interventions'
        };
        
        function renderPagination(containerId, state, renderFn) {
            const totalItems = state.items.length;
            const pageItems = state.items.slice(0, PAGE_SIZE);  // Always show first 5
            const remaining = totalItems - PAGE_SIZE;
            
            // Show expand hint if more than 5 items
            const panelType = containerToPanelType[containerId];
            const expandHintHtml = remaining > 0 ? `
                <div class="expand-hint" onclick="openExpandedPanel('${panelType}')">
                    üìã ${remaining} more item${remaining > 1 ? 's' : ''} ‚Äî click to expand
                </div>
            ` : '';
            
            return { pageItems, paginationHtml: expandHintHtml };
        }
        
        // Expanded Panel State
        const expandedState = {
            panelType: null,
            items: [],
            page: 0,
            pageSize: parseInt(localStorage.getItem('tfm-expanded-page-size') || '20'),
            filterText: '',
            filterTier: '',
            filterSource: ''
        };
        
        function openExpandedPanel(panelType) {
            expandedState.panelType = panelType;
            expandedState.page = 0;
            
            // Copy items from pagination state
            const stateMap = {
                'search': 'searches',
                'finds': 'finds',
                'downloads': 'downloads',
                'problems': 'queue',
                'interventions': 'interventions'
            };
            
            const stateKey = stateMap[panelType];
            if (stateKey && paginationState[stateKey]) {
                expandedState.items = [...paginationState[stateKey].items];
            } else if (panelType === 'downloads') {
                // Downloads aren't in pagination state, get from DOM data
                expandedState.items = window.lastDownloadsData || [];
            }
            
            // Set title
            const titles = {
                'search': 'üîç Search History',
                'finds': '‚úÖ Recently Grabbed',
                'downloads': '‚¨áÔ∏è Downloading Now',
                'problems': '‚ö†Ô∏è Download Problems',
                'interventions': 'üñêÔ∏è Needs Attention'
            };
            document.getElementById('expanded-title').textContent = titles[panelType] || 'Panel';
            
            // Set page size from saved preference
            document.getElementById('expanded-page-size').value = expandedState.pageSize;
            
            // Build filters based on panel type
            buildExpandedFilters(panelType);
            
            // Render content
            renderExpandedContent();
            
            // Show modal
            document.getElementById('expanded-modal').classList.add('show');
        }
        
        function closeExpandedPanel() {
            document.getElementById('expanded-modal').classList.remove('show');
            expandedState.panelType = null;
        }
        
        function buildExpandedFilters(panelType) {
            const filtersDiv = document.getElementById('expanded-filters');
            let html = '';
            
            if (panelType === 'search' || panelType === 'finds') {
                html = `
                    <input type="text" placeholder="Filter by title..." 
                           style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:12px;width:150px"
                           onkeyup="expandedState.filterText=this.value; expandedState.page=0; renderExpandedContent()">
                    <select style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:12px"
                            onchange="expandedState.filterTier=this.value; expandedState.page=0; renderExpandedContent()">
                        <option value="">All Tiers</option>
                        <option value="hot">üî• Hot</option>
                        <option value="warm">‚òÄÔ∏è Warm</option>
                        <option value="cool">‚ùÑÔ∏è Cool</option>
                        <option value="cold">üßä Cold</option>
                    </select>
                    <select style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:12px"
                            onchange="expandedState.filterSource=this.value; expandedState.page=0; renderExpandedContent()">
                        <option value="">All Sources</option>
                        <option value="sonarr">üì∫ Sonarr</option>
                        <option value="radarr">üé¨ Radarr</option>
                    </select>
                `;
            } else if (panelType === 'downloads') {
                html = `
                    <input type="text" placeholder="Filter by title..." 
                           style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:12px;width:150px"
                           onkeyup="expandedState.filterText=this.value; expandedState.page=0; renderExpandedContent()">
                `;
            } else if (panelType === 'problems' || panelType === 'interventions') {
                html = `
                    <input type="text" placeholder="Filter by title..." 
                           style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:12px;width:150px"
                           onkeyup="expandedState.filterText=this.value; expandedState.page=0; renderExpandedContent()">
                `;
            }
            
            filtersDiv.innerHTML = html;
        }
        
        function getFilteredExpandedItems() {
            let items = expandedState.items;
            const filter = expandedState.filterText.toLowerCase();
            const tier = expandedState.filterTier;
            const source = expandedState.filterSource;
            
            if (filter) {
                items = items.filter(item => {
                    const title = (item.title || item.name || '').toLowerCase();
                    return title.includes(filter);
                });
            }
            
            if (tier) {
                items = items.filter(item => item.tier === tier);
            }
            
            if (source) {
                items = items.filter(item => item.source === source);
            }
            
            return items;
        }
        
        function renderExpandedContent() {
            const items = getFilteredExpandedItems();
            const totalPages = Math.max(1, Math.ceil(items.length / expandedState.pageSize));
            const start = expandedState.page * expandedState.pageSize;
            const end = start + expandedState.pageSize;
            const pageItems = items.slice(start, end);
            
            // Render items based on panel type
            let html = '';
            
            if (pageItems.length === 0) {
                html = '<div class="empty"><div class="empty-icon">üì≠</div><p>No items to display</p></div>';
            } else if (expandedState.panelType === 'search') {
                html = '<table class="data-table"><thead><tr><th>Title</th><th>Tier</th><th>Source</th><th>Status</th><th>Searched</th></tr></thead><tbody>';
                pageItems.forEach(item => {
                    const tierEmoji = {'hot':'üî•','warm':'‚òÄÔ∏è','cool':'‚ùÑÔ∏è','cold':'üßä'}[item.tier] || '';
                    const sourceIcon = item.source === 'sonarr' ? 'üì∫' : 'üé¨';
                    const statusIcon = item.found ? '‚úÖ' : (item.searched ? '‚è≥' : 'üîç');
                    const time = item.searched_at ? new Date(item.searched_at).toLocaleString() : '-';
                    html += `<tr>
                        <td>${item.title || 'Unknown'}</td>
                        <td>${tierEmoji} ${item.tier || '-'}</td>
                        <td>${sourceIcon} ${item.source || '-'}</td>
                        <td>${statusIcon}</td>
                        <td>${time}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
            } else if (expandedState.panelType === 'finds') {
                html = '<table class="data-table"><thead><tr><th>Title</th><th>Tier</th><th>Source</th><th>Method</th><th>Found</th></tr></thead><tbody>';
                pageItems.forEach(item => {
                    const tierEmoji = {'hot':'üî•','warm':'‚òÄÔ∏è','cool':'‚ùÑÔ∏è','cold':'üßä'}[item.tier] || '';
                    const sourceIcon = item.source === 'sonarr' ? 'üì∫' : 'üé¨';
                    const time = item.found_at ? new Date(item.found_at).toLocaleString() : '-';
                    html += `<tr>
                        <td>${item.title || 'Unknown'}</td>
                        <td>${tierEmoji} ${item.tier || '-'}</td>
                        <td>${sourceIcon} ${item.source || '-'}</td>
                        <td>${item.method || '-'}</td>
                        <td>${time}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
            } else if (expandedState.panelType === 'downloads') {
                html = '<table class="data-table"><thead><tr><th>Title</th><th>Source</th><th>Progress</th><th>ETA</th><th>Size</th></tr></thead><tbody>';
                pageItems.forEach(item => {
                    const sourceIcon = item.source === 'sonarr' ? 'üì∫' : (item.source === 'radarr' ? 'üé¨' : 'üì•');
                    const progress = item.progress || 0;
                    html += `<tr>
                        <td>${item.title || item.name || 'Unknown'}</td>
                        <td>${sourceIcon} ${item.source || '-'}</td>
                        <td><div class="progress-bar" style="width:100px;height:16px;background:var(--bg3);border-radius:4px;overflow:hidden"><div style="width:${progress}%;height:100%;background:var(--success)"></div></div> ${progress.toFixed(0)}%</td>
                        <td>${item.timeleft || item.eta || '-'}</td>
                        <td>${formatSize(item.size)}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
            } else if (expandedState.panelType === 'problems') {
                html = '<table class="data-table"><thead><tr><th>Title</th><th>Source</th><th>Issue</th><th>Status</th><th>Detected</th></tr></thead><tbody>';
                pageItems.forEach(item => {
                    const sourceIcon = item.source === 'sonarr' ? 'üì∫' : 'üé¨';
                    const time = item.first_detected ? new Date(item.first_detected).toLocaleString() : '-';
                    html += `<tr>
                        <td>${item.title || 'Unknown'}</td>
                        <td>${sourceIcon} ${item.source || '-'}</td>
                        <td>${(item.issues || []).join(', ') || '-'}</td>
                        <td>${item.can_auto_resolve ? 'üîÑ Auto' : 'üñêÔ∏è Manual'}</td>
                        <td>${time}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
            } else if (expandedState.panelType === 'interventions') {
                html = '<table class="data-table"><thead><tr><th>Title</th><th>Source</th><th>Reason</th><th>Type</th><th>Created</th></tr></thead><tbody>';
                pageItems.forEach(item => {
                    const sourceIcon = item.source === 'sonarr' ? 'üì∫' : 'üé¨';
                    const time = item.created_at ? new Date(item.created_at).toLocaleString() : '-';
                    html += `<tr class="clickable" onclick="showInterventionFromExpanded('${item.source}', ${item.id}, '${item.type || ''}')">
                        <td>${item.title || 'Unknown'}</td>
                        <td>${sourceIcon} ${item.source || '-'}</td>
                        <td>${item.reason || '-'}</td>
                        <td>${item.type || '-'}</td>
                        <td>${time}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
            }
            
            document.getElementById('expanded-content').innerHTML = html;
            
            // Update pagination info
            document.getElementById('expanded-page-info').textContent = `Page ${expandedState.page + 1} of ${totalPages}`;
            document.getElementById('expanded-total-info').textContent = `${items.length} items total`;
            
            // Update button states
            const buttons = document.querySelectorAll('#expanded-modal .pagination button');
            buttons[0].disabled = expandedState.page === 0;
            buttons[1].disabled = expandedState.page === 0;
            buttons[2].disabled = expandedState.page >= totalPages - 1;
            buttons[3].disabled = expandedState.page >= totalPages - 1;
        }
        
        function changeExpandedPageSize() {
            const newSize = parseInt(document.getElementById('expanded-page-size').value);
            expandedState.pageSize = newSize;
            expandedState.page = 0;
            localStorage.setItem('tfm-expanded-page-size', newSize.toString());
            renderExpandedContent();
        }
        
        function expandedPageFirst() {
            expandedState.page = 0;
            renderExpandedContent();
        }
        
        function expandedPagePrev() {
            expandedState.page = Math.max(0, expandedState.page - 1);
            renderExpandedContent();
        }
        
        function expandedPageNext() {
            const items = getFilteredExpandedItems();
            const totalPages = Math.ceil(items.length / expandedState.pageSize);
            expandedState.page = Math.min(totalPages - 1, expandedState.page + 1);
            renderExpandedContent();
        }
        
        function expandedPageLast() {
            const items = getFilteredExpandedItems();
            const totalPages = Math.ceil(items.length / expandedState.pageSize);
            expandedState.page = totalPages - 1;
            renderExpandedContent();
        }
        
        function showInterventionFromExpanded(source, id, type) {
            closeExpandedPanel();
            // Trigger the intervention modal
            if (typeof showIntervention === 'function') {
                showIntervention(source, id, type);
            }
        }
    
        async function api(endpoint, method = 'GET', data = null) {
            const opts = { method, headers: {'Content-Type': 'application/json'} };
            if (data) opts.body = JSON.stringify(data);
            const r = await fetch('/api/' + endpoint, opts);
            return r.json();
        }
        
        function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        function fmt(iso) { try { return new Date(iso).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); } catch { return ''; } }
        
        async function loadStatus() {
            const data = await api('status');
            const dots = document.getElementById('status-dots');
            let html = '';
            for (const [key, svc] of Object.entries(data.services || {})) {
                html += `<div class="dot"><span class="dot-ind ${svc.connected ? 'on' : 'off'}"></span>${svc.name}</div>`;
            }
            dots.innerHTML = html;
        }
        
        async function loadDashboard() {
            const data = await api('dashboard');
            if (data.scoreboard) {
                document.getElementById('finds-today').textContent = data.scoreboard.finds_today;
                document.getElementById('finds-total').textContent = data.scoreboard.finds_total;
                document.getElementById('api-used').textContent = data.scoreboard.api_hits_today;
                document.getElementById('api-limit').textContent = data.scoreboard.api_limit;
                
                // Finds breakdown for both cards
                if (data.scoreboard.finds_by_source) {
                    const sonarr = data.scoreboard.finds_by_source.sonarr || 0;
                    const radarr = data.scoreboard.finds_by_source.radarr || 0;
                    const breakdownText = `üì∫ ${sonarr} ‚Ä¢ üé¨ ${radarr}`;
                    
                    const todayBreakdown = document.getElementById('finds-today-breakdown');
                    const totalBreakdown = document.getElementById('finds-total-breakdown');
                    if (todayBreakdown) todayBreakdown.textContent = breakdownText;
                    if (totalBreakdown) totalBreakdown.textContent = breakdownText;
                }
                
                // Update status indicator
                updateStatusIndicator(data.scoreboard, data.scheduler);
            }
            
            // Apply global activity state from server
            if (data.activity) {
                applyActivityState(data.activity);
            }
            
            if (data.tiers) {
                // Update tier totals (missing + upgrades combined)
                const tiers = data.tiers;
                document.getElementById('tier-hot').textContent = (tiers.hot?.total ?? 0).toLocaleString();
                document.getElementById('tier-warm').textContent = (tiers.warm?.total ?? 0).toLocaleString();
                document.getElementById('tier-cool').textContent = (tiers.cool?.total ?? 0).toLocaleString();
                document.getElementById('tier-cold').textContent = (tiers.cold?.total ?? 0).toLocaleString();
                
                // Update per-tier Missing/Upgrade breakdowns
                document.getElementById('tier-hot-missing').textContent = (tiers.hot?.total_missing ?? 0).toLocaleString();
                document.getElementById('tier-hot-upgrade').textContent = (tiers.hot?.total_upgrade ?? 0).toLocaleString();
                document.getElementById('tier-warm-missing').textContent = (tiers.warm?.total_missing ?? 0).toLocaleString();
                document.getElementById('tier-warm-upgrade').textContent = (tiers.warm?.total_upgrade ?? 0).toLocaleString();
                document.getElementById('tier-cool-missing').textContent = (tiers.cool?.total_missing ?? 0).toLocaleString();
                document.getElementById('tier-cool-upgrade').textContent = (tiers.cool?.total_upgrade ?? 0).toLocaleString();
                document.getElementById('tier-cold-missing').textContent = (tiers.cold?.total_missing ?? 0).toLocaleString();
                document.getElementById('tier-cold-upgrade').textContent = (tiers.cold?.total_upgrade ?? 0).toLocaleString();
                
                // Calculate totals for header label
                const totalMissing = (tiers.hot?.total_missing ?? 0) + (tiers.warm?.total_missing ?? 0) + 
                                    (tiers.cool?.total_missing ?? 0) + (tiers.cold?.total_missing ?? 0);
                const totalUpgrade = (tiers.hot?.total_upgrade ?? 0) + (tiers.warm?.total_upgrade ?? 0) + 
                                    (tiers.cool?.total_upgrade ?? 0) + (tiers.cold?.total_upgrade ?? 0);
                const grandTotal = totalMissing + totalUpgrade;
                
                const tierLabel = document.getElementById('tier-total-label');
                if (tierLabel) {
                    // Show loading indicator if still loading
                    if (data.loading) {
                        tierLabel.innerHTML = `<span style="color:var(--accent)">üìä ${data.loading_stage || 'Loading...'}</span>`;
                    } else {
                        tierLabel.textContent = `${grandTotal.toLocaleString()} total (üîç ${totalMissing.toLocaleString()} missing ‚Ä¢ ‚¨ÜÔ∏è ${totalUpgrade.toLocaleString()} upgrades)`;
                    }
                }
            }
            
            // If still loading, poll more frequently
            if (data.loading && !dashboardPolling) {
                dashboardPolling = setInterval(loadDashboard, 2000);
            } else if (!data.loading && dashboardPolling) {
                clearInterval(dashboardPolling);
                dashboardPolling = null;
            }
            
            // Track activity state for adaptive polling
            window.tfmActivityState = data.loading ? 'cataloging' : (data.activity?.status || 'idle');
        }
        
        let dashboardPolling = null;
        
        // Unified adaptive polling system
        // - During activity (searching/cataloging): fast polling (3-5 sec)
        // - When idle: slow polling (30-60 sec) to save resources
        let adaptivePollingInterval = null;
        let lastActivityState = 'idle';
        
        function startAdaptivePolling() {
            if (adaptivePollingInterval) return;
            
            adaptivePollingInterval = setInterval(() => {
                const state = window.tfmActivityState || 'idle';
                const isActive = state === 'searching' || state === 'cataloging';
                
                // State changed - adjust what we poll
                if (state !== lastActivityState) {
                    lastActivityState = state;
                    if (!isActive) {
                        // Became idle - do one final refresh of everything
                        loadSearches();
                        loadFinds();
                        loadQueue();
                    }
                }
                
                // During activity, poll frequently
                // When idle, this interval still runs but does nothing
                // (the slower setIntervals handle idle polling)
                if (isActive) {
                    loadSearches();
                    loadFinds();
                }
            }, 4000);  // 4 second interval during activity
        }
        
        function updateStatusIndicator(scoreboard, scheduler) {
            const card = document.getElementById('status-card');
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            
            const apiUsed = scoreboard.api_hits_today || 0;
            const apiLimit = scoreboard.api_limit || 0;
            const apiRemaining = apiLimit - apiUsed;
            
            // Check if API exhausted
            if (apiRemaining <= 0 && apiLimit > 0) {
                card.className = 'score-card status exhausted';
                indicator.textContent = 'üí§';
                // Calculate time until midnight reset
                const now = new Date();
                const midnight = new Date(now);
                midnight.setHours(24, 0, 0, 0);
                const hoursUntilReset = Math.ceil((midnight - now) / (1000 * 60 * 60));
                text.textContent = `Resets in ${hoursUntilReset}h`;
                // Note: Don't call updateActivityBar here - let server state control it
                return;
            }
            
            // Check scheduler for next run
            if (scheduler && scheduler.tasks) {
                const searchTask = scheduler.tasks.find(t => t.name === 'search_cycle');
                if (searchTask && searchTask.next_run) {
                    // next_run is in UTC - append Z if not present
                    let nextRunStr = searchTask.next_run;
                    if (!nextRunStr.endsWith('Z') && !nextRunStr.includes('+')) {
                        nextRunStr += 'Z';
                    }
                    const nextRun = new Date(nextRunStr);
                    const now = new Date();
                    const minsUntil = Math.max(0, Math.round((nextRun - now) / 60000));
                    
                    if (minsUntil <= 1) {
                        card.className = 'score-card status active';
                        indicator.textContent = 'üîç';
                        text.textContent = 'Searching...';
                        // Note: Don't call updateActivityBar - let server state control it
                    } else {
                        card.className = 'score-card status';
                        indicator.textContent = '‚è±Ô∏è';
                        text.textContent = `Next: ${minsUntil}m`;
                        // Note: Don't call updateActivityBar - let server state control it
                    }
                    return;
                }
            }
            
            // Default - active
            card.className = 'score-card status active';
            indicator.textContent = '‚úÖ';
            text.textContent = 'Active';
            // Note: Don't call updateActivityBar - let server state control it
        }
        
        function updateActivityBar(state, mainText, detail) {
            const bar = document.getElementById('activity-bar');
            const icon = document.getElementById('activity-icon');
            const text = document.getElementById('activity-text');
            const detailEl = document.getElementById('activity-detail');
            
            bar.className = 'activity-bar';
            
            switch(state) {
                case 'searching':
                    bar.classList.add('searching');
                    icon.textContent = 'üîç';
                    break;
                case 'finding':
                    bar.classList.add('finding');
                    icon.textContent = 'üéâ';
                    break;
                case 'cataloging':
                    bar.classList.add('searching');
                    icon.textContent = 'üìä';
                    break;
                case 'sleeping':
                    icon.textContent = 'üí§';
                    break;
                case 'checking':
                    icon.textContent = 'üì°';
                    break;
                case 'idle':
                default:
                    icon.textContent = '‚è≥';
                    break;
            }
            
            text.textContent = mainText || 'Idle';
            detailEl.textContent = detail || '';
        }
        
        function applyActivityState(activity) {
            // Apply global activity state from server
            if (!activity) return;
            
            let status = activity.status;
            let message = activity.message;
            let detail = activity.detail;
            
            // If idle and we have next_search time, show countdown
            if (status === 'idle' && activity.next_search) {
                let nextRunStr = activity.next_search;
                if (!nextRunStr.endsWith('Z') && !nextRunStr.includes('+')) {
                    nextRunStr += 'Z';
                }
                const nextRun = new Date(nextRunStr);
                const now = new Date();
                const minsUntil = Math.max(0, Math.round((nextRun - now) / 60000));
                
                if (minsUntil > 1) {
                    message = 'Waiting for next cycle';
                    detail = `Next search in ${minsUntil} minutes`;
                }
            }
            
            updateActivityBar(status, message, detail);
            
            // Track activity state for adaptive polling
            window.tfmActivityState = status;
            
            // Start adaptive polling if not already running
            if (typeof startAdaptivePolling === 'function') {
                startAdaptivePolling();
            }
        }
        
        let searchPolling = null;  // Keep for backwards compatibility but unused
        
        async function loadQueue() {
            const data = await api('queue');
            
            // Update stuck items
            const el = document.getElementById('stuck-list');
            document.getElementById('stuck-count').textContent = `${data.total_stuck || 0} items`;
            
            if (!data.stuck_items?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">‚úÖ</div><p>No stuck items</p></div>';
                paginationState.queue.items = [];
            } else {
                paginationState.queue.items = data.stuck_items.slice(0, MAX_ITEMS);
                paginationState.queue.page = 0;
                renderQueuePage();
            }
            
            // Update active downloads panel
            renderActiveDownloads(data);
        }
        
        // Store downloads data for filtering/sorting
        let downloadsData = [];
        let downloadsRefreshInterval = null;
        
        function renderActiveDownloads(data) {
            const panel = document.getElementById('downloads-panel');
            
            // Merge downloads from all sources
            downloadsData = [
                ...(data.active_downloads || []),
                ...(data.sabnzbd_downloads || [])
            ];
            
            // Make available for expanded panel
            window.lastDownloadsData = downloadsData;
            
            // Always show panel (even if empty, so filters are visible)
            panel.style.display = 'block';
            
            filterDownloads();
            
            // Start real-time refresh if downloads exist
            if (downloadsData.length > 0 && !downloadsRefreshInterval) {
                downloadsRefreshInterval = setInterval(refreshDownloads, 5000); // Every 5 seconds
            } else if (downloadsData.length === 0 && downloadsRefreshInterval) {
                clearInterval(downloadsRefreshInterval);
                downloadsRefreshInterval = null;
            }
        }
        
        async function refreshDownloads() {
            try {
                const data = await api('queue');
                downloadsData = [
                    ...(data.active_downloads || []),
                    ...(data.sabnzbd_downloads || [])
                ];
                filterDownloads();
                
                // Stop refreshing if nothing downloading
                if (downloadsData.length === 0 && downloadsRefreshInterval) {
                    clearInterval(downloadsRefreshInterval);
                    downloadsRefreshInterval = null;
                }
            } catch (e) {
                console.error('Downloads refresh failed:', e);
            }
        }
        
        function filterDownloads() {
            const el = document.getElementById('downloads-list');
            const filterText = (document.getElementById('downloads-filter-text')?.value || '').toLowerCase();
            const filterSource = document.getElementById('downloads-filter-source')?.value || '';
            const sortBy = document.getElementById('downloads-sort')?.value || 'progress-desc';
            
            // Filter
            let filtered = downloadsData.filter(item => {
                if (filterText && !item.title?.toLowerCase().includes(filterText)) return false;
                if (filterSource && item.source !== filterSource) return false;
                return true;
            });
            
            // Sort
            filtered.sort((a, b) => {
                switch (sortBy) {
                    case 'progress-desc':
                        return (b.progress || 0) - (a.progress || 0);
                    case 'progress-asc':
                        return (a.progress || 0) - (b.progress || 0);
                    case 'title-asc':
                        return (a.title || '').localeCompare(b.title || '');
                    case 'title-desc':
                        return (b.title || '').localeCompare(a.title || '');
                    case 'eta-asc':
                        return parseETA(a.timeleft) - parseETA(b.timeleft);
                    default:
                        return 0;
                }
            });
            
            document.getElementById('downloads-count').textContent = `${filtered.length} items`;
            
            if (!filtered.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üì≠</div><p>Nothing downloading</p></div>';
                return;
            }
            
            // Limit to 5 items for panel display
            const totalCount = filtered.length;
            const displayItems = filtered.slice(0, 5);
            const remaining = totalCount - 5;
            
            const expandHint = remaining > 0 ? `
                <div class="expand-hint" onclick="openExpandedPanel('downloads')">
                    üìã ${remaining} more item${remaining > 1 ? 's' : ''} ‚Äî click to expand
                </div>
            ` : '';
            
            el.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="col-source">Source</th>
                            <th class="col-title">Title</th>
                            <th class="col-progress">Progress</th>
                            <th class="col-status">Status</th>
                            <th class="col-time">ETA</th>
                            <th class="col-action">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${displayItems.map((item, idx) => {
                            const progress = Math.round(item.progress || 0);
                            const progressColor = progress > 75 ? 'var(--success)' : progress > 25 ? 'var(--warn)' : 'var(--accent)';
                            const eta = item.timeleft || '-';
                            const status = item.status || 'downloading';
                            const statusLower = status.toLowerCase();
                            const statusClass = statusLower === 'downloading' ? 'badge-success' : 
                                                statusLower === 'paused' ? 'badge-warn' : 'badge-sec';
                            
                            // Build item data for action modal
                            const itemData = JSON.stringify({
                                source: item.source,
                                title: item.title,
                                queue_id: item.queue_id || item.id,
                                instance: item.instance,
                                series_id: item.series_id,
                                episode_id: item.episode_id,
                                movie_id: item.movie_id
                            }).replace(/"/g, '&quot;');
                            
                            return `
                            <tr>
                                <td class="col-source">
                                    <span class="badge badge-${item.source}">${item.source}</span>
                                    ${item.instance ? `<small style="color:var(--text3);margin-left:4px">${esc(item.instance)}</small>` : ''}
                                </td>
                                <td class="col-title">
                                    <div class="title-main">${esc(item.title)}</div>
                                </td>
                                <td class="col-progress">
                                    <div style="display:flex;align-items:center;gap:8px">
                                        <div style="flex:1;height:6px;background:var(--bg);border-radius:3px;overflow:hidden">
                                            <div style="width:${progress}%;height:100%;background:${progressColor};transition:width 0.3s"></div>
                                        </div>
                                        <span style="font-size:11px;color:var(--text2)">${progress}%</span>
                                    </div>
                                </td>
                                <td class="col-status">
                                    <span class="badge ${statusClass}">${esc(status)}</span>
                                </td>
                                <td class="col-time">${esc(eta)}</td>
                                <td class="col-action">
                                    <button class="btn btn-sm btn-sec" onclick="showDownloadActions(${itemData})">Actions</button>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
                ${expandHint}
            `;
        }
        
        function parseETA(eta) {
            if (!eta || eta === '-') return 999999;
            // Parse formats like "1:23:45" or "23:45" or "45"
            const parts = eta.split(':').map(Number);
            if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
            if (parts.length === 2) return parts[0] * 60 + parts[1];
            return parts[0] || 999999;
        }
        
        function showDownloadActions(item) {
            const modal = document.getElementById('modal');
            
            // Determine the actual service for actions
            // SABnzbd downloads are managed through Sonarr/Radarr
            let serviceName, actionService;
            if (item.source === 'sabnzbd') {
                // SABnzbd is just the downloader - determine service from instance name or IDs
                // Check instance name for hints (e.g., "Sabnzbd Sonarr", "SAB Radarr")
                const instanceLower = (item.instance || '').toLowerCase();
                if (item.series_id || item.episode_id || instanceLower.includes('sonarr')) {
                    actionService = 'Sonarr';
                } else if (item.movie_id || instanceLower.includes('radarr')) {
                    actionService = 'Radarr';
                } else {
                    // Default guess based on content - TV shows usually have SxxExx pattern
                    actionService = /s\d{1,2}e\d{1,2}/i.test(item.title) ? 'Sonarr' : 'Radarr';
                }
                serviceName = `SABnzbd ‚Üí ${actionService}`;
            } else {
                serviceName = item.source === 'sonarr' ? 'Sonarr' : 'Radarr';
                actionService = serviceName;
            }
            
            document.getElementById('modal-title').innerHTML = `
                <span style="margin-right:8px">‚¨áÔ∏è</span>${esc(item.title)}
            `;
            
            document.getElementById('modal-desc').innerHTML = `
                <div style="margin-bottom:16px;padding:12px;background:var(--bg);border-radius:8px;border-left:3px solid var(--accent)">
                    <strong>Source:</strong> ${serviceName}${item.instance ? ` (${esc(item.instance)})` : ''}
                </div>
            `;
            
            document.getElementById('modal-details').innerHTML = `
                <div style="margin-bottom:16px">
                    <div style="font-weight:600;margin-bottom:8px">üí° Available Actions:</div>
                    <ul style="margin:0;padding-left:20px;color:var(--text2);font-size:13px;line-height:1.8">
                        <li>Remove from queue (cancel download)</li>
                        <li>Blocklist and search for another release</li>
                        <li>Open in ${actionService} for more options</li>
                    </ul>
                </div>
            `;
            
            // Store actionService in item for use by action functions
            item.actionService = actionService.toLowerCase();
            const itemStr = JSON.stringify(item).replace(/'/g, "\\'");
            
            document.getElementById('modal-actions').innerHTML = `
                <div class="modal-actions-grid">
                    <button class="btn btn-sm btn-pri modal-action-btn" onclick="downloadBlocklistRetry(${itemStr})">
                        <span>üîÑ</span><span>Blocklist & Retry</span>
                    </button>
                    <button class="btn btn-sm btn-sec modal-action-btn" onclick="downloadOpenIn(${itemStr})">
                        <span>üîó</span><span>Open in ${actionService}</span>
                    </button>
                    <button class="btn btn-sm btn-sec modal-action-btn" onclick="downloadRemove(${itemStr})">
                        <span>üóëÔ∏è</span><span>Remove Only</span>
                    </button>
                    <button class="btn btn-sm btn-sec modal-action-btn" onclick="closeModal()">
                        <span>‚ùå</span><span>Cancel</span>
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }
        
        async function downloadBlocklistRetry(item) {
            if (!confirm(`Blocklist "${item.title}" and search for another release?`)) return;
            closeModal();
            updateActivityBar('searching', 'Blocklisting: ' + item.title.substring(0, 30) + '...', 'Removing and searching for alternative...');
            
            try {
                // Use actionService if set, otherwise detect from source/instance
                let targetService = item.actionService || item.source;
                if (item.source === 'sabnzbd') {
                    const instanceLower = (item.instance || '').toLowerCase();
                    if (instanceLower.includes('sonarr') || /s\d{1,2}e\d{1,2}/i.test(item.title)) {
                        targetService = 'sonarr';
                    } else {
                        targetService = 'radarr';
                    }
                }
                
                const data = await api('resolve', 'POST', {
                    source: targetService,
                    queue_id: item.queue_id,
                    action: 'blocklist_retry'
                });
                updateActivityBar('idle', 'Blocklisted', data.message || 'Searching for alternative...');
                setTimeout(() => { loadQueue(); refreshDownloads(); }, 1500);
            } catch (e) {
                updateActivityBar('idle', 'Failed', e.message);
            }
        }
        
        async function downloadRemove(item) {
            if (!confirm(`Remove "${item.title}" from download queue?`)) return;
            closeModal();
            updateActivityBar('searching', 'Removing: ' + item.title.substring(0, 30) + '...', 'Canceling download...');
            
            try {
                // Use actionService if set, otherwise detect from source/instance
                let targetService = item.actionService || item.source;
                if (item.source === 'sabnzbd') {
                    const instanceLower = (item.instance || '').toLowerCase();
                    if (instanceLower.includes('sonarr') || /s\d{1,2}e\d{1,2}/i.test(item.title)) {
                        targetService = 'sonarr';
                    } else {
                        targetService = 'radarr';
                    }
                }
                
                const data = await api('resolve', 'POST', {
                    source: targetService,
                    queue_id: item.queue_id,
                    action: 'remove'
                });
                updateActivityBar('idle', 'Removed', data.message || 'Download canceled');
                setTimeout(() => { loadQueue(); refreshDownloads(); }, 1500);
            } catch (e) {
                updateActivityBar('idle', 'Failed', e.message);
            }
        }
        
        function downloadOpenIn(item) {
            closeModal();
            let url = '';
            const baseUrl = ''; // Would need instance URLs from config
            
            if (item.source === 'sonarr' && item.series_id) {
                // Try to open Sonarr series page
                updateActivityBar('idle', 'Open in Sonarr', 'Check your Sonarr queue');
            } else if (item.source === 'radarr' && item.movie_id) {
                updateActivityBar('idle', 'Open in Radarr', 'Check your Radarr queue');
            } else if (item.source === 'sabnzbd') {
                updateActivityBar('idle', 'Open SABnzbd', 'Check your SABnzbd queue');
            }
            
            // Use interventionOpenIn if available
            if (typeof interventionOpenIn === 'function') {
                interventionOpenIn(item.source, item.queue_id, item.instance);
            }
        }
        
        
        function renderQueuePage() {
            const el = document.getElementById('stuck-list');
            const state = paginationState.queue;
            const { pageItems, paginationHtml } = renderPagination('stuck-list', state, null);
            
            if (!pageItems.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">‚úÖ</div><p>No stuck items</p></div>';
                return;
            }
            
            el.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="col-time">Stuck</th>
                            <th class="col-source">Source</th>
                            <th class="col-title">Title</th>
                            <th class="col-issue">Issue</th>
                            <th class="col-action">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pageItems.map(item => {
                            const autoResolveHtml = item.can_auto_resolve 
                                ? (item.auto_resolve_in_minutes !== null && item.auto_resolve_in_minutes > 0
                                    ? `<span class="countdown ${item.auto_resolve_in_minutes <= 5 ? 'soon' : ''}">‚è±Ô∏è ${item.auto_resolve_in_minutes}m</span>`
                                    : '<span class="countdown soon">‚è±Ô∏è Now!</span>')
                                : '';
                            
                            // Show issues, or fall back to tracked_status/status
                            let issueText = item.issues && item.issues.length > 0 
                                ? item.issues.join(', ').replace(/_/g, ' ')
                                : item.tracked_status || item.status || 'downloading';
                            
                            return `
                            <tr>
                                <td class="col-time">${item.stuck_minutes}m</td>
                                <td class="col-source"><span class="badge badge-${item.source}">${item.source}</span></td>
                                <td class="col-title">
                                    <div class="title-main">${esc(item.title)}</div>
                                </td>
                                <td class="col-issue">
                                    <span class="badge badge-warn">${esc(issueText)}</span>
                                    ${item.can_auto_resolve ? '<span class="badge badge-success" style="margin-left:4px">Auto</span>' : ''}
                                    ${autoResolveHtml}
                                </td>
                                <td class="col-action">
                                    <button class="btn btn-sm btn-sec" onclick="showQueueIntervention(${JSON.stringify(item).replace(/"/g, '&quot;')})">Actions</button>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
                ${paginationHtml}
            `;
        }
        
        function showQueueIntervention(item) {
            // Convert queue item to intervention format and show modal
            const intervention = {
                source: item.source,
                id: item.queue_id,
                title: item.title,
                reason: item.status_messages?.join(', ') || 'Queue issue detected',
                intervention_type: 'queue_stuck',
                details: {
                    tier: 'unknown',
                    tier_emoji: '‚ö†Ô∏è',
                    age_days: Math.round((Date.now() - new Date(item.added || Date.now()).getTime()) / (1000 * 60 * 60 * 24)),
                    search_count: 0,
                    instance_name: item.instance_name,
                    queue_id: item.queue_id,
                    can_auto_resolve: item.can_auto_resolve,
                    status_messages: item.status_messages
                }
            };
            showQueueInterventionModal(intervention);
        }
        
        function showQueueInterventionModal(item) {
            const modal = document.getElementById('modal');
            const isMovie = item.source === 'radarr';
            const serviceName = isMovie ? 'Radarr' : 'Sonarr';
            
            // Generate smart suggestions based on the issue
            const suggestions = [];
            const issues = item.details?.status_messages || [item.reason];
            const issueText = issues.join(' ').toLowerCase();
            
            if (issueText.includes('no files') || issueText.includes('sample')) {
                suggestions.push('Release may only contain sample files - try a different release');
                suggestions.push('Check if other releases are available in ' + serviceName);
            }
            if (issueText.includes('import') || issueText.includes('failed')) {
                suggestions.push('Import failed - check file permissions and disk space');
                suggestions.push('Verify the download completed successfully');
            }
            if (issueText.includes('path') || issueText.includes('not valid')) {
                suggestions.push('Destination path may not exist or be accessible');
                suggestions.push('Check ' + serviceName + ' root folder settings');
            }
            if (issueText.includes('upgrade') || issueText.includes('not an upgrade')) {
                suggestions.push('File exists but doesn\'t meet quality cutoff');
                suggestions.push('May need to adjust quality profile settings');
            }
            
            // Default suggestions
            if (suggestions.length === 0) {
                suggestions.push('Try blocklisting this release and searching for another');
                suggestions.push('Check ' + serviceName + ' logs for more details');
            }
            suggestions.push('Open in ' + serviceName + ' for manual intervention');
            
            // Build modal content
            document.getElementById('modal-title').innerHTML = `
                <span style="margin-right:8px">‚ö†Ô∏è</span>${esc(item.title)}
            `;
            
            document.getElementById('modal-desc').innerHTML = `
                <div style="margin-bottom:16px;padding:12px;background:var(--bg);border-radius:8px;border-left:3px solid var(--warn)">
                    <strong>Issue:</strong> ${esc(item.reason)}
                </div>
            `;
            
            document.getElementById('modal-details').innerHTML = `
                <div style="margin-bottom:16px">
                    <div style="font-weight:600;margin-bottom:8px">üí° Suggestions:</div>
                    <ul style="margin:0;padding-left:20px;color:var(--text2);font-size:13px;line-height:1.8">
                        ${suggestions.map(s => '<li>' + esc(s) + '</li>').join('')}
                    </ul>
                </div>
            `;
            
            // Build action buttons
            const actions = [];
            
            // Blocklist & Retry (primary action)
            actions.push(`<button class="btn btn-sm btn-pri modal-action-btn" onclick="queueBlocklistRetry('${item.source}', ${item.details.queue_id}, '${esc(item.title).replace(/'/g, "\\'")}')"><span>üîÑ</span><span>Blocklist & Retry</span></button>`);
            
            // Search Now
            actions.push(`<button class="btn btn-sm btn-sec modal-action-btn" onclick="queueSearchNow('${item.source}', ${item.details.queue_id}, '${esc(item.title).replace(/'/g, "\\'")}')"><span>üîç</span><span>Search Now</span></button>`);
            
            // Open in Sonarr/Radarr  
            actions.push(`<button class="btn btn-sm btn-sec modal-action-btn" onclick="interventionOpenIn('${item.source}', ${item.details.queue_id}, '${item.details?.instance_name || ''}')"><span>üîó</span><span>Open in ${serviceName}</span></button>`);
            
            // Remove (no blocklist)
            actions.push(`<button class="btn btn-sm btn-sec modal-action-btn" onclick="queueRemove('${item.source}', ${item.details.queue_id}, '${esc(item.title).replace(/'/g, "\\'")}')"><span>üóëÔ∏è</span><span>Remove Only</span></button>`);
            
            document.getElementById('modal-actions').innerHTML = `
                <div class="modal-actions-grid">
                    ${actions.join('')}
                </div>
            `;
            
            modal.classList.add('show');
        }
        
        async function queueBlocklistRetry(source, queueId, title) {
            updateActivityBar('searching', 'Resolving: ' + title.substring(0, 30) + '...', 'Blocklisting and triggering retry...');
            const data = await api('resolve', 'POST', {source, queue_id: queueId, action: 'blocklist_retry'});
            if (data.success) {
                updateActivityBar('idle', 'Resolved: ' + title.substring(0, 30) + '...', data.message || 'Blocklisted and retry triggered');
            } else {
                updateActivityBar('idle', 'Failed to resolve', data.message || 'Check logs for details');
            }
            closeModal();
            setTimeout(() => loadQueue(), 1500);
        }
        
        async function queueSearchNow(source, queueId, title) {
            updateActivityBar('searching', 'Searching: ' + title.substring(0, 30) + '...', 'Manual search triggered');
            // First remove from queue, then search
            await api('resolve', 'POST', {source, queue_id: queueId, action: 'blocklist_retry'});
            updateActivityBar('idle', 'Search triggered', title);
            closeModal();
            setTimeout(() => loadQueue(), 1500);
        }
        
        async function queueRemove(source, queueId, title) {
            if (!confirm('Remove from queue WITHOUT blocklisting?\n\nThis release may be grabbed again.')) {
                return;
            }
            const data = await api('resolve', 'POST', {source, queue_id: queueId, action: 'remove'});
            if (data.success) {
                updateActivityBar('idle', 'Removed: ' + title.substring(0, 30) + '...', 'Removed from queue (not blocklisted)');
            } else {
                updateActivityBar('idle', 'Failed to remove', data.message || 'Check logs for details');
            }
            closeModal();
            setTimeout(() => loadQueue(), 1500);
        }
        
        async function loadInterventions() {
            const data = await api('interventions');
            const el = document.getElementById('intervention-list');
            
            // Show breakdown of urgent vs long-missing
            const urgentCount = data.urgent_count || 0;
            const longMissingCount = data.long_missing_count || 0;
            let countText = `${data.count || 0} items`;
            if (urgentCount > 0 && longMissingCount > 0) {
                countText = `${urgentCount} urgent, ${longMissingCount} long-missing`;
            } else if (urgentCount > 0) {
                countText = `${urgentCount} urgent`;
            } else if (longMissingCount > 0) {
                countText = `${longMissingCount} long-missing`;
            }
            document.getElementById('intervention-count').textContent = countText;
            
            if (!data.items?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üëç</div><p>No intervention needed</p></div>';
                paginationState.interventions.items = [];
                return;
            }
            
            paginationState.interventions.items = data.items.slice(0, MAX_ITEMS);
            paginationState.interventions.page = 0;
            renderInterventionsPage();
        }
        
        function renderInterventionsPage() {
            const el = document.getElementById('intervention-list');
            const state = paginationState.interventions;
            const { pageItems, paginationHtml } = renderPagination('intervention-list', state, null);
            
            if (!pageItems.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üëç</div><p>No intervention needed</p></div>';
                return;
            }
            
            el.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="col-type">Type</th>
                            <th class="col-source">Source</th>
                            <th class="col-title">Title</th>
                            <th class="col-issue">Why Intervention Needed</th>
                            <th class="col-action">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pageItems.map(item => {
                            const isUrgent = item.urgency === 'high';
                            const isLongMissing = item.intervention_type === 'long_missing';
                            const typeIcon = isLongMissing ? 'üìÖ' : (isUrgent ? 'üö®' : '‚ö†Ô∏è');
                            const typeBadge = isLongMissing ? 'badge-info' : 'badge-error';
                            const typeLabel = isLongMissing 
                                ? `${item.details?.months_missing || '?'}+ months` 
                                : 'Search Failed';
                            const tierInfo = item.details?.tier_emoji ? `${item.details.tier_emoji} ${item.details.tier}` : '';
                            
                            return `
                            <tr class="${isUrgent ? 'urgent-row' : ''}">
                                <td class="col-type">
                                    <span class="badge ${typeBadge}">${typeIcon} ${typeLabel}</span>
                                </td>
                                <td class="col-source"><span class="badge badge-${item.source}">${item.source}</span></td>
                                <td class="col-title">
                                    <div class="title-main">${esc(item.title)}</div>
                                    ${tierInfo ? '<div style="font-size:11px;color:var(--text3);margin-top:2px">' + tierInfo + '</div>' : ''}
                                </td>
                                <td class="col-issue">
                                    <div style="font-size:12px;color:var(--text2)">${esc(item.reason)}</div>
                                    ${item.details?.search_count ? '<div style="font-size:11px;color:var(--text3);margin-top:2px">Searched ' + item.details.search_count + ' times</div>' : ''}
                                </td>
                                <td class="col-action">
                                    <button class="btn btn-sm ${isUrgent ? 'btn-pri' : 'btn-sec'}" onclick="showIntervention(${JSON.stringify(item).replace(/"/g, '&quot;')})">Actions</button>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
                ${paginationHtml}
            `;
        }
        
        async function loadStorage() {
            const data = await api('storage');
            const el = document.getElementById('storage-list');
            
            if (!data.paths?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üíæ</div><p>No storage info available</p></div>';
                return;
            }
            
            // Group by unique free space value (same filesystem)
            const uniqueFS = {};
            data.paths.forEach(p => {
                const key = p.free_gb;
                if (!uniqueFS[key]) {
                    uniqueFS[key] = {
                        free_gb: p.free_gb,
                        paths: [],
                        tvPaths: 0,
                        moviePaths: 0
                    };
                }
                uniqueFS[key].paths.push(p.path);
                
                const pathLower = p.path.toLowerCase();
                if (pathLower.includes('/tv') || pathLower.includes('/series')) {
                    uniqueFS[key].tvPaths++;
                } else if (pathLower.includes('/movie')) {
                    uniqueFS[key].moviePaths++;
                }
            });
            
            const filesystems = Object.values(uniqueFS);
            
            // Display each unique filesystem
            el.innerHTML = filesystems.map(fs => {
                const freeGB = fs.free_gb;
                const freeTB = (freeGB / 1000).toFixed(1);
                const displayFree = freeGB >= 1000 ? `${freeTB} TB` : `${freeGB} GB`;
                
                // Determine what type of media
                let mediaType = '';
                if (fs.tvPaths > 0 && fs.moviePaths > 0) {
                    mediaType = 'üì∫ TV & üé¨ Movies';
                } else if (fs.tvPaths > 0) {
                    mediaType = 'üì∫ TV Shows';
                } else if (fs.moviePaths > 0) {
                    mediaType = 'üé¨ Movies';
                } else {
                    mediaType = 'üíæ Media';
                }
                
                // Status indicator
                const status = freeGB < 100 ? 'üî¥' : freeGB < 500 ? 'üü°' : 'üü¢';
                
                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border);">
                        <div>
                            <div style="font-weight: 500;">${status} ${mediaType}</div>
                            <div style="font-size: 11px; color: var(--text3); margin-top: 2px;">${fs.paths.length} folder(s)</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: 600;">${displayFree}</div>
                            <div style="font-size: 11px; color: var(--text3);">available</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function loadFinds() {
            const data = await api('finds?limit=500');
            const el = document.getElementById('finds-list');
            document.getElementById('finds-count').textContent = `${data.finds?.length || 0} items`;
            
            if (!data.finds?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><p>No finds yet - TFM is working on it!</p></div>';
                return;
            }
            
            // Store items (newest first)
            paginationState.finds.items = data.finds.reverse().slice(0, MAX_ITEMS);
            paginationState.finds.page = 0;
            renderFindsPage();
        }
        
        function renderFindsPage() {
            const el = document.getElementById('finds-list');
            const state = paginationState.finds;
            const { pageItems, paginationHtml } = renderPagination('finds-list', state, null);
            
            const typeLabels = {
                'auto': 'ü§ñ Auto',
                'manual': 'üñêÔ∏è Manual',
                'rss': 'üì° RSS',
                'search': 'üîé Search'
            };
            
            if (!pageItems.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><p>No finds yet</p></div>';
                return;
            }
            
            el.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="col-time">Time</th>
                            <th class="col-type">How Found</th>
                            <th class="col-source">Source</th>
                            <th class="col-title">Title</th>
                            <th class="col-issue">Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pageItems.map(f => `
                            <tr>
                                <td class="col-time">${fmt(f.timestamp)}</td>
                                <td class="col-type">${typeLabels[f.resolution_type] || '‚úÖ ' + f.resolution_type}</td>
                                <td class="col-source"><span class="badge badge-${f.source}">${f.source}</span></td>
                                <td class="col-title">
                                    <div class="title-main">${esc(f.title)}</div>
                                </td>
                                <td class="col-issue">${f.resolution_detail ? esc(f.resolution_detail) : '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${paginationHtml}
            `;
        }
        
        async function loadSearches() {
            console.log('[loadSearches] Fetching search history...');
            const data = await api('searches?limit=500');
            console.log('[loadSearches] Got response:', data.searches?.length || 0, 'items');
            const el = document.getElementById('search-list');
            
            if (!data.searches?.length) {
                console.log('[loadSearches] No searches found, showing empty state');
                el.innerHTML = '<div class="empty"><div class="empty-icon">‚è≥</div><p>No search activity yet</p></div>';
                return;
            }
            
            // Store items (newest first) and reset to page 0 on fresh load
            paginationState.searches.items = data.searches.reverse().slice(0, MAX_ITEMS);
            paginationState.searches.page = 0;
            console.log('[loadSearches] Rendering', paginationState.searches.items.length, 'items');
            renderSearchesPage();
        }
        
        function filterSearchActivity() {
            const textFilter = document.getElementById('search-filter-text').value.toLowerCase();
            const tierFilter = document.getElementById('search-filter-tier').value;
            const sourceFilter = document.getElementById('search-filter-source').value;
            
            // Re-filter from original items
            paginationState.searches.page = 0;
            renderSearchesPage(textFilter, tierFilter, sourceFilter);
        }
        
        function getLifecycleDisplay(s) {
            const state = s.lifecycle_state || 'searched';
            const stateMap = {
                'searching': { label: 'üîÑ Searching', class: 'searching' },
                'searched': { label: 'üîç Searched', class: 'cooldown' },
                'cooldown': { label: `‚è≥ Cooldown ${s.cooldown_minutes ? Math.round(s.cooldown_minutes/60) + 'h' : ''}`, class: 'cooldown' },
                'escalating': { label: `‚ö†Ô∏è Escalating (${s.attempt_number}/${s.max_attempts})`, class: 'escalating' },
                'needs_attention': { label: 'üñêÔ∏è Needs Attention', class: 'needs_attention' },
                'found': { label: '‚úÖ Found!', class: 'found' },
                'error': { label: '‚ùå Error', class: 'error' },
            };
            const display = stateMap[state] || stateMap['searched'];
            return `<span class="lifecycle-state ${display.class}">${display.label}</span>`;
        }
        
        function renderSearchesPage(textFilter = '', tierFilter = '', sourceFilter = '') {
            const el = document.getElementById('search-list');
            let items = paginationState.searches.items;
            
            // Apply filters
            if (textFilter || tierFilter || sourceFilter) {
                items = items.filter(s => {
                    if (textFilter && !s.title.toLowerCase().includes(textFilter)) return false;
                    if (tierFilter && s.tier !== tierFilter) return false;
                    if (sourceFilter && s.source !== sourceFilter) return false;
                    return true;
                });
            }
            
            const state = { ...paginationState.searches, items };
            const { pageItems, paginationHtml } = renderPagination('search-list', state, null);
            
            if (!pageItems.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><p>No matching search activity</p></div>';
                return;
            }
            
            el.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="col-time" style="cursor:pointer" onclick="sortSearches('timestamp')">Time</th>
                            <th class="col-source">Source</th>
                            <th class="col-title" style="cursor:pointer" onclick="sortSearches('title')">Title</th>
                            <th class="col-episode">Episode</th>
                            <th class="col-tier" style="cursor:pointer" onclick="sortSearches('tier')">Tier</th>
                            <th class="col-status">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pageItems.map(s => {
                            const episodeCode = s.formatted_code || '-';
                            const yearMatch = s.title.match(/\((\d{4})\)/);
                            const year = yearMatch ? yearMatch[1] : '';
                            return `
                            <tr>
                                <td class="col-time">${fmt(s.timestamp)}</td>
                                <td class="col-source"><span class="badge badge-${s.source}">${s.source === 'sonarr' ? 'üì∫' : 'üé¨'} ${s.source}</span></td>
                                <td class="col-title">
                                    <div class="title-main">${esc(s.title)}</div>
                                    ${year ? `<div class="title-year" style="font-size:11px;color:var(--text3)">${year}</div>` : ''}
                                </td>
                                <td class="col-episode" style="font-family:monospace;font-size:12px">${episodeCode}</td>
                                <td class="col-tier"><span class="badge badge-${s.tier}">${s.tier_emoji} ${s.tier}</span></td>
                                <td class="col-status">${getLifecycleDisplay(s)}</td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
                ${paginationHtml}
            `;
        }
        
        let searchSortField = 'timestamp';
        let searchSortAsc = false;
        
        function sortSearches(field) {
            if (searchSortField === field) {
                searchSortAsc = !searchSortAsc;
            } else {
                searchSortField = field;
                searchSortAsc = true;
            }
            
            paginationState.searches.items.sort((a, b) => {
                let va = a[field] || '';
                let vb = b[field] || '';
                if (field === 'timestamp') {
                    va = new Date(va);
                    vb = new Date(vb);
                }
                if (va < vb) return searchSortAsc ? -1 : 1;
                if (va > vb) return searchSortAsc ? 1 : -1;
                return 0;
            });
            
            paginationState.searches.page = 0;
            filterSearchActivity();
        }
        
        async function loadLogs() {
            const level = document.getElementById('log-filter').value;
            const data = await api('logs?limit=100' + (level ? '&level=' + level : ''));
            const el = document.getElementById('log-list');
            
            if (!data.logs?.length) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">üìã</div><p>No logs</p></div>';
                return;
            }
            
            el.innerHTML = data.logs.reverse().map(l => `
                <div class="log">
                    <span class="log-time">${fmt(l.timestamp)}</span>
                    <span class="log-level ${l.level}">${l.level}</span>
                    ${esc(l.message)}
                </div>
            `).join('');
        }
        
        async function runSearch() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Searching...';
            
            // Server will set activity state, but show immediate feedback
            updateActivityBar('searching', 'Manual search triggered', 'Searching for missing content and upgrades...');
            
            const data = await api('search', 'POST', {type: 'cycle'});
            
            btn.disabled = false;
            btn.textContent = 'Search Now';
            
            // Reload dashboard to get server's activity state
            loadDashboard();
            loadSearches();
            
            alert(`Searched ${data.searched || 0} items`);
        }
        
        async function resolveItem(source, queueId) {
            const btn = event.target;
            const originalText = btn.textContent;
            const row = btn.closest('tr');
            const title = row ? row.querySelector('.col-title')?.textContent?.trim() : 'Item';
            
            btn.disabled = true;
            btn.textContent = '...';
            
            try {
                const data = await api('resolve', 'POST', {source, queue_id: queueId, action: 'blocklist_retry'});
                if (data.success) {
                    btn.textContent = '‚úì';
                    btn.style.background = 'var(--success)';
                    // Show brief success in activity bar
                    updateActivityBar('idle', `Resolved: ${title.substring(0, 30)}...`, data.message || 'Blocklisted and retry triggered');
                    setTimeout(() => loadQueue(), 1500);
                } else {
                    btn.textContent = '‚úó';
                    btn.style.background = 'var(--error)';
                    updateActivityBar('idle', `Failed to resolve`, data.message || 'Check logs for details');
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                        btn.disabled = false;
                    }, 3000);
                }
            } catch (e) {
                btn.textContent = '‚úó';
                btn.style.background = 'var(--error)';
                updateActivityBar('idle', 'Resolve error', e.message);
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.disabled = false;
                }, 3000);
            }
        }
        
        function showIntervention(item) {
            const modal = document.getElementById('modal');
            const isMovie = item.source === 'radarr';
            const isLongMissing = item.intervention_type === 'long_missing';
            const searchCount = item.details?.search_count || 0;
            const tier = item.details?.tier || 'unknown';
            const tierEmoji = item.details?.tier_emoji || '‚ùì';
            const monthsMissing = item.details?.months_missing;
            const ageDays = item.details?.age_days || 0;
            
            // Generate smart suggestions based on context
            const suggestions = [];
            
            if (isLongMissing) {
                // Long missing content suggestions
                if (isMovie) {
                    if (ageDays < 180) {
                        suggestions.push('Movie may not be released digitally yet (theatrical only)');
                    }
                    suggestions.push('Check if movie exists on streaming services instead');
                    suggestions.push('Try adding to a different quality profile');
                } else {
                    suggestions.push('Series may be on hiatus or cancelled');
                    suggestions.push('Check if episodes are available on streaming only');
                }
                suggestions.push('Consider removing if no longer wanted');
                if (monthsMissing && monthsMissing >= 6) {
                    suggestions.push('Content has been unavailable for ' + monthsMissing + '+ months - may never be released');
                }
            } else {
                // Search exhausted suggestions
                if (searchCount >= 10) {
                    suggestions.push('Multiple search attempts failed - content may be rare or unavailable');
                }
                if (isMovie) {
                    suggestions.push('Try searching manually in Radarr with different terms');
                    suggestions.push('Check if movie title matches release naming');
                    if (tier === 'hot') {
                        suggestions.push('New release - may not have quality releases yet');
                    }
                } else {
                    suggestions.push('Try searching manually in Sonarr');
                    suggestions.push('Check if episode aired (may be delayed)');
                }
                suggestions.push('Check indexer health - some may be returning errors');
                suggestions.push('Try adding to different quality profile');
            }
            
            // Build modal content
            document.getElementById('modal-title').innerHTML = `
                <span style="margin-right:8px">‚ö†Ô∏è</span>${esc(item.title)}
                <span style="float:right;font-size:14px;font-weight:normal;color:var(--text2)">${tierEmoji} ${tier} (${ageDays} days)</span>
            `;
            
            document.getElementById('modal-desc').innerHTML = `
                <div style="margin-bottom:16px;padding:12px;background:var(--bg);border-radius:8px;border-left:3px solid var(--warn)">
                    <strong>Issue:</strong> ${esc(item.reason)}
                    ${searchCount ? `<div style="font-size:12px;color:var(--text3);margin-top:4px">Searched ${searchCount} times</div>` : ''}
                </div>
            `;
            
            document.getElementById('modal-details').innerHTML = `
                <div style="margin-bottom:16px">
                    <div style="font-weight:600;margin-bottom:8px">üí° Suggestions:</div>
                    <ul style="margin:0;padding-left:20px;color:var(--text2);font-size:13px;line-height:1.8">
                        ${suggestions.map(s => '<li>' + esc(s) + '</li>').join('')}
                    </ul>
                </div>
            `;
            
            // Build action buttons
            const itemData = JSON.stringify(item).replace(/'/g, "\\'");
            const actions = [];
            
            // Search Now action
            actions.push(`<button class="btn btn-sm btn-pri" onclick="interventionSearchNow('${item.source}', ${item.id}, '${esc(item.title).replace(/'/g, "\\'")}')">üîç Search Now</button>`);
            
            // Delay action (reset cooldown)
            actions.push(`<button class="btn btn-sm btn-sec" onclick="interventionDelay('${item.source}', ${item.id}, 7, '${item.intervention_type}')">üìÖ Delay 7 Days</button>`);
            
            // Open in Sonarr/Radarr
            actions.push(`<button class="btn btn-sm btn-sec" onclick="interventionOpenIn('${item.source}', ${item.id}, '${item.details?.instance_name || ''}')">üîó Open in ${isMovie ? 'Radarr' : 'Sonarr'}</button>`);
            
            // Stop Searching (shows instructions, opens item page)
            actions.push(`<button class="btn btn-sm btn-sec" onclick="interventionStopSearching('${item.source}', ${item.id}, '${item.intervention_type}')" title="Learn how to unmonitor in ${isMovie ? 'Radarr' : 'Sonarr'}">üö´ Stop Searching</button>`);
            
            // Delete from service (with confirmation)
            actions.push(`<button class="btn btn-sm" style="background:var(--error);color:white" onclick="interventionDelete('${item.source}', ${item.id}, '${item.intervention_type}', '${esc(item.title).replace(/'/g, "\\'")}')" title="DELETE from ${isMovie ? 'Radarr' : 'Sonarr'}">üóëÔ∏è Delete</button>`);
            
            // Dismiss (just removes from TFM list)
            actions.push(`<button class="btn btn-sm btn-sec" onclick="dismissIntervention('${item.source}', ${item.id}, '${item.intervention_type}')" title="Hide from TFM only">üëÅÔ∏è Hide</button>`);
            
            document.getElementById('modal-actions').innerHTML = `
                <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end">
                    ${actions.join('')}
                </div>
            `;
            
            modal.classList.add('show');
        }
        
        async function interventionSearchNow(source, id, title) {
            updateActivityBar('searching', 'Searching: ' + title.substring(0, 30) + '...', 'Manual search triggered');
            const data = await api('search', 'POST', {type: 'single', source, id});
            if (data.success) {
                updateActivityBar('idle', 'Search triggered', title);
            } else {
                updateActivityBar('idle', 'Search failed', data.message || 'Unknown error');
            }
            closeModal();
            loadInterventions();
        }
        
        async function interventionDelay(source, id, days, type) {
            const data = await api('intervention/delay', 'POST', {source, id, days, type});
            if (data.success) {
                updateActivityBar('idle', 'Delayed ' + days + ' days', 'Item will be searched again later');
            }
            closeModal();
            loadInterventions();
        }
        
        async function interventionOpenIn(source, id, instanceName) {
            const data = await api('intervention/get_service_url', 'POST', {source, id, instance_name: instanceName});
            if (data.success && data.url) {
                window.open(data.url, '_blank');
            } else {
                alert('Could not get service URL: ' + (data.message || 'Unknown error'));
            }
        }
        
        async function interventionStopSearching(source, id, type) {
            const serviceName = source === 'radarr' ? 'Radarr' : 'Sonarr';
            const itemType = source === 'radarr' ? 'movie' : 'series';
            
            let instructions;
            if (source === 'radarr') {
                instructions = `To stop searching for this movie:\n\n` +
                    `1. Click OK to open the movie in Radarr\n` +
                    `2. Find the "Monitored" toggle (usually near the top)\n` +
                    `3. Click it to turn monitoring OFF\n\n` +
                    `This gives you full control and you can easily re-enable monitoring later if needed.`;
            } else {
                instructions = `To stop searching for this episode/series:\n\n` +
                    `1. Click OK to open the series in Sonarr\n` +
                    `2. To unmonitor the SERIES: Toggle "Monitored" near the top\n` +
                    `3. To unmonitor specific EPISODES: Click the episode and toggle its monitor status\n\n` +
                    `This gives you full control and you can easily re-enable monitoring later if needed.`;
            }
            
            if (!confirm(instructions)) {
                return;
            }
            
            // Open the item in Sonarr/Radarr
            const data = await api('intervention/get_service_url', 'POST', {source, id});
            if (data.success && data.url) {
                window.open(data.url, '_blank');
            } else {
                alert('Could not get service URL: ' + (data.message || 'Unknown error'));
            }
            closeModal();
        }
        
        async function interventionDelete(source, id, type, title) {
            const serviceName = source === 'radarr' ? 'Radarr' : 'Sonarr';
            const itemType = source === 'radarr' ? 'movie' : 'series';
            
            // First confirmation
            if (!confirm(`‚ö†Ô∏è DELETE "${title}" from ${serviceName}?\n\nThis will:\n- Remove the ${itemType} from ${serviceName}\n- Add to exclusion list (won't be re-added)\n\nFiles will NOT be deleted.`)) {
                return;
            }
            
            // Second confirmation for safety
            const deleteFiles = confirm(`Also DELETE the files from disk?\n\nClick OK to delete files\nClick Cancel to keep files`);
            
            if (deleteFiles) {
                // Triple confirm for file deletion
                if (!confirm(`üö® FINAL WARNING üö®\n\nYou are about to PERMANENTLY DELETE:\n"${title}"\n\nAND all associated files from disk.\n\nThis cannot be undone!\n\nAre you absolutely sure?`)) {
                    return;
                }
            }
            
            const data = await api('intervention/delete_from_service', 'POST', {source, id, type, delete_files: deleteFiles});
            if (data.success) {
                updateActivityBar('idle', 'Deleted', data.message);
            } else {
                alert('Failed to delete: ' + (data.message || 'Unknown error'));
            }
            closeModal();
            loadInterventions();
            loadDashboard(); // Refresh counts
        }
        
        async function dismissIntervention(source, id, type) {
            await api('intervention/dismiss', 'POST', {source, id, type});
            closeModal();
            loadInterventions();
        }
        
        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }
        
        async function openSettingsModal() {
            // Load current settings
            const data = await api('settings');
            if (data.search) {
                document.getElementById('settings-api-limit').value = data.search.daily_api_limit || 500;
                document.getElementById('settings-per-cycle').value = data.search.searches_per_cycle || 10;
                document.getElementById('settings-interval').value = data.search.cycle_interval_minutes || 30;
            }
            if (data.tiers) {
                // Hot
                document.getElementById('settings-hot-max').value = data.tiers.hot?.max_days || 90;
                document.getElementById('settings-hot-interval').value = data.tiers.hot?.interval_minutes || 60;
                // Warm
                document.getElementById('settings-warm-min').value = data.tiers.warm?.min_days || 90;
                document.getElementById('settings-warm-max').value = data.tiers.warm?.max_days || 365;
                document.getElementById('settings-warm-interval').value = data.tiers.warm?.interval_minutes || 360;
                // Cool
                document.getElementById('settings-cool-min').value = data.tiers.cool?.min_days || 365;
                document.getElementById('settings-cool-max').value = data.tiers.cool?.max_days || 1095;
                document.getElementById('settings-cool-interval').value = data.tiers.cool?.interval_minutes || 1440;
                // Cold
                document.getElementById('settings-cold-min').value = data.tiers.cold?.min_days || 1095;
                document.getElementById('settings-cold-interval').value = data.tiers.cold?.interval_minutes || 10080;
            }
            // Quiet hours
            if (data.quiet_hours) {
                const toggle = document.getElementById('settings-quiet-toggle');
                if (data.quiet_hours.enabled) {
                    toggle.classList.add('on');
                } else {
                    toggle.classList.remove('on');
                }
                document.getElementById('settings-quiet-start').value = data.quiet_hours.start_hour ?? 2;
                document.getElementById('settings-quiet-end').value = data.quiet_hours.end_hour ?? 7;
            }
            updateThemeButtons();
            updateSettingsPacingPresets();
            document.getElementById('settings-modal').classList.add('show');
        }
        
        function updateSettingsPacingPresets() {
            const apiLimit = parseInt(document.getElementById('settings-api-limit').value) || 500;
            const currentSearches = parseInt(document.getElementById('settings-per-cycle').value) || 10;
            const currentInterval = parseInt(document.getElementById('settings-interval').value) || 60;
            
            // Calculate presets based on API limit
            const steady = { searches: Math.round(apiLimit / 24), interval: 60, hours: 24 };
            const fast = { searches: Math.round(apiLimit / 12), interval: 60, hours: 12 };
            const faster = { searches: Math.round(apiLimit / 6), interval: 60, hours: 6 };
            const blazing = { searches: Math.round(apiLimit / 6), interval: 30, hours: 3 };
            
            const presets = [
                { name: 'Steady', emoji: 'üê¢', ...steady, recommended: true },
                { name: 'Fast', emoji: 'üêá', ...fast },
                { name: 'Faster', emoji: 'üöÄ', ...faster },
                { name: 'Blazing', emoji: '‚ö°', ...blazing }
            ];
            
            const container = document.getElementById('settings-pacing-presets');
            container.innerHTML = presets.map(p => {
                const isSelected = currentSearches === p.searches && currentInterval === p.interval;
                return `
                    <div onclick="applySettingsPacing(${p.searches}, ${p.interval})" 
                         style="background: var(--bg3); padding: 10px 8px; border-radius: 8px; cursor: pointer; 
                                border: 2px solid ${isSelected ? 'var(--accent)' : 'transparent'}; text-align: center;
                                transition: all 0.2s;">
                        <div style="font-size: 16px;">${p.emoji}</div>
                        <div style="font-weight: 500; font-size: 12px; margin: 2px 0;">${p.name}</div>
                        <div style="color: var(--text3); font-size: 10px;">${p.searches} / ${p.interval} min</div>
                        <div style="color: var(--text3); font-size: 10px;">${p.hours} hours</div>
                        ${p.recommended ? '<div style="color: var(--success); font-size: 9px; margin-top: 2px;">‚úì Recommended</div>' : ''}
                    </div>
                `;
            }).join('');
        }
        
        function applySettingsPacing(searches, interval) {
            document.getElementById('settings-per-cycle').value = searches;
            document.getElementById('settings-interval').value = interval;
            updateSettingsPacingPresets();
        }
        
        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('show');
        }
        
        async function saveSettings() {
            const settings = {
                search: {
                    daily_api_limit: parseInt(document.getElementById('settings-api-limit').value) || 500,
                    searches_per_cycle: parseInt(document.getElementById('settings-per-cycle').value) || 10,
                    cycle_interval_minutes: parseInt(document.getElementById('settings-interval').value) || 30
                },
                tiers: {
                    hot: {
                        min_days: 0,
                        max_days: parseInt(document.getElementById('settings-hot-max').value) || 90,
                        interval_minutes: parseInt(document.getElementById('settings-hot-interval').value) || 60
                    },
                    warm: {
                        min_days: parseInt(document.getElementById('settings-warm-min').value) || 90,
                        max_days: parseInt(document.getElementById('settings-warm-max').value) || 365,
                        interval_minutes: parseInt(document.getElementById('settings-warm-interval').value) || 360
                    },
                    cool: {
                        min_days: parseInt(document.getElementById('settings-cool-min').value) || 365,
                        max_days: parseInt(document.getElementById('settings-cool-max').value) || 1095,
                        interval_minutes: parseInt(document.getElementById('settings-cool-interval').value) || 1440
                    },
                    cold: {
                        min_days: parseInt(document.getElementById('settings-cold-min').value) || 1095,
                        max_days: null,
                        interval_minutes: parseInt(document.getElementById('settings-cold-interval').value) || 10080
                    }
                },
                quiet_hours: {
                    enabled: document.getElementById('settings-quiet-toggle').classList.contains('on'),
                    start_hour: parseInt(document.getElementById('settings-quiet-start').value) || 2,
                    end_hour: parseInt(document.getElementById('settings-quiet-end').value) || 7
                }
            };
            const result = await api('settings', 'POST', settings);
            if (result.success) {
                closeSettingsModal();
                loadDashboard(); // Refresh to show new limit
            } else {
                alert('Failed to save settings: ' + result.message);
            }
        }
        
        // Close modals when clicking outside
        document.getElementById('settings-modal').addEventListener('click', function(e) {
            if (e.target === this) closeSettingsModal();
        });
        
        // ============ Initialization System ============
        const initState = {
            startTime: Date.now(),
            dismissed: false,
            maxTime: 60000  // 60 second max
        };
        
        function updateInitStep(step, status) {
            const el = document.getElementById(`init-step-${step}`);
            if (!el) return;
            
            const icon = el.querySelector('.init-step-icon');
            el.classList.remove('active', 'done');
            
            if (status === 'active') {
                el.classList.add('active');
                icon.textContent = 'üîÑ';
            } else if (status === 'done') {
                el.classList.add('done');
                icon.textContent = '‚úì';
            } else if (status === 'skip') {
                el.classList.add('done');
                icon.textContent = '‚è≠Ô∏è';
            }
        }
        
        function hideInitOverlay() {
            if (initState.dismissed) return;
            initState.dismissed = true;
            
            const overlay = document.getElementById('init-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 500);
            }
        }
        
        async function initializeApp() {
            const overlay = document.getElementById('init-overlay');
            const statusEl = document.getElementById('init-status');
            const timerEl = document.getElementById('init-timer');
            const progressBar = document.getElementById('init-progress');
            
            // Quick check - try to load scoreboard first to see if data is ready
            try {
                const data = await api('scoreboard');
                
                // Check if services are connected
                const status = await api('status');
                let sonarrOk = false;
                let radarrOk = false;
                
                if (status.services) {
                    for (const [key, svc] of Object.entries(status.services)) {
                        if (key.startsWith('sonarr') && svc.connected) sonarrOk = true;
                        if (key.startsWith('radarr') && svc.connected) radarrOk = true;
                    }
                }
                
                if (!sonarrOk && !radarrOk) {
                    // No services connected - show warning overlay
                    if (statusEl) statusEl.textContent = 'No services connected - check settings';
                    if (progressBar) {
                        progressBar.style.width = '100%';
                        progressBar.style.background = 'var(--warn)';
                    }
                    updateInitStep('config', 'done');
                    updateInitStep('services', 'done');
                    
                    await new Promise(r => setTimeout(r, 2000));
                    hideInitOverlay();
                    
                    loadDashboard();
                    loadQueue();
                    loadFinds();
                    loadSearches();
                    loadLogs();
                    return;
                }
                
                // Services connected - populate scoreboard immediately
                if (data.scoreboard) {
                    document.getElementById('finds-today').textContent = data.scoreboard.finds_today || 0;
                    document.getElementById('finds-total').textContent = data.scoreboard.finds_total || 0;
                    document.getElementById('api-used').textContent = data.scoreboard.api_hits_today || 0;
                    document.getElementById('api-limit').textContent = data.scoreboard.api_limit || 500;
                    
                    if (data.scoreboard.finds_by_source) {
                        const sonarr = data.scoreboard.finds_by_source.sonarr || 0;
                        const radarr = data.scoreboard.finds_by_source.radarr || 0;
                        const breakdownText = `üì∫ ${sonarr} ‚Ä¢ üé¨ ${radarr}`;
                        const todayBreakdown = document.getElementById('finds-today-breakdown');
                        const totalBreakdown = document.getElementById('finds-total-breakdown');
                        if (todayBreakdown) todayBreakdown.textContent = breakdownText;
                        if (totalBreakdown) totalBreakdown.textContent = breakdownText;
                    }
                    
                    updateStatusIndicator(data.scoreboard, data.scheduler);
                }
                
                // Apply global activity state from server
                if (data.activity) {
                    applyActivityState(data.activity);
                }
                
                // Check if tier data is already cached (ready = true means no long init needed)
                const dataReady = data.ready === true;
                const cacheAge = data.cache_age || null;
                const cacheIsFresh = cacheAge !== null && cacheAge < 300; // Less than 5 minutes old
                
                if (dataReady && cacheIsFresh) {
                    // Data is cached and fresh - skip overlay entirely, just load everything
                    hideInitOverlay();
                    
                    loadStatus();
                    loadDashboard();
                    loadQueue();
                    loadInterventions();
                    loadFinds();
                    loadSearches();
                    loadLogs();
                    
                    // Check for version upgrade - auto-search after 10 seconds
                    checkVersionAndAutoSearch();
                    return;
                }
                
                // Data not cached or stale - need to do full init
                // But scoreboard is already populated, so hide overlay and load in background
                hideInitOverlay();
                
                loadStatus();
                loadDashboard();  // This will be slow but happens in background
                loadQueue();
                loadInterventions();
                loadFinds();
                loadSearches();
                loadLogs();
                
                // Check for version upgrade - this handles auto-search properly
                checkVersionAndAutoSearch();
                
            } catch (error) {
                // API error - show overlay with error
                console.error('Initialization error:', error);
                if (statusEl) statusEl.textContent = 'Error connecting - check settings';
                if (progressBar) {
                    progressBar.style.width = '100%';
                    progressBar.style.background = 'var(--error)';
                }
                
                await new Promise(r => setTimeout(r, 2000));
                hideInitOverlay();
                
                loadDashboard();
                loadQueue();
                loadFinds();
                loadSearches();
                loadLogs();
                
                // Check for new install or version upgrade - auto-search after 10 seconds
                checkVersionAndAutoSearch();
            }
        }
        
        const CURRENT_VERSION = '1.0.100e';
        const UPDATE_CHECK_INTERVAL = 6 * 60 * 60 * 1000; // Check every 6 hours
        const DISMISSED_UPDATE_KEY = 'tfm_dismissed_update';
        
        async function checkForUpdates() {
            // Check GitHub releases for newer version
            try {
                const response = await fetch('https://api.github.com/repos/egadgetboy/thefantasticmachinarr/releases/latest', {
                    headers: { 'Accept': 'application/vnd.github.v3+json' }
                });
                
                if (!response.ok) return;
                
                const release = await response.json();
                const latestVersion = release.tag_name.replace(/^v/, '');
                
                // Compare versions (simple string compare works for semver)
                if (isNewerVersion(latestVersion, CURRENT_VERSION)) {
                    const dismissed = localStorage.getItem(DISMISSED_UPDATE_KEY);
                    if (dismissed === latestVersion) return; // User dismissed this version
                    
                    showUpdateBanner(latestVersion);
                }
            } catch (e) {
                console.log('Update check failed:', e.message);
            }
        }
        
        function isNewerVersion(latest, current) {
            // Parse version strings (e.g., "1.0.96" -> [1, 0, 96])
            const latestParts = latest.split('.').map(Number);
            const currentParts = current.split('.').map(Number);
            
            for (let i = 0; i < Math.max(latestParts.length, currentParts.length); i++) {
                const l = latestParts[i] || 0;
                const c = currentParts[i] || 0;
                if (l > c) return true;
                if (l < c) return false;
            }
            return false;
        }
        
        function showUpdateBanner(version) {
            const banner = document.getElementById('update-banner');
            document.getElementById('latest-version').textContent = 'v' + version;
            banner.classList.add('visible');
        }
        
        function dismissUpdate() {
            const banner = document.getElementById('update-banner');
            const version = document.getElementById('latest-version').textContent.replace(/^v/, '');
            localStorage.setItem(DISMISSED_UPDATE_KEY, version);
            banner.classList.remove('visible');
        }
        
        // Check for updates on load and periodically
        setTimeout(checkForUpdates, 5000); // Check 5 seconds after load
        setInterval(checkForUpdates, UPDATE_CHECK_INTERVAL);
        
        async function checkVersionAndAutoSearch() {
            // Check with server if refresh/search should run
            // Server tracks this to prevent multiple devices from triggering
            try {
                const result = await api('version/check', 'POST', {version: CURRENT_VERSION});
                
                if (!result.should_auto_search) {
                    console.log('Version check: no action needed');
                    return;
                }
                
                const isFirstRun = !result.last_version;
                const reason = result.reason || `Upgraded to ${CURRENT_VERSION}`;
                console.log('Version action triggered:', reason, 'First run:', isFirstRun);
                
                if (isFirstRun) {
                    // First run - trigger actual search after countdown
                    updateActivityBar('cataloging', 'First run detected', 'Auto-search starting in 10 seconds...');
                    
                    let countdown = 10;
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        if (countdown > 0) {
                            updateActivityBar('cataloging', 'First run detected', `Auto-search starting in ${countdown} seconds...`);
                        }
                    }, 1000);
                    
                    setTimeout(async () => {
                        clearInterval(countdownInterval);
                        updateActivityBar('searching', 'First run search', 'Searching for missing content...');
                        
                        try {
                            const data = await api('search', 'POST', {type: 'cycle'});
                            updateActivityBar('idle', 'Initial search complete', `Searched ${data.searched || 0} items`);
                            loadDashboard();
                            loadSearches();
                            loadFinds();
                        } catch (e) {
                            updateActivityBar('idle', 'Initial search failed', e.message);
                        }
                    }, 10000);
                } else {
                    // Upgrade - refresh data and sync activity state
                    updateActivityBar('cataloging', reason, 'Syncing with Sonarr/Radarr...');
                    
                    // First, refresh activity state (active searches, commands)
                    try {
                        const activity = await api('activity/refresh', 'POST');
                        if (activity.active_searches && activity.active_searches.length > 0) {
                            updateActivityBar('searching', 
                                `${activity.active_searches.length} search(es) in progress`, 
                                'Synced from Sonarr/Radarr');
                        }
                        console.log('Activity refresh:', activity);
                    } catch (e) {
                        console.error('Activity refresh failed:', e);
                    }
                    
                    // Then refresh all panels to validate current state
                    await Promise.all([
                        loadDashboard(),
                        loadQueue(),
                        loadInterventions(),
                        loadFinds(),
                        loadSearches()
                    ]);
                    
                    // Only show idle if no active searches
                    const currentStatus = document.getElementById('activity-text')?.textContent || '';
                    if (!currentStatus.includes('search')) {
                        updateActivityBar('idle', 'Upgrade complete', 'Data synced with Sonarr/Radarr');
                    }
                }
                
            } catch (e) {
                console.error('Version check failed:', e);
            }
        }
        
        // Start initialization
        initializeApp();
        
        // Base polling intervals (idle state) - conservative for system resources
        // These run regardless, but are slow enough to not impact performance
        setTimeout(() => {
            setInterval(loadStatus, 30000);      // Status every 30s
            setInterval(loadDashboard, 60000);   // Dashboard every 60s
            setInterval(loadQueue, 120000);      // Queue every 2 min (when idle)
            setInterval(loadFinds, 120000);      // Finds every 2 min (when idle)
            setInterval(loadSearches, 120000);   // Searches every 2 min (when idle)
            setInterval(loadLogs, 60000);        // Logs every 60s
            
            // Start the adaptive polling system
            startAdaptivePolling();
        }, 5000);
    </script>
    <div class="version-footer">The Fantastic Machinarr v1.0.100e</div>
</body>
</html>
