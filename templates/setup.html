<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - The Fantastic Machinarr</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¨</text></svg>">
    <style>
        /* Theme Variables */
        :root {
            --transition: 0.2s ease;
        }
        
        [data-theme="dark"] {
            --bg: #0c0f1a;
            --bg2: #151928;
            --bg3: #1e2538;
            --bg-hover: #252d42;
            --text: #f0f2f5;
            --text2: #8b92a5;
            --text3: #5c6478;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --success: #10b981;
            --success-bg: rgba(16, 185, 129, 0.1);
            --warn: #f59e0b;
            --warn-bg: rgba(245, 158, 11, 0.1);
            --error: #ef4444;
            --error-bg: rgba(239, 68, 68, 0.1);
            --border: #2a3246;
            --border-focus: #6366f1;
            --card-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            --glow: 0 0 20px rgba(99, 102, 241, 0.15);
        }
        
        [data-theme="light"] {
            --bg: #f8f9fb;
            --bg2: #ffffff;
            --bg3: #f0f1f4;
            --bg-hover: #e8e9ed;
            --text: #1a1d26;
            --text2: #5c6478;
            --text3: #8b92a5;
            --accent: #4f46e5;
            --accent-hover: #6366f1;
            --accent-glow: rgba(79, 70, 229, 0.2);
            --success: #059669;
            --success-bg: rgba(5, 150, 105, 0.1);
            --warn: #d97706;
            --warn-bg: rgba(217, 119, 6, 0.1);
            --error: #dc2626;
            --error-bg: rgba(220, 38, 38, 0.1);
            --border: #e2e4e9;
            --border-focus: #4f46e5;
            --card-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            --glow: 0 0 20px rgba(79, 70, 229, 0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh; /* Dynamic viewport height for mobile */
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            transition: background var(--transition), color var(--transition);
        }
        
        .wizard {
            background: var(--bg2);
            border-radius: 20px;
            width: 100%;
            max-width: 700px;
            max-height: calc(100vh - 32px);
            max-height: calc(100dvh - 32px);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            border: 1px solid var(--border);
            transition: all var(--transition);
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%);
            padding: 36px 32px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
            color: #fff;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 15px;
            color: rgba(255,255,255,0.9);
        }
        
        .theme-toggle {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            backdrop-filter: blur(10px);
            transition: all var(--transition);
        }
        
        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .steps {
            display: flex;
            justify-content: center;
            padding: 18px;
            gap: 10px;
            background: var(--bg3);
            border-bottom: 1px solid var(--border);
        }
        
        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s ease;
        }
        
        .step-dot.active {
            background: var(--accent);
            box-shadow: 0 0 12px var(--accent-glow);
            transform: scale(1.2);
        }
        
        .step-dot.done {
            background: var(--success);
        }
        
        .content {
            padding: 24px;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .content::-webkit-scrollbar {
            width: 6px;
        }
        
        .content::-webkit-scrollbar-track {
            background: var(--bg3);
            border-radius: 3px;
        }
        
        .content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        .step { display: none; animation: fadeIn 0.3s ease; }
        .step.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h2 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.3px;
        }
        
        h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            letter-spacing: -0.2px;
        }
        
        .desc {
            color: var(--text2);
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .svc {
            background: var(--bg3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            transition: all var(--transition);
        }
        
        .svc:hover {
            border-color: var(--accent);
            box-shadow: var(--glow);
        }
        
        .svc-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .svc-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }
        
        .svc-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .svc-icon.sonarr { background: linear-gradient(135deg, #00d4ff, #0099cc); }
        .svc-icon.radarr { background: linear-gradient(135deg, #ffc230, #ff9500); }
        .svc-icon.sabnzbd { background: linear-gradient(135deg, #f0a000, #cc7700); }
        
        .badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--bg2);
            color: var(--text2);
            font-weight: 500;
        }
        
        .toggle {
            width: 48px;
            height: 26px;
            background: var(--border);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: all var(--transition);
        }
        
        .toggle.on {
            background: var(--accent);
        }
        
        .toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle.on::after {
            transform: translateX(22px);
        }
        
        .fields { display: none; }
        .fields.show { display: block; }
        
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .field {
            margin-bottom: 16px;
        }
        
        .field label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
        }
        
        .field input, .field select {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            transition: all var(--transition);
        }
        
        .field input:focus, .field select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        .field input::placeholder {
            color: var(--text3);
        }
        
        .test-btn {
            width: 100%;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 10px;
            cursor: pointer;
            margin-top: 8px;
            font-weight: 500;
            transition: all var(--transition);
        }
        
        .test-btn:hover {
            border-color: var(--accent);
            background: var(--bg-hover);
        }
        
        .test-btn.ok {
            background: var(--success-bg);
            border-color: var(--success);
            color: var(--success);
        }
        
        .test-btn.fail {
            background: var(--error-bg);
            border-color: var(--error);
            color: var(--error);
        }
        
        .add-btn {
            width: 100%;
            padding: 14px;
            background: transparent;
            border: 2px dashed var(--border);
            border-radius: 12px;
            color: var(--text2);
            cursor: pointer;
            font-weight: 500;
            transition: all var(--transition);
        }
        
        .add-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-glow);
        }
        
        .remove {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 20px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all var(--transition);
        }
        
        .remove:hover {
            background: var(--error-bg);
        }
        
        .footer {
            display: flex;
            justify-content: space-between;
            padding: 20px 32px;
            border-top: 1px solid var(--border);
            background: var(--bg3);
        }
        
        .btn {
            padding: 12px 28px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all var(--transition);
        }
        
        .btn-sec {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-sec:hover {
            background: var(--bg-hover);
            border-color: var(--text3);
        }
        
        .btn-pri {
            background: var(--accent);
            color: #fff;
        }
        
        .btn-pri:hover {
            background: var(--accent-hover);
            box-shadow: 0 4px 12px var(--accent-glow);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .info {
            background: var(--accent-glow);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 16px;
            font-size: 13px;
            color: var(--text2);
            margin-top: 20px;
            line-height: 1.6;
        }
        
        .tiers {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 20px 0;
        }
        
        .tier {
            background: var(--bg3);
            padding: 16px 12px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all var(--transition);
        }
        
        .tier:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        
        .tier-emoji {
            font-size: 32px;
            margin-bottom: 4px;
        }
        
        .tier-name {
            font-weight: 600;
            margin: 6px 0;
            font-size: 14px;
        }
        
        .tier-desc {
            font-size: 11px;
            color: var(--text2);
        }
        
        .summary {
            background: var(--bg3);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        
        .sum-item {
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .sum-sub {
            margin-left: 28px;
            font-size: 13px;
            color: var(--text2);
            margin-top: 4px;
        }
        
        .check-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .check-row:last-child {
            border: none;
        }
        
        .check-row label {
            flex: 1;
            font-size: 14px;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--accent);
            cursor: pointer;
        }
        
        .version-footer {
            text-align: center;
            padding: 12px;
            font-size: 11px;
            color: var(--text3);
            border-top: 1px solid var(--border);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .wizard { border-radius: 16px; }
            .header { padding: 24px 20px; }
            .header h1 { font-size: 20px; }
            .content { padding: 20px; max-height: calc(100vh - 240px); }
            .tiers { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .tier { padding: 12px 8px; }
            .tier-emoji { font-size: 24px; }
            .tier-name { font-size: 13px; }
            .row { grid-template-columns: 1fr; }
            .footer { padding: 16px 20px; }
            .btn { padding: 10px 20px; font-size: 13px; }
            .info { padding: 12px; font-size: 12px; }
            .desc { font-size: 13px; }
        }
        
        @media (max-width: 480px) {
            .header h1 { font-size: 18px; }
            .header p { font-size: 13px; }
            .tiers { grid-template-columns: 1fr 1fr; gap: 8px; }
            .tier { padding: 10px 6px; }
            .tier-emoji { font-size: 22px; }
            .tier-name { font-size: 12px; }
            h2 { font-size: 18px; }
            h3 { font-size: 14px; }
        }
    </style>
</head>
<body>
<div class="wizard">
    <div class="header">
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">üåô</button>
        <h1>üé¨ The Fantastic Machinarr</h1>
        <p>Intelligent media library automation</p>
    </div>
    <div class="steps" id="steps"></div>
    <div class="content" id="content"></div>
    <div class="footer">
        <button class="btn btn-sec" id="backBtn" onclick="back()" disabled>Back</button>
        <button class="btn btn-pri" id="nextBtn" onclick="next()">Next</button>
    </div>
    <div class="version-footer">The Fantastic Machinarr v1.0.71</div>
</div>
<script>
// Theme management
function toggleTheme() {
    const html = document.documentElement;
    const current = html.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', next);
    localStorage.setItem('tfm-theme', next);
    document.querySelector('.theme-toggle').textContent = next === 'dark' ? 'üåô' : '‚òÄÔ∏è';
}

// Load saved theme
const savedTheme = localStorage.getItem('tfm-theme') || 'dark';
document.documentElement.setAttribute('data-theme', savedTheme);
document.querySelector('.theme-toggle').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
const STEPS = ['Welcome', 'Sonarr', 'Radarr', 'SABnzbd', 'Auto-Resolution', 'Settings', 'Complete'];
let step = 0;
const instances = { sonarr: [{id:1,on:true}], radarr: [{id:1,on:true}], sabnzbd: [{id:1,on:false}] };
let counters = { sonarr:1, radarr:1, sabnzbd:1 };
let baseUrl = '';
let existingConfig = null;

// Capture current form values into memory before navigation
function captureCurrentValues() {
    // Capture service instance values
    ['sonarr', 'radarr', 'sabnzbd'].forEach(svc => {
        instances[svc].forEach((inst, i) => {
            const id = inst.id;
            const urlEl = document.getElementById(`${svc}-${id}-url`);
            const keyEl = document.getElementById(`${svc}-${id}-key`);
            const nameEl = document.getElementById(`${svc}-${id}-name`);
            if (urlEl) inst.url = urlEl.value;
            if (keyEl) inst.api_key = keyEl.value;
            if (nameEl) inst.name = nameEl.value;
        });
    });
    
    // Capture base URL
    const baseUrlEl = document.getElementById('base-url');
    if (baseUrlEl && baseUrlEl.value) {
        baseUrl = baseUrlEl.value.replace(/\/+$/, '');
    }
    
    // Capture API limit and other welcome page values into existingConfig
    if (!existingConfig) existingConfig = {};
    
    const apiLimitEl = document.getElementById('api-limit');
    if (apiLimitEl) {
        if (!existingConfig.search) existingConfig.search = {};
        const newApiLimit = parseInt(apiLimitEl.value) || 500;
        const oldApiLimit = existingConfig.search.daily_api_limit;
        
        // If API limit changed, clear the search settings so they get recalculated
        if (oldApiLimit && newApiLimit !== oldApiLimit) {
            delete existingConfig.search.searches_per_cycle;
            delete existingConfig.search.cycle_interval_minutes;
        }
        
        existingConfig.search.daily_api_limit = newApiLimit;
    }
    
    // Capture tier settings
    const tierHotMax = document.getElementById('tier-hot-max');
    const tierHot = document.getElementById('tier-hot');
    const tierWarmMin = document.getElementById('tier-warm-min');
    const tierWarmMax = document.getElementById('tier-warm-max');
    const tierWarm = document.getElementById('tier-warm');
    const tierCoolMin = document.getElementById('tier-cool-min');
    const tierCoolMax = document.getElementById('tier-cool-max');
    const tierCool = document.getElementById('tier-cool');
    const tierColdMin = document.getElementById('tier-cold-min');
    const tierCold = document.getElementById('tier-cold');
    
    if (tierHotMax || tierWarmMin) {
        if (!existingConfig.tiers) existingConfig.tiers = {};
        if (tierHotMax) existingConfig.tiers.hot = { min_days: 0, max_days: parseInt(tierHotMax.value) || 90, interval_minutes: parseInt(tierHot?.value) || 60 };
        if (tierWarmMin) existingConfig.tiers.warm = { min_days: parseInt(tierWarmMin.value) || 90, max_days: parseInt(tierWarmMax?.value) || 365, interval_minutes: parseInt(tierWarm?.value) || 360 };
        if (tierCoolMin) existingConfig.tiers.cool = { min_days: parseInt(tierCoolMin.value) || 365, max_days: parseInt(tierCoolMax?.value) || 1095, interval_minutes: parseInt(tierCool?.value) || 1440 };
        if (tierColdMin) existingConfig.tiers.cold = { min_days: parseInt(tierColdMin.value) || 1095, max_days: null, interval_minutes: parseInt(tierCold?.value) || 10080 };
    }
    
    // Capture search pacing settings
    const perCycleEl = document.getElementById('set-per-cycle');
    const intervalEl = document.getElementById('set-interval');
    if (perCycleEl || intervalEl) {
        if (!existingConfig.search) existingConfig.search = {};
        if (perCycleEl) existingConfig.search.searches_per_cycle = parseInt(perCycleEl.value) || 10;
        if (intervalEl) existingConfig.search.cycle_interval_minutes = parseInt(intervalEl.value) || 30;
    }
    
    // Capture quiet hours
    const quietToggle = document.getElementById('quiet-toggle');
    const quietStart = document.getElementById('quiet-start');
    const quietEnd = document.getElementById('quiet-end');
    if (quietToggle || quietStart) {
        existingConfig.quiet_hours = {
            enabled: quietToggle?.classList.contains('on') || false,
            start_hour: parseInt(quietStart?.value) ?? 2,
            end_hour: parseInt(quietEnd?.value) ?? 7
        };
    }
    
    // Capture auto-resolution settings
    const arNoFiles = document.getElementById('ar-no_files_found');
    if (arNoFiles) {
        existingConfig.auto_resolution = {
            enabled: true,
            no_files_found: document.getElementById('ar-no_files_found')?.checked ?? true,
            sample_only: document.getElementById('ar-sample_only')?.checked ?? true,
            unknown_series: document.getElementById('ar-unknown_series')?.checked ?? true,
            unexpected_episode: document.getElementById('ar-unexpected_episode')?.checked ?? true,
            invalid_season_episode: document.getElementById('ar-invalid_season_episode')?.checked ?? true,
            no_audio_tracks: document.getElementById('ar-no_audio_tracks')?.checked ?? true,
            import_failed: document.getElementById('ar-import_failed')?.checked ?? true,
            download_failed: document.getElementById('ar-download_failed')?.checked ?? true,
            path_not_valid: document.getElementById('ar-path_not_valid')?.checked ?? false,
            wait_minutes_before_action: parseInt(document.getElementById('ar-wait')?.value) || 30
        };
    }
    
    // Capture email settings
    const emailHost = document.getElementById('email-host');
    if (emailHost) {
        existingConfig.email = {
            enabled: !!emailHost.value,
            smtp_host: emailHost.value || '',
            smtp_port: parseInt(document.getElementById('email-port')?.value) || 587,
            smtp_user: document.getElementById('email-user')?.value || '',
            smtp_password: document.getElementById('email-pass')?.value || '',
            smtp_tls: true,
            from_address: document.getElementById('email-from')?.value || '',
            to_address: document.getElementById('email-to')?.value || ''
        };
    }
}

// Load existing config if available
async function loadExistingConfig() {
    try {
        const r = await fetch('/api/config');
        const cfg = await r.json();
        // Load config even if setup not complete (for partial saves during wizard)
        if (cfg && Object.keys(cfg).length > 0) {
            existingConfig = cfg;
            
            // Restore instances from config
            if (cfg.sonarr_instances?.length) {
                instances.sonarr = cfg.sonarr_instances.map((inst, i) => ({id: i+1, on: inst.enabled !== false, ...inst}));
                counters.sonarr = instances.sonarr.length;
            }
            if (cfg.radarr_instances?.length) {
                instances.radarr = cfg.radarr_instances.map((inst, i) => ({id: i+1, on: inst.enabled !== false, ...inst}));
                counters.radarr = instances.radarr.length;
            }
            if (cfg.sabnzbd_instances?.length) {
                instances.sabnzbd = cfg.sabnzbd_instances.map((inst, i) => ({id: i+1, on: inst.enabled !== false, ...inst}));
                counters.sabnzbd = instances.sabnzbd.length;
            } else if (!cfg.sabnzbd_instances) {
                instances.sabnzbd = [{id:1, on:false}];
            }
            
            // Try to extract base URL from first sonarr instance
            if (cfg.sonarr_instances?.[0]?.url) {
                const url = cfg.sonarr_instances[0].url;
                const match = url.match(/^(https?:\/\/[^:\/]+)/);
                if (match) baseUrl = match[1];
            }
        }
    } catch(e) {
        console.log('No existing config found');
    }
}

// Apply existing config values to form fields after render
function applyExistingConfig() {
    if (!existingConfig) return;
    const cfg = existingConfig;
    
    // Welcome page
    if (document.getElementById('base-url') && baseUrl) {
        document.getElementById('base-url').value = baseUrl;
    }
    if (document.getElementById('api-limit') && cfg.search?.daily_api_limit) {
        document.getElementById('api-limit').value = cfg.search.daily_api_limit;
    }
    
    // Tier config
    if (cfg.tiers) {
        if (document.getElementById('tier-hot-max')) document.getElementById('tier-hot-max').value = cfg.tiers.hot?.max_days || 90;
        if (document.getElementById('tier-hot')) document.getElementById('tier-hot').value = cfg.tiers.hot?.interval_minutes || 60;
        if (document.getElementById('tier-warm-min')) document.getElementById('tier-warm-min').value = cfg.tiers.warm?.min_days || 90;
        if (document.getElementById('tier-warm-max')) document.getElementById('tier-warm-max').value = cfg.tiers.warm?.max_days || 365;
        if (document.getElementById('tier-warm')) document.getElementById('tier-warm').value = cfg.tiers.warm?.interval_minutes || 360;
        if (document.getElementById('tier-cool-min')) document.getElementById('tier-cool-min').value = cfg.tiers.cool?.min_days || 365;
        if (document.getElementById('tier-cool-max')) document.getElementById('tier-cool-max').value = cfg.tiers.cool?.max_days || 1095;
        if (document.getElementById('tier-cool')) document.getElementById('tier-cool').value = cfg.tiers.cool?.interval_minutes || 1440;
        if (document.getElementById('tier-cold-min')) document.getElementById('tier-cold-min').value = cfg.tiers.cold?.min_days || 1095;
        if (document.getElementById('tier-cold')) document.getElementById('tier-cold').value = cfg.tiers.cold?.interval_minutes || 10080;
    }
    
    // Service instances - populate URL/key fields
    ['sonarr', 'radarr', 'sabnzbd'].forEach(svc => {
        const cfgInstances = cfg[svc + '_instances'] || [];
        cfgInstances.forEach((inst, i) => {
            const id = i + 1;
            const urlEl = document.getElementById(`${svc}-${id}-url`);
            const keyEl = document.getElementById(`${svc}-${id}-key`);
            const nameEl = document.getElementById(`${svc}-${id}-name`);
            if (urlEl) urlEl.value = inst.url || '';
            if (keyEl) keyEl.value = inst.api_key || '';
            if (nameEl) nameEl.value = inst.name || '';
        });
    });
    
    // Auto-resolution
    if (cfg.auto_resolution) {
        const ar = cfg.auto_resolution;
        if (document.getElementById('ar-no_files_found')) document.getElementById('ar-no_files_found').checked = ar.no_files_found !== false;
        if (document.getElementById('ar-sample_only')) document.getElementById('ar-sample_only').checked = ar.sample_only !== false;
        if (document.getElementById('ar-unknown_series')) document.getElementById('ar-unknown_series').checked = ar.unknown_series !== false;
        if (document.getElementById('ar-unexpected_episode')) document.getElementById('ar-unexpected_episode').checked = ar.unexpected_episode !== false;
        if (document.getElementById('ar-invalid_season_episode')) document.getElementById('ar-invalid_season_episode').checked = ar.invalid_season_episode !== false;
        if (document.getElementById('ar-no_audio_tracks')) document.getElementById('ar-no_audio_tracks').checked = ar.no_audio_tracks !== false;
        if (document.getElementById('ar-import_failed')) document.getElementById('ar-import_failed').checked = ar.import_failed !== false;
        if (document.getElementById('ar-download_failed')) document.getElementById('ar-download_failed').checked = ar.download_failed !== false;
        if (document.getElementById('ar-path_not_valid')) document.getElementById('ar-path_not_valid').checked = ar.path_not_valid === true;
        if (document.getElementById('ar-wait')) document.getElementById('ar-wait').value = ar.wait_minutes_before_action || 30;
    }
    
    // Search settings - DO NOT apply saved values here
    // stepSettings() calculates defaults based on API limit
    // Just update the calculation display
    if (document.getElementById('set-per-cycle')) {
        if (typeof updatePacingCalc === 'function') updatePacingCalc();
    }
    
    // Quiet hours
    if (cfg.quiet_hours) {
        if (document.getElementById('quiet-toggle') && cfg.quiet_hours.enabled) {
            document.getElementById('quiet-toggle').classList.add('on');
        }
        if (document.getElementById('quiet-start')) document.getElementById('quiet-start').value = cfg.quiet_hours.start_hour ?? 2;
        if (document.getElementById('quiet-end')) document.getElementById('quiet-end').value = cfg.quiet_hours.end_hour ?? 7;
    }
    
    // Email
    if (cfg.email) {
        if (document.getElementById('email-host')) document.getElementById('email-host').value = cfg.email.smtp_host || '';
        if (document.getElementById('email-port')) document.getElementById('email-port').value = cfg.email.smtp_port || 587;
        if (document.getElementById('email-user')) document.getElementById('email-user').value = cfg.email.smtp_user || '';
        if (document.getElementById('email-pass')) document.getElementById('email-pass').value = cfg.email.smtp_password || '';
        if (document.getElementById('email-from')) document.getElementById('email-from').value = cfg.email.from_address || '';
        if (document.getElementById('email-to')) document.getElementById('email-to').value = cfg.email.to_address || '';
    }
}

function renderSteps() {
    document.getElementById('steps').innerHTML = STEPS.map((_, i) => 
        `<div class="step-dot ${i < step ? 'done' : i === step ? 'active' : ''}" data-step="${i}"></div>`
    ).join('');
}

function renderContent() {
    const c = document.getElementById('content');
    if (step === 0) c.innerHTML = stepWelcome();
    else if (step === 1) c.innerHTML = stepService('sonarr', 'üì∫', 'TV Shows');
    else if (step === 2) c.innerHTML = stepService('radarr', 'üé¨', 'Movies');
    else if (step === 3) c.innerHTML = stepService('sabnzbd', 'üì•', 'Downloads');
    else if (step === 4) c.innerHTML = stepAutoRes();
    else if (step === 5) c.innerHTML = stepSettings();
    else if (step === 6) c.innerHTML = stepComplete();
    
    document.getElementById('backBtn').disabled = step === 0;
    document.getElementById('nextBtn').textContent = step === STEPS.length - 1 ? 'Finish' : 'Next';
    
    // Apply existing config values after rendering
    applyExistingConfig();
}

function stepWelcome() {
    return `
    <div class="step active">
        <h2>üëã Welcome!</h2>
        <p class="desc">TFM continuously searches for missing content using a smart tier-based system ‚Äî prioritizing new releases while filling out your entire library in the background.</p>
        
        <div class="field" style="margin-top: 16px;">
            <label>üåê Server Base URL</label>
            <input type="text" id="base-url" placeholder="http://192.168.1.100" value="${baseUrl}" onchange="updateBaseUrl(this.value)">
            <div style="font-size: 11px; color: var(--text3); margin-top: 4px;">Used to prefill Sonarr, Radarr, and SABnzbd URLs</div>
        </div>
        
        <div class="field" style="margin-top: 16px;">
            <label>üìä Daily API Limit</label>
            <input type="number" id="api-limit" value="500" min="50" max="50000">
            <div style="font-size: 11px; color: var(--text3); margin-top: 4px;">
                <strong>Single indexer:</strong> Check your dashboard (common: 1000-5000/day)<br>
                <strong>Multiple:</strong> Add up limits + ~2000 per "unlimited" one. Adjust anytime in Settings.
            </div>
        </div>
        
        <h3 style="margin-top: 20px; margin-bottom: 6px;">üéØ Search Tiers</h3>
        <p class="desc" style="margin-bottom: 10px;">Define age ranges and search frequency. Hot = highest priority, searched most often.</p>
        
        <div class="tiers">
            <div class="tier">
                <div class="tier-emoji">üî•</div>
                <div class="tier-name">Hot</div>
                <div style="display: flex; gap: 4px; align-items: center; margin: 8px 0;">
                    <span style="font-size: 11px; color: var(--text3);">0 to</span>
                    <select id="tier-hot-max" style="flex:1; padding: 6px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 11px;">
                        <option value="7">7d</option>
                        <option value="14">14d</option>
                        <option value="30">1mo</option>
                        <option value="90" selected>3mo</option>
                        <option value="180">6mo</option>
                    </select>
                </div>
                <select id="tier-hot" style="width: 100%; padding: 8px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px;">
                    <option value="30">30 min</option>
                    <option value="60" selected>1 hour</option>
                    <option value="120">2 hours</option>
                    <option value="180">3 hours</option>
                </select>
                <input type="hidden" id="tier-hot-min" value="0">
            </div>
            <div class="tier">
                <div class="tier-emoji">‚òÄÔ∏è</div>
                <div class="tier-name">Warm</div>
                <div style="display: flex; gap: 4px; align-items: center; margin: 8px 0;">
                    <select id="tier-warm-min" style="flex:1; padding: 6px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 11px;">
                        <option value="90" selected>3mo</option>
                        <option value="180">6mo</option>
                    </select>
                    <span style="font-size: 11px; color: var(--text3);">to</span>
                    <select id="tier-warm-max" style="flex:1; padding: 6px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 11px;">
                        <option value="180">6mo</option>
                        <option value="365" selected>1yr</option>
                        <option value="730">2yr</option>
                    </select>
                </div>
                <select id="tier-warm" style="width: 100%; padding: 8px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px;">
                    <option value="180">3 hours</option>
                    <option value="360" selected>6 hours</option>
                    <option value="720">12 hours</option>
                    <option value="1440">Daily</option>
                </select>
            </div>
            <div class="tier">
                <div class="tier-emoji">‚ùÑÔ∏è</div>
                <div class="tier-name">Cool</div>
                <div style="display: flex; gap: 4px; align-items: center; margin: 8px 0;">
                    <select id="tier-cool-min" style="flex:1; padding: 6px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 11px;">
                        <option value="365" selected>1yr</option>
                        <option value="730">2yr</option>
                    </select>
                    <span style="font-size: 11px; color: var(--text3);">to</span>
                    <select id="tier-cool-max" style="flex:1; padding: 6px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 11px;">
                        <option value="730">2yr</option>
                        <option value="1095" selected>3yr</option>
                        <option value="1825">5yr</option>
                    </select>
                </div>
                <select id="tier-cool" style="width: 100%; padding: 8px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px;">
                    <option value="720">12 hours</option>
                    <option value="1440" selected>Daily</option>
                    <option value="2880">2 days</option>
                    <option value="4320">3 days</option>
                </select>
            </div>
            <div class="tier">
                <div class="tier-emoji">üßä</div>
                <div class="tier-name">Cold</div>
                <div style="display: flex; gap: 4px; align-items: center; margin: 8px 0;">
                    <select id="tier-cold-min" style="flex:1; padding: 6px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 11px;">
                        <option value="1095" selected>3yr</option>
                        <option value="1825">5yr</option>
                    </select>
                    <span style="font-size: 11px; color: var(--text3);">to ‚àû</span>
                </div>
                <select id="tier-cold" style="width: 100%; padding: 8px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px;">
                    <option value="4320">3 days</option>
                    <option value="10080" selected>Weekly</option>
                    <option value="20160">2 weeks</option>
                    <option value="43200">Monthly</option>
                </select>
            </div>
        </div>
        
        <div class="info" style="margin-top: 12px; padding: 12px; font-size: 12px;">
            <strong>üí° Tip:</strong> Age = when added to wanted list (new content) or release date (older content). Hot gets the most API calls.
        </div>
    </div>`;
}

function updateBaseUrl(val) {
    baseUrl = val.replace(/\/+$/, ''); // Remove trailing slashes
}

function getDefaultUrl(svc) {
    const ports = {sonarr:'8989', radarr:'7878', sabnzbd:'8080'};
    if (baseUrl) {
        return `${baseUrl}:${ports[svc]}`;
    }
    return '';
}

function stepService(svc, icon, desc) {
    const name = svc.charAt(0).toUpperCase() + svc.slice(1);
    const ports = {sonarr:'8989', radarr:'7878', sabnzbd:'8080'};
    const defaultUrl = getDefaultUrl(svc);
    let html = `<div class="step active"><h2>${icon} ${name}</h2><p class="desc">Configure your ${name} instance(s) for ${desc}.</p><div id="${svc}-list">`;
    
    instances[svc].forEach((inst, i) => {
        const badge = i === 0 ? 'Primary' : `Instance ${inst.id}`;
        // Use existing URL from config, or default URL if available, or empty
        const urlValue = inst.url || defaultUrl || '';
        const keyValue = inst.api_key || '';
        const nameValue = inst.name || '';
        html += `
        <div class="svc" data-id="${svc}-${inst.id}">
            <div class="svc-head">
                <div class="svc-title"><div class="svc-icon ${svc}">${icon}</div><span>${name}</span><span class="badge">${badge}</span></div>
                <div style="display:flex;gap:8px;align-items:center">
                    <div class="toggle ${inst.on?'on':''}" onclick="toggleSvc('${svc}',${inst.id},this)"></div>
                    ${i > 0 ? `<button class="remove" onclick="removeSvc('${svc}',${inst.id})">√ó</button>` : ''}
                </div>
            </div>
            <div class="fields ${inst.on?'show':''}" id="fields-${svc}-${inst.id}">
                <div class="row">
                    <div class="field"><label>URL</label><input type="text" id="${svc}-${inst.id}-url" placeholder="http://192.168.1.100:${ports[svc]}" value="${urlValue}"></div>
                    <div class="field"><label>API Key</label><input type="password" id="${svc}-${inst.id}-key" placeholder="Your API key" value="${keyValue}"></div>
                </div>
                <div class="field"><label>Name (optional)</label><input type="text" id="${svc}-${inst.id}-name" placeholder="e.g., ${name} 4K" value="${nameValue}"></div>
                <button class="test-btn" onclick="testSvc('${svc}',${inst.id},this)">Test Connection</button>
            </div>
        </div>`;
    });
    
    html += `</div><button class="add-btn" onclick="addSvc('${svc}')">+ Add Another ${name}</button>`;
    if (svc === 'sabnzbd') html += `<div class="info">üí° SABnzbd is optional. Skip if using a different download client.</div>`;
    html += `</div>`;
    return html;
}

function stepAutoRes() {
    return `
    <div class="step active">
        <h2>üîß Auto-Resolution Settings</h2>
        <p class="desc">Choose which stuck queue issues to resolve automatically.</p>
        <div class="svc">
            <div class="check-row"><label>üóëÔ∏è No files found / eligible for import</label><input type="checkbox" id="ar-no_files_found" checked></div>
            <div class="check-row"><label>üìΩÔ∏è File is a sample only</label><input type="checkbox" id="ar-sample_only" checked></div>
            <div class="check-row"><label>‚ùì Unknown series/movie</label><input type="checkbox" id="ar-unknown_series" checked></div>
            <div class="check-row"><label>‚ö†Ô∏è Unexpected episode</label><input type="checkbox" id="ar-unexpected_episode" checked></div>
            <div class="check-row"><label>üî¢ Invalid season/episode</label><input type="checkbox" id="ar-invalid_season_episode" checked></div>
            <div class="check-row"><label>üîá No audio tracks detected</label><input type="checkbox" id="ar-no_audio_tracks" checked></div>
            <div class="check-row"><label>‚ùå Import failed</label><input type="checkbox" id="ar-import_failed" checked></div>
            <div class="check-row"><label>üì• Download failed</label><input type="checkbox" id="ar-download_failed" checked></div>
            <div class="check-row"><label>üìÅ Path not valid (needs manual fix)</label><input type="checkbox" id="ar-path_not_valid"></div>
        </div>
        <div class="field" style="margin-top:16px">
            <label>Wait time before auto-resolving (minutes)</label>
            <input type="number" id="ar-wait" value="30" min="5" max="120">
        </div>
    </div>`;
}

function stepSettings() {
    // Get API limit from existingConfig (since the Welcome page DOM doesn't exist here)
    const apiLimit = existingConfig?.search?.daily_api_limit || parseInt(document.getElementById('api-limit')?.value) || 500;
    
    // Default: Spread API limit evenly over 24 hours with 60-minute intervals
    // searches_per_cycle = apiLimit / 24 (number of 60-min cycles in a day)
    const defaultInterval = 60;
    const defaultSearches = Math.round(apiLimit / 24);
    
    // Always use calculated defaults - this ensures settings match the API limit
    const searchesPerCycle = defaultSearches;
    const cycleInterval = defaultInterval;
    
    // Calculate how fast current settings burn the budget
    const callsPerHour = searchesPerCycle * (60 / cycleInterval);
    const dailyCalls = Math.round(callsPerHour * 24);
    const hoursToExhaust = Math.round(apiLimit / callsPerHour);
    
    // Aggressive presets - same total calls, burned faster
    // Aggressive 1: 2x speed (12 hours) - double searches, same interval
    const agg1Searches = defaultSearches * 2;
    const agg1Interval = defaultInterval;
    const agg1Hours = 12;
    
    // Aggressive 2: 4x speed (6 hours) - 4x searches, same interval
    const agg2Searches = defaultSearches * 4;
    const agg2Interval = defaultInterval;
    const agg2Hours = 6;
    
    // Aggressive 3: 8x speed (3 hours) - 4x searches, half interval
    const agg3Searches = defaultSearches * 4;
    const agg3Interval = 30;
    const agg3Hours = 3;
    
    return `
    <div class="step active">
        <h2>‚öôÔ∏è Search Pacing</h2>
        <p class="desc">Control how TFM uses your ${apiLimit.toLocaleString()} daily API calls.</p>
        
        <div class="info" style="margin: 0 0 16px; padding: 12px; font-size: 12px; background: var(--success-bg); border-color: var(--success);">
            <strong>üí° Recommendation:</strong> Start with <strong>Steady</strong> ‚Äî it spreads your API budget evenly over 24 hours for continuous searching. You can change this anytime in Settings.
        </div>
        
        <div style="background: var(--bg3); border-radius: 10px; padding: 14px; margin: 0 0 16px; font-size: 12px;">
            <div style="font-weight: 600; margin-bottom: 8px;">‚ö° Click To Choose Your Pacing</div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px;">
                <div class="preset-btn" style="background: var(--bg); padding: 10px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; text-align: center;" onclick="applyPacing(${defaultSearches}, ${defaultInterval})">
                    <div style="font-weight: 500; margin-bottom: 4px;">üê¢ Steady</div>
                    <div style="color: var(--text3); font-size: 11px;">${defaultSearches} / ${defaultInterval} min<br>24 hours</div>
                    <div style="color: var(--success); font-size: 10px; margin-top: 4px;">‚úì Recommended</div>
                </div>
                <div class="preset-btn" style="background: var(--bg); padding: 10px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; text-align: center;" onclick="applyPacing(${agg1Searches}, ${agg1Interval})">
                    <div style="font-weight: 500; margin-bottom: 4px;">üêá Fast</div>
                    <div style="color: var(--text3); font-size: 11px;">${agg1Searches} / ${agg1Interval} min<br>${agg1Hours} hours</div>
                </div>
                <div class="preset-btn" style="background: var(--bg); padding: 10px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; text-align: center;" onclick="applyPacing(${agg2Searches}, ${agg2Interval})">
                    <div style="font-weight: 500; margin-bottom: 4px;">üöÄ Faster</div>
                    <div style="color: var(--text3); font-size: 11px;">${agg2Searches} / ${agg2Interval} min<br>${agg2Hours} hours</div>
                </div>
                <div class="preset-btn" style="background: var(--bg); padding: 10px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; text-align: center;" onclick="applyPacing(${agg3Searches}, ${agg3Interval})">
                    <div style="font-weight: 500; margin-bottom: 4px;">‚ö° Blazing</div>
                    <div style="color: var(--text3); font-size: 11px;">${agg3Searches} / ${agg3Interval} min<br>${agg3Hours} hours</div>
                </div>
            </div>
            <div style="margin-top: 12px; padding: 10px; background: var(--bg); border-radius: 6px; font-size: 11px; color: var(--text2);">
                <strong>Why choose aggressive?</strong> Faster options burn through your daily API budget quickly ‚Äî great if you want intensive searching during certain hours, then let TFM rest. However, once the budget is exhausted, no more searches until the next day.
            </div>
        </div>
        
        <div class="row">
            <div class="field">
                <label>Searches Per Cycle</label>
                <input type="number" id="set-per-cycle" placeholder="Select a preset above" min="1" max="5000" autocomplete="off">
                <div style="font-size: 11px; color: var(--text3); margin-top: 4px;">
                    Items searched each cycle
                </div>
            </div>
            <div class="field">
                <label>Cycle Interval (minutes)</label>
                <input type="number" id="set-interval" placeholder="Select a preset above" min="5" max="360" autocomplete="off">
                <div style="font-size: 11px; color: var(--text3); margin-top: 4px;">
                    Time between cycles
                </div>
            </div>
        </div>
        
        <div id="pacing-calc" style="background: var(--bg3); border-radius: 8px; padding: 10px 14px; margin: 12px 0; font-size: 12px;">
            <strong>üìà With these settings:</strong> <span id="calc-result">Select a preset above</span>
        </div>
        
        <h3 style="margin: 20px 0 8px;">üò¥ Quiet Hours (Optional)</h3>
        <p class="desc" style="margin-bottom: 12px;">Pause searching during specific hours. Useful to reduce server load at night or concentrate API usage during peak hours.</p>
        
        <div class="svc" style="padding: 14px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-weight: 500;">Enable Quiet Hours</div>
                <div class="toggle" id="quiet-toggle" onclick="this.classList.toggle('on')"></div>
            </div>
            <div class="row" style="margin-bottom: 0;">
                <div class="field" style="margin-bottom: 0;">
                    <label>Start Time</label>
                    <select id="quiet-start" style="width: 100%; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                        ${Array.from({length: 24}, (_, i) => `<option value="${i}" ${i === 2 ? 'selected' : ''}>${i.toString().padStart(2, '0')}:00</option>`).join('')}
                    </select>
                </div>
                <div class="field" style="margin-bottom: 0;">
                    <label>End Time</label>
                    <select id="quiet-end" style="width: 100%; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                        ${Array.from({length: 24}, (_, i) => `<option value="${i}" ${i === 7 ? 'selected' : ''}>${i.toString().padStart(2, '0')}:00</option>`).join('')}
                    </select>
                </div>
            </div>
            <div style="font-size: 11px; color: var(--text3); margin-top: 8px;">TFM will pause all searching between these hours (server time).</div>
        </div>
        
        <h3 style="margin: 20px 0 8px;">üìß Email Notifications (Optional)</h3>
        <p class="desc" style="margin-bottom: 12px;">Get notified when TFM finds content or needs attention. Leave blank to skip.</p>
        <div class="row">
            <div class="field"><label>SMTP Host</label><input type="text" id="email-host" placeholder="smtp.gmail.com"></div>
            <div class="field"><label>SMTP Port</label><input type="number" id="email-port" value="587"></div>
        </div>
        <div class="row">
            <div class="field"><label>Username</label><input type="text" id="email-user" placeholder="your@email.com"></div>
            <div class="field"><label>Password</label><input type="password" id="email-pass" placeholder="App password"></div>
        </div>
        <div class="row">
            <div class="field"><label>From Address</label><input type="text" id="email-from" placeholder="tfm@yourdomain.com"></div>
            <div class="field"><label>To Address</label><input type="text" id="email-to" placeholder="you@example.com"></div>
        </div>
    </div>`;
}

function applyPacing(searches, interval) {
    document.getElementById('set-per-cycle').value = searches;
    document.getElementById('set-interval').value = interval;
    updatePacingCalc();
    
    // Highlight selected preset
    document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.style.border = '2px solid transparent';
    });
    event.currentTarget.style.border = '2px solid var(--accent)';
}

function updatePacingCalc() {
    const searches = parseInt(document.getElementById('set-per-cycle')?.value) || 10;
    const interval = parseInt(document.getElementById('set-interval')?.value) || 60;
    const apiLimit = existingConfig?.search?.daily_api_limit || parseInt(document.getElementById('api-limit')?.value) || 500;
    
    const callsPerHour = searches * (60 / interval);
    const hoursToExhaust = apiLimit / callsPerHour;
    const daysToExhaust = hoursToExhaust / 24;
    
    const el = document.getElementById('calc-result');
    if (el) {
        let message = '';
        if (hoursToExhaust <= 24) {
            // Burns within a day
            if (hoursToExhaust >= 1) {
                message = `${searches} searches every ${interval} min = budget lasts ~${Math.round(hoursToExhaust)} hours <span style="color: var(--warn);">Then TFM rests until tomorrow</span>`;
            } else {
                const minutes = Math.round(hoursToExhaust * 60);
                message = `${searches} searches every ${interval} min = budget lasts ~${minutes} minutes <span style="color: var(--warn);">Very aggressive!</span>`;
            }
        } else if (daysToExhaust <= 1.5) {
            // Close to 24 hours - this is the sweet spot
            message = `${searches} searches every ${interval} min = budget lasts ~24 hours <span style="color: var(--success);">‚úì Perfect daily spread</span>`;
        } else if (daysToExhaust <= 7) {
            // Under-utilizing but not by much
            message = `${searches} searches every ${interval} min = budget lasts ~${Math.round(daysToExhaust)} days <span style="color: var(--text3);">‚Äî Could search more often</span>`;
        } else {
            // Significantly under-utilizing
            message = `${searches} searches every ${interval} min = budget lasts ~${Math.round(daysToExhaust)} days <span style="color: var(--text3);">‚Äî You could search much more aggressively</span>`;
        }
        el.innerHTML = message;
    }
}

// Update calc when inputs change
document.addEventListener('input', function(e) {
    if (e.target.id === 'set-per-cycle' || e.target.id === 'set-interval') {
        updatePacingCalc();
    }
});

function stepComplete() {
    const cfg = gatherConfig();
    let html = `<div class="step active" style="text-align:center"><div style="font-size:64px">üéâ</div><h2>All Set!</h2><p class="desc">Your Fantastic Machinarr is ready.</p><div class="summary" style="text-align:left">`;
    
    ['sonarr','radarr','sabnzbd'].forEach(svc => {
        const icon = {sonarr:'üì∫', radarr:'üé¨', sabnzbd:'üì•'}[svc];
        const name = svc.charAt(0).toUpperCase() + svc.slice(1);
        const insts = cfg[svc + '_instances'];
        html += `<div class="sum-item">${icon} <strong>${name}:</strong> ${insts.length} instance(s)</div>`;
        insts.forEach(i => { html += `<div class="sum-sub">‚Ä¢ ${i.name || i.url}</div>`; });
    });
    
    html += `</div></div>`;
    return html;
}

function toggleSvc(svc, id, el) {
    el.classList.toggle('on');
    const on = el.classList.contains('on');
    document.getElementById(`fields-${svc}-${id}`).classList.toggle('show', on);
    const inst = instances[svc].find(i => i.id === id);
    if (inst) inst.on = on;
}

function addSvc(svc) {
    counters[svc]++;
    let defaultUrl = getDefaultUrl(svc);
    
    // For SABnzbd, increment port for additional instances
    if (svc === 'sabnzbd' && baseUrl && counters[svc] > 1) {
        const basePort = 8080;
        const newPort = basePort + (counters[svc] - 1);
        defaultUrl = `${baseUrl}:${newPort}`;
    }
    
    instances[svc].push({id: counters[svc], on: true, url: defaultUrl});
    renderContent();
}

function removeSvc(svc, id) {
    instances[svc] = instances[svc].filter(i => i.id !== id);
    renderContent();
}

async function testSvc(svc, id, btn) {
    const url = document.getElementById(`${svc}-${id}-url`).value;
    const key = document.getElementById(`${svc}-${id}-key`).value;
    if (!url || !key) { alert('Enter URL and API key'); return; }
    
    btn.textContent = 'Testing...';
    try {
        const r = await fetch(`/api/test/${svc}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url, api_key: key})
        });
        const data = await r.json();
        btn.textContent = data.success ? '‚úì Connected' : '‚úó Failed';
        btn.className = 'test-btn ' + (data.success ? 'ok' : 'fail');
    } catch(e) {
        btn.textContent = '‚úó Error';
        btn.className = 'test-btn fail';
    }
    setTimeout(() => { btn.textContent = 'Test Connection'; btn.className = 'test-btn'; }, 3000);
}

function gatherConfig() {
    const cfg = { sonarr_instances: [], radarr_instances: [], sabnzbd_instances: [] };
    
    ['sonarr','radarr','sabnzbd'].forEach(svc => {
        instances[svc].forEach(inst => {
            // Try DOM first, fall back to stored instance values
            const urlEl = document.getElementById(`${svc}-${inst.id}-url`);
            const keyEl = document.getElementById(`${svc}-${inst.id}-key`);
            const nameEl = document.getElementById(`${svc}-${inst.id}-name`);
            
            const url = urlEl ? urlEl.value : (inst.url || '');
            const key = keyEl ? keyEl.value : (inst.api_key || '');
            const name = nameEl ? nameEl.value : (inst.name || `${svc} ${inst.id}`);
            
            // Save all instances that have URL and key, regardless of enabled state
            if (url && key) {
                cfg[svc + '_instances'].push({ url, api_key: key, name, enabled: inst.on });
            }
        });
    });
    
    // Tier intervals and age ranges (in days)
    cfg.tiers = {
        hot: {
            min_days: parseInt(document.getElementById('tier-hot-min')?.value) || existingConfig?.tiers?.hot?.min_days || 0,
            max_days: parseInt(document.getElementById('tier-hot-max')?.value) || existingConfig?.tiers?.hot?.max_days || 90,
            interval_minutes: parseInt(document.getElementById('tier-hot')?.value) || existingConfig?.tiers?.hot?.interval_minutes || 60
        },
        warm: {
            min_days: parseInt(document.getElementById('tier-warm-min')?.value) || existingConfig?.tiers?.warm?.min_days || 90,
            max_days: parseInt(document.getElementById('tier-warm-max')?.value) || existingConfig?.tiers?.warm?.max_days || 365,
            interval_minutes: parseInt(document.getElementById('tier-warm')?.value) || existingConfig?.tiers?.warm?.interval_minutes || 360
        },
        cool: {
            min_days: parseInt(document.getElementById('tier-cool-min')?.value) || existingConfig?.tiers?.cool?.min_days || 365,
            max_days: parseInt(document.getElementById('tier-cool-max')?.value) || existingConfig?.tiers?.cool?.max_days || 1095,
            interval_minutes: parseInt(document.getElementById('tier-cool')?.value) || existingConfig?.tiers?.cool?.interval_minutes || 1440
        },
        cold: {
            min_days: parseInt(document.getElementById('tier-cold-min')?.value) || existingConfig?.tiers?.cold?.min_days || 1095,
            max_days: null, // No upper limit
            interval_minutes: parseInt(document.getElementById('tier-cold')?.value) || existingConfig?.tiers?.cold?.interval_minutes || 10080
        }
    };
    
    // Auto-resolution - use existingConfig values if DOM doesn't exist
    const arFromDom = document.getElementById('ar-no_files_found');
    const arFromCfg = existingConfig?.auto_resolution;
    cfg.auto_resolution = {
        enabled: true,
        no_files_found: arFromDom ? arFromDom.checked : (arFromCfg?.no_files_found ?? true),
        sample_only: document.getElementById('ar-sample_only')?.checked ?? arFromCfg?.sample_only ?? true,
        unknown_series: document.getElementById('ar-unknown_series')?.checked ?? arFromCfg?.unknown_series ?? true,
        unexpected_episode: document.getElementById('ar-unexpected_episode')?.checked ?? arFromCfg?.unexpected_episode ?? true,
        invalid_season_episode: document.getElementById('ar-invalid_season_episode')?.checked ?? arFromCfg?.invalid_season_episode ?? true,
        no_audio_tracks: document.getElementById('ar-no_audio_tracks')?.checked ?? arFromCfg?.no_audio_tracks ?? true,
        import_failed: document.getElementById('ar-import_failed')?.checked ?? arFromCfg?.import_failed ?? true,
        download_failed: document.getElementById('ar-download_failed')?.checked ?? arFromCfg?.download_failed ?? true,
        path_not_valid: document.getElementById('ar-path_not_valid')?.checked ?? arFromCfg?.path_not_valid ?? false,
        wait_minutes_before_action: parseInt(document.getElementById('ar-wait')?.value) || arFromCfg?.wait_minutes_before_action || 30,
    };
    
    // Search settings - API limit from welcome page, fall back to existingConfig
    const apiLimitEl = document.getElementById('api-limit');
    const perCycleEl = document.getElementById('set-per-cycle');
    const intervalEl = document.getElementById('set-interval');
    cfg.search = {
        enabled: true,
        daily_api_limit: apiLimitEl ? parseInt(apiLimitEl.value) : (existingConfig?.search?.daily_api_limit || 500),
        searches_per_cycle: perCycleEl ? parseInt(perCycleEl.value) : (existingConfig?.search?.searches_per_cycle || 10),
        cycle_interval_minutes: intervalEl ? parseInt(intervalEl.value) : (existingConfig?.search?.cycle_interval_minutes || 30),
    };
    
    // Quiet hours - fall back to existingConfig
    const quietToggle = document.getElementById('quiet-toggle');
    const quietStart = document.getElementById('quiet-start');
    const quietEnd = document.getElementById('quiet-end');
    cfg.quiet_hours = {
        enabled: quietToggle ? quietToggle.classList.contains('on') : (existingConfig?.quiet_hours?.enabled || false),
        start_hour: quietStart ? parseInt(quietStart.value) : (existingConfig?.quiet_hours?.start_hour ?? 2),
        end_hour: quietEnd ? parseInt(quietEnd.value) : (existingConfig?.quiet_hours?.end_hour ?? 7),
    };
    
    // Email - fall back to existingConfig
    const emailHostEl = document.getElementById('email-host');
    const emailHost = emailHostEl ? emailHostEl.value : existingConfig?.email?.smtp_host;
    cfg.email = {
        enabled: !!emailHost,
        smtp_host: emailHost || '',
        smtp_port: parseInt(document.getElementById('email-port')?.value) || existingConfig?.email?.smtp_port || 587,
        smtp_user: document.getElementById('email-user')?.value || existingConfig?.email?.smtp_user || '',
        smtp_password: document.getElementById('email-pass')?.value || existingConfig?.email?.smtp_password || '',
        smtp_tls: true,
        from_address: document.getElementById('email-from')?.value || existingConfig?.email?.from_address || '',
        to_address: document.getElementById('email-to')?.value || existingConfig?.email?.to_address || '',
    };
    
    return cfg;
}

// Auto-save current progress (without marking setup_complete)
async function autoSave() {
    try {
        // Capture current form values into memory first
        captureCurrentValues();
        
        const cfg = gatherConfig();
        cfg.setup_complete = false; // Don't mark complete until Finish
        await fetch('/api/setup/complete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(cfg)
        });
        console.log('Progress auto-saved');
    } catch(e) {
        console.log('Auto-save failed:', e);
    }
}

async function next() {
    // Validate step 5 - require preset selection
    if (step === 5) {
        const perCycle = document.getElementById('set-per-cycle')?.value;
        const interval = document.getElementById('set-interval')?.value;
        if (!perCycle || !interval) {
            alert('Please select a pacing preset before continuing.');
            return;
        }
    }
    
    // Capture current values before doing anything
    captureCurrentValues();
    
    // Auto-save progress before moving to next step
    await autoSave();
    
    if (step === STEPS.length - 1) {
        const cfg = gatherConfig();
        cfg.setup_complete = true;
        try {
            const r = await fetch('/api/setup/complete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(cfg)
            });
            const data = await r.json();
            if (data.success) window.location.href = '/';
            else alert('Setup failed: ' + data.message);
        } catch(e) { alert('Error: ' + e.message); }
        return;
    }
    step++;
    renderSteps();
    renderContent();
}

async function back() {
    // Capture current values before going back
    captureCurrentValues();
    
    // Auto-save progress before going back
    await autoSave();
    
    if (step > 0) { step--; renderSteps(); renderContent(); }
}

// Initialize - load existing config then render
loadExistingConfig().then(() => {
    renderSteps();
    renderContent();
});
</script>
</body>
</html>
