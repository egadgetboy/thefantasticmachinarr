<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - The Fantastic Machinarr</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¨</text></svg>">
    <style>
        /* Theme Variables */
        :root {
            --transition: 0.2s ease;
        }
        
        [data-theme="dark"] {
            --bg: #0c0f1a;
            --bg2: #151928;
            --bg3: #1e2538;
            --bg-hover: #252d42;
            --text: #f0f2f5;
            --text2: #8b92a5;
            --text3: #5c6478;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --success: #10b981;
            --success-bg: rgba(16, 185, 129, 0.1);
            --warn: #f59e0b;
            --warn-bg: rgba(245, 158, 11, 0.1);
            --error: #ef4444;
            --error-bg: rgba(239, 68, 68, 0.1);
            --border: #2a3246;
            --border-focus: #6366f1;
            --card-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            --glow: 0 0 20px rgba(99, 102, 241, 0.15);
        }
        
        [data-theme="light"] {
            --bg: #f8f9fb;
            --bg2: #ffffff;
            --bg3: #f0f1f4;
            --bg-hover: #e8e9ed;
            --text: #1a1d26;
            --text2: #5c6478;
            --text3: #8b92a5;
            --accent: #4f46e5;
            --accent-hover: #6366f1;
            --accent-glow: rgba(79, 70, 229, 0.2);
            --success: #059669;
            --success-bg: rgba(5, 150, 105, 0.1);
            --warn: #d97706;
            --warn-bg: rgba(217, 119, 6, 0.1);
            --error: #dc2626;
            --error-bg: rgba(220, 38, 38, 0.1);
            --border: #e2e4e9;
            --border-focus: #4f46e5;
            --card-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            --glow: 0 0 20px rgba(79, 70, 229, 0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh; /* Dynamic viewport height for mobile */
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            transition: background var(--transition), color var(--transition);
        }
        
        .wizard {
            background: var(--bg2);
            border-radius: 20px;
            width: 100%;
            max-width: 700px;
            max-height: calc(100vh - 32px);
            max-height: calc(100dvh - 32px);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            border: 1px solid var(--border);
            transition: all var(--transition);
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%);
            padding: 36px 32px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
            color: #fff;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 15px;
            color: rgba(255,255,255,0.9);
        }
        
        .theme-toggle {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            backdrop-filter: blur(10px);
            transition: all var(--transition);
        }
        
        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .steps {
            display: flex;
            justify-content: center;
            padding: 18px;
            gap: 10px;
            background: var(--bg3);
            border-bottom: 1px solid var(--border);
        }
        
        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s ease;
        }
        
        .step-dot.active {
            background: var(--accent);
            box-shadow: 0 0 12px var(--accent-glow);
            transform: scale(1.2);
        }
        
        .step-dot.done {
            background: var(--success);
        }
        
        .content {
            padding: 24px;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .content::-webkit-scrollbar {
            width: 6px;
        }
        
        .content::-webkit-scrollbar-track {
            background: var(--bg3);
            border-radius: 3px;
        }
        
        .content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        .step { display: none; animation: fadeIn 0.3s ease; }
        .step.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h2 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.3px;
        }
        
        h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            letter-spacing: -0.2px;
        }
        
        .desc {
            color: var(--text2);
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .svc {
            background: var(--bg3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            transition: all var(--transition);
        }
        
        .svc:hover {
            border-color: var(--accent);
            box-shadow: var(--glow);
        }
        
        .svc-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .svc-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }
        
        .svc-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .svc-icon.sonarr { background: linear-gradient(135deg, #00d4ff, #0099cc); }
        .svc-icon.radarr { background: linear-gradient(135deg, #ffc230, #ff9500); }
        .svc-icon.sabnzbd { background: linear-gradient(135deg, #f0a000, #cc7700); }
        
        .badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--bg2);
            color: var(--text2);
            font-weight: 500;
        }
        
        .toggle {
            width: 48px;
            height: 26px;
            background: var(--border);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: all var(--transition);
        }
        
        .toggle.on {
            background: var(--accent);
        }
        
        .toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle.on::after {
            transform: translateX(22px);
        }
        
        .fields { display: none; }
        .fields.show { display: block; }
        
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .field {
            margin-bottom: 16px;
        }
        
        .field label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
        }
        
        .field input, .field select {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            transition: all var(--transition);
        }
        
        .field input:focus, .field select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        .field input::placeholder {
            color: var(--text3);
        }
        
        .test-btn {
            width: 100%;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 10px;
            cursor: pointer;
            margin-top: 8px;
            font-weight: 500;
            transition: all var(--transition);
        }
        
        .test-btn:hover {
            border-color: var(--accent);
            background: var(--bg-hover);
        }
        
        .test-btn.ok {
            background: var(--success-bg);
            border-color: var(--success);
            color: var(--success);
        }
        
        .test-btn.fail {
            background: var(--error-bg);
            border-color: var(--error);
            color: var(--error);
        }
        
        .add-btn {
            width: 100%;
            padding: 14px;
            background: transparent;
            border: 2px dashed var(--border);
            border-radius: 12px;
            color: var(--text2);
            cursor: pointer;
            font-weight: 500;
            transition: all var(--transition);
        }
        
        .add-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-glow);
        }
        
        .remove {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 20px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all var(--transition);
        }
        
        .remove:hover {
            background: var(--error-bg);
        }
        
        .footer {
            display: flex;
            justify-content: space-between;
            padding: 20px 32px;
            border-top: 1px solid var(--border);
            background: var(--bg3);
        }
        
        .btn {
            padding: 12px 28px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all var(--transition);
        }
        
        .btn-sec {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-sec:hover {
            background: var(--bg-hover);
            border-color: var(--text3);
        }
        
        .btn-pri {
            background: var(--accent);
            color: #fff;
        }
        
        .btn-pri:hover {
            background: var(--accent-hover);
            box-shadow: 0 4px 12px var(--accent-glow);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .info {
            background: var(--accent-glow);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 16px;
            font-size: 13px;
            color: var(--text2);
            margin-top: 20px;
            line-height: 1.6;
        }
        
        .tiers {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 20px 0;
        }
        
        .tier {
            background: var(--bg3);
            padding: 16px 12px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all var(--transition);
        }
        
        .tier:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        
        .tier-emoji {
            font-size: 32px;
            margin-bottom: 4px;
        }
        
        .tier-name {
            font-weight: 600;
            margin: 6px 0;
            font-size: 14px;
        }
        
        .tier-desc {
            font-size: 11px;
            color: var(--text2);
        }
        
        .summary {
            background: var(--bg3);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        
        .sum-item {
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .sum-sub {
            margin-left: 28px;
            font-size: 13px;
            color: var(--text2);
            margin-top: 4px;
        }
        
        .check-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .check-row:last-child {
            border: none;
        }
        
        .check-row label {
            flex: 1;
            font-size: 14px;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--accent);
            cursor: pointer;
        }
        
        .version-footer {
            text-align: center;
            padding: 12px;
            font-size: 11px;
            color: var(--text3);
            border-top: 1px solid var(--border);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .wizard { border-radius: 16px; }
            .header { padding: 24px 20px; }
            .header h1 { font-size: 20px; }
            .content { padding: 20px; max-height: calc(100vh - 240px); }
            .tiers { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .tier { padding: 12px 8px; }
            .tier-emoji { font-size: 24px; }
            .tier-name { font-size: 13px; }
            .row { grid-template-columns: 1fr; }
            .footer { padding: 16px 20px; }
            .btn { padding: 10px 20px; font-size: 13px; }
            .info { padding: 12px; font-size: 12px; }
            .desc { font-size: 13px; }
        }
        
        @media (max-width: 480px) {
            .header h1 { font-size: 18px; }
            .header p { font-size: 13px; }
            .tiers { grid-template-columns: 1fr 1fr; gap: 8px; }
            .tier { padding: 10px 6px; }
            .tier-emoji { font-size: 22px; }
            .tier-name { font-size: 12px; }
            h2 { font-size: 18px; }
            h3 { font-size: 14px; }
        }
    </style>
</head>
<body>
<div class="wizard">
    <div class="header">
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">üåô</button>
        <h1>üé¨ The Fantastic Machinarr</h1>
        <p>Intelligent media library automation</p>
    </div>
    <div class="steps" id="steps"></div>
    <div class="content" id="content"></div>
    <div class="footer">
        <button class="btn btn-sec" id="backBtn" onclick="back()" disabled>Back</button>
        <button class="btn btn-pri" id="nextBtn" onclick="next()">Next</button>
    </div>
    <div class="version-footer">The Fantastic Machinarr v1.0.6b</div>
</div>
<script>
// Theme management
function toggleTheme() {
    const html = document.documentElement;
    const current = html.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', next);
    localStorage.setItem('tfm-theme', next);
    document.querySelector('.theme-toggle').textContent = next === 'dark' ? 'üåô' : '‚òÄÔ∏è';
}

// Load saved theme
const savedTheme = localStorage.getItem('tfm-theme') || 'dark';
document.documentElement.setAttribute('data-theme', savedTheme);
document.querySelector('.theme-toggle').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
const STEPS = ['Welcome', 'Sonarr', 'Radarr', 'SABnzbd', 'Auto-Resolution', 'Settings', 'Complete'];
let step = 0;
const instances = { sonarr: [{id:1,on:true}], radarr: [{id:1,on:true}], sabnzbd: [{id:1,on:false}] };
let counters = { sonarr:1, radarr:1, sabnzbd:1 };
let baseUrl = '';

function renderSteps() {
    document.getElementById('steps').innerHTML = STEPS.map((_, i) => 
        `<div class="step-dot ${i < step ? 'done' : i === step ? 'active' : ''}" data-step="${i}"></div>`
    ).join('');
}

function renderContent() {
    const c = document.getElementById('content');
    if (step === 0) c.innerHTML = stepWelcome();
    else if (step === 1) c.innerHTML = stepService('sonarr', 'üì∫', 'TV Shows');
    else if (step === 2) c.innerHTML = stepService('radarr', 'üé¨', 'Movies');
    else if (step === 3) c.innerHTML = stepService('sabnzbd', 'üì•', 'Downloads');
    else if (step === 4) c.innerHTML = stepAutoRes();
    else if (step === 5) c.innerHTML = stepSettings();
    else if (step === 6) c.innerHTML = stepComplete();
    
    document.getElementById('backBtn').disabled = step === 0;
    document.getElementById('nextBtn').textContent = step === STEPS.length - 1 ? 'Finish' : 'Next';
}

function stepWelcome() {
    return `
    <div class="step active">
        <h2>üëã Welcome!</h2>
        <p class="desc">TFM continuously searches for missing content using a smart tier-based system ‚Äî prioritizing new releases while filling out your entire library in the background.</p>
        
        <div class="field" style="margin-top: 16px;">
            <label>üåê Server Base URL</label>
            <input type="text" id="base-url" placeholder="http://192.168.1.100" value="${baseUrl}" onchange="updateBaseUrl(this.value)">
            <div style="font-size: 11px; color: var(--text3); margin-top: 4px;">Used to prefill Sonarr, Radarr, and SABnzbd URLs</div>
        </div>
        
        <div class="field" style="margin-top: 16px;">
            <label>üìä Daily API Limit</label>
            <input type="number" id="api-limit" value="500" min="50" max="50000">
            <div style="font-size: 11px; color: var(--text3); margin-top: 4px;">
                <strong>Single indexer:</strong> Check your dashboard (common: 1000-5000/day)<br>
                <strong>Multiple:</strong> Add up limits + ~2000 per "unlimited" one. Adjust anytime in Settings.
            </div>
        </div>
        
        <h3 style="margin-top: 20px; margin-bottom: 6px;">üéØ Search Tiers</h3>
        <p class="desc" style="margin-bottom: 10px;">Define age ranges and search frequency. Hot = highest priority, searched most often.</p>
        
        <div class="tiers">
            <div class="tier">
                <div class="tier-emoji">üî•</div>
                <div class="tier-name">Hot</div>
                <div style="display: flex; gap: 4px; align-items: center; margin: 8px 0;">
                    <span style="font-size: 11px; color: var(--text3);">0 to</span>
                    <select id="tier-hot-max" style="flex:1; padding: 6px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 11px;">
                        <option value="7">7d</option>
                        <option value="14">14d</option>
                        <option value="30">1mo</option>
                        <option value="90" selected>3mo</option>
                        <option value="180">6mo</option>
                    </select>
                </div>
                <select id="tier-hot" style="width: 100%; padding: 8px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px;">
                    <option value="30">30 min</option>
                    <option value="60" selected>1 hour</option>
                    <option value="120">2 hours</option>
                    <option value="180">3 hours</option>
                </select>
                <input type="hidden" id="tier-hot-min" value="0">
            </div>
            <div class="tier">
                <div class="tier-emoji">‚òÄÔ∏è</div>
                <div class="tier-name">Warm</div>
                <div style="display: flex; gap: 4px; align-items: center; margin: 8px 0;">
                    <select id="tier-warm-min" style="flex:1; padding: 6px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 11px;">
                        <option value="90" selected>3mo</option>
                        <option value="180">6mo</option>
                    </select>
                    <span style="font-size: 11px; color: var(--text3);">to</span>
                    <select id="tier-warm-max" style="flex:1; padding: 6px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 11px;">
                        <option value="180">6mo</option>
                        <option value="365" selected>1yr</option>
                        <option value="730">2yr</option>
                    </select>
                </div>
                <select id="tier-warm" style="width: 100%; padding: 8px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px;">
                    <option value="180">3 hours</option>
                    <option value="360" selected>6 hours</option>
                    <option value="720">12 hours</option>
                    <option value="1440">Daily</option>
                </select>
            </div>
            <div class="tier">
                <div class="tier-emoji">‚ùÑÔ∏è</div>
                <div class="tier-name">Cool</div>
                <div style="display: flex; gap: 4px; align-items: center; margin: 8px 0;">
                    <select id="tier-cool-min" style="flex:1; padding: 6px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 11px;">
                        <option value="365" selected>1yr</option>
                        <option value="730">2yr</option>
                    </select>
                    <span style="font-size: 11px; color: var(--text3);">to</span>
                    <select id="tier-cool-max" style="flex:1; padding: 6px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 11px;">
                        <option value="730">2yr</option>
                        <option value="1095" selected>3yr</option>
                        <option value="1825">5yr</option>
                    </select>
                </div>
                <select id="tier-cool" style="width: 100%; padding: 8px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px;">
                    <option value="720">12 hours</option>
                    <option value="1440" selected>Daily</option>
                    <option value="2880">2 days</option>
                    <option value="4320">3 days</option>
                </select>
            </div>
            <div class="tier">
                <div class="tier-emoji">üßä</div>
                <div class="tier-name">Cold</div>
                <div style="display: flex; gap: 4px; align-items: center; margin: 8px 0;">
                    <select id="tier-cold-min" style="flex:1; padding: 6px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 11px;">
                        <option value="1095" selected>3yr</option>
                        <option value="1825">5yr</option>
                    </select>
                    <span style="font-size: 11px; color: var(--text3);">to ‚àû</span>
                </div>
                <select id="tier-cold" style="width: 100%; padding: 8px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px;">
                    <option value="4320">3 days</option>
                    <option value="10080" selected>Weekly</option>
                    <option value="20160">2 weeks</option>
                    <option value="43200">Monthly</option>
                </select>
            </div>
        </div>
        
        <div class="info" style="margin-top: 12px; padding: 12px; font-size: 12px;">
            <strong>üí° Tip:</strong> Age = when added to wanted list (new content) or release date (older content). Hot gets the most API calls.
        </div>
    </div>`;
}

function updateBaseUrl(val) {
    baseUrl = val.replace(/\/+$/, ''); // Remove trailing slashes
}

function getDefaultUrl(svc) {
    const ports = {sonarr:'8989', radarr:'7878', sabnzbd:'8080'};
    if (baseUrl) {
        return `${baseUrl}:${ports[svc]}`;
    }
    return '';
}

function stepService(svc, icon, desc) {
    const name = svc.charAt(0).toUpperCase() + svc.slice(1);
    const ports = {sonarr:'8989', radarr:'7878', sabnzbd:'8080'};
    const defaultUrl = getDefaultUrl(svc);
    let html = `<div class="step active"><h2>${icon} ${name}</h2><p class="desc">Configure your ${name} instance(s) for ${desc}.</p><div id="${svc}-list">`;
    
    instances[svc].forEach((inst, i) => {
        const badge = i === 0 ? 'Primary' : `Instance ${inst.id}`;
        const urlValue = i === 0 && defaultUrl ? defaultUrl : '';
        html += `
        <div class="svc" data-id="${svc}-${inst.id}">
            <div class="svc-head">
                <div class="svc-title"><div class="svc-icon ${svc}">${icon}</div><span>${name}</span><span class="badge">${badge}</span></div>
                <div style="display:flex;gap:8px;align-items:center">
                    <div class="toggle ${inst.on?'on':''}" onclick="toggleSvc('${svc}',${inst.id},this)"></div>
                    ${i > 0 ? `<button class="remove" onclick="removeSvc('${svc}',${inst.id})">√ó</button>` : ''}
                </div>
            </div>
            <div class="fields ${inst.on?'show':''}" id="fields-${svc}-${inst.id}">
                <div class="row">
                    <div class="field"><label>URL</label><input type="text" id="${svc}-${inst.id}-url" placeholder="http://192.168.1.100:${ports[svc]}" value="${urlValue}"></div>
                    <div class="field"><label>API Key</label><input type="password" id="${svc}-${inst.id}-key" placeholder="Your API key"></div>
                </div>
                <div class="field"><label>Name (optional)</label><input type="text" id="${svc}-${inst.id}-name" placeholder="e.g., ${name} 4K"></div>
                <button class="test-btn" onclick="testSvc('${svc}',${inst.id},this)">Test Connection</button>
            </div>
        </div>`;
    });
    
    html += `</div><button class="add-btn" onclick="addSvc('${svc}')">+ Add Another ${name}</button>`;
    if (svc === 'sabnzbd') html += `<div class="info">üí° SABnzbd is optional. Skip if using a different download client.</div>`;
    html += `</div>`;
    return html;
}

function stepAutoRes() {
    return `
    <div class="step active">
        <h2>üîß Auto-Resolution Settings</h2>
        <p class="desc">Choose which stuck queue issues to resolve automatically.</p>
        <div class="svc">
            <div class="check-row"><label>üóëÔ∏è No files found / eligible for import</label><input type="checkbox" id="ar-no_files_found" checked></div>
            <div class="check-row"><label>üìΩÔ∏è File is a sample only</label><input type="checkbox" id="ar-sample_only" checked></div>
            <div class="check-row"><label>‚ùì Unknown series/movie</label><input type="checkbox" id="ar-unknown_series" checked></div>
            <div class="check-row"><label>‚ö†Ô∏è Unexpected episode</label><input type="checkbox" id="ar-unexpected_episode" checked></div>
            <div class="check-row"><label>üî¢ Invalid season/episode</label><input type="checkbox" id="ar-invalid_season_episode" checked></div>
            <div class="check-row"><label>üîá No audio tracks detected</label><input type="checkbox" id="ar-no_audio_tracks" checked></div>
            <div class="check-row"><label>‚ùå Import failed</label><input type="checkbox" id="ar-import_failed" checked></div>
            <div class="check-row"><label>üì• Download failed</label><input type="checkbox" id="ar-download_failed" checked></div>
            <div class="check-row"><label>üìÅ Path not valid (needs manual fix)</label><input type="checkbox" id="ar-path_not_valid"></div>
        </div>
        <div class="field" style="margin-top:16px">
            <label>Wait time before auto-resolving (minutes)</label>
            <input type="number" id="ar-wait" value="30" min="5" max="120">
        </div>
    </div>`;
}

function stepSettings() {
    return `
    <div class="step active">
        <h2>‚öôÔ∏è Additional Settings</h2>
        <p class="desc">Fine-tune how TFM searches and when you get notified.</p>
        
        <h3 style="margin: 0 0 8px;">üîç Search Behavior</h3>
        
        <div class="info" style="margin: 0 0 16px; padding: 12px; font-size: 12px;">
            <strong>How searching works:</strong> TFM runs in "cycles." Each cycle, it picks items from your missing content and searches your indexers for them. These settings control the pace.
        </div>
        
        <div class="row">
            <div class="field">
                <label>Searches Per Cycle</label>
                <input type="number" id="set-per-cycle" value="10" min="1" max="50">
                <div style="font-size: 11px; color: var(--text3); margin-top: 4px;">
                    How many items TFM searches each cycle.<br>
                    <strong>Lower (5-10):</strong> Gentler on indexers, slower progress<br>
                    <strong>Higher (20-50):</strong> Faster progress, uses more API calls
                </div>
            </div>
            <div class="field">
                <label>Cycle Interval (minutes)</label>
                <input type="number" id="set-interval" value="60" min="15" max="360">
                <div style="font-size: 11px; color: var(--text3); margin-top: 4px;">
                    Time between search cycles.<br>
                    <strong>Shorter (15-30):</strong> More frequent searches<br>
                    <strong>Longer (60-120):</strong> More spread out, fewer API calls
                </div>
            </div>
        </div>
        
        <div class="info" style="margin: 0 0 20px; padding: 10px; font-size: 11px; background: var(--success-bg); border-color: var(--success);">
            <strong>üí° Example:</strong> 10 searches every 60 min = ~240 API calls/day. 20 searches every 30 min = ~960 API calls/day. Stay within your Daily API Limit!
        </div>
        
        <h3 style="margin: 0 0 8px;">üìß Email Notifications (Optional)</h3>
        <p class="desc" style="margin-bottom: 12px;">Get notified when TFM finds content, encounters issues, or needs your attention. Leave blank to skip.</p>
        <div class="row">
            <div class="field"><label>SMTP Host</label><input type="text" id="email-host" placeholder="smtp.gmail.com"></div>
            <div class="field"><label>SMTP Port</label><input type="number" id="email-port" value="587"></div>
        </div>
        <div class="row">
            <div class="field"><label>Username</label><input type="text" id="email-user" placeholder="your@email.com"></div>
            <div class="field"><label>Password</label><input type="password" id="email-pass" placeholder="App password"></div>
        </div>
        <div class="row">
            <div class="field"><label>From Address</label><input type="text" id="email-from" placeholder="tfm@yourdomain.com"></div>
            <div class="field"><label>To Address</label><input type="text" id="email-to" placeholder="you@example.com"></div>
        </div>
    </div>`;
}

function stepComplete() {
    const cfg = gatherConfig();
    let html = `<div class="step active" style="text-align:center"><div style="font-size:64px">üéâ</div><h2>All Set!</h2><p class="desc">Your Fantastic Machinarr is ready.</p><div class="summary" style="text-align:left">`;
    
    ['sonarr','radarr','sabnzbd'].forEach(svc => {
        const icon = {sonarr:'üì∫', radarr:'üé¨', sabnzbd:'üì•'}[svc];
        const name = svc.charAt(0).toUpperCase() + svc.slice(1);
        const insts = cfg[svc + '_instances'];
        html += `<div class="sum-item">${icon} <strong>${name}:</strong> ${insts.length} instance(s)</div>`;
        insts.forEach(i => { html += `<div class="sum-sub">‚Ä¢ ${i.name || i.url}</div>`; });
    });
    
    html += `</div></div>`;
    return html;
}

function toggleSvc(svc, id, el) {
    el.classList.toggle('on');
    const on = el.classList.contains('on');
    document.getElementById(`fields-${svc}-${id}`).classList.toggle('show', on);
    const inst = instances[svc].find(i => i.id === id);
    if (inst) inst.on = on;
}

function addSvc(svc) {
    counters[svc]++;
    instances[svc].push({id: counters[svc], on: true});
    renderContent();
}

function removeSvc(svc, id) {
    instances[svc] = instances[svc].filter(i => i.id !== id);
    renderContent();
}

async function testSvc(svc, id, btn) {
    const url = document.getElementById(`${svc}-${id}-url`).value;
    const key = document.getElementById(`${svc}-${id}-key`).value;
    if (!url || !key) { alert('Enter URL and API key'); return; }
    
    btn.textContent = 'Testing...';
    try {
        const r = await fetch(`/api/test/${svc}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url, api_key: key})
        });
        const data = await r.json();
        btn.textContent = data.success ? '‚úì Connected' : '‚úó Failed';
        btn.className = 'test-btn ' + (data.success ? 'ok' : 'fail');
    } catch(e) {
        btn.textContent = '‚úó Error';
        btn.className = 'test-btn fail';
    }
    setTimeout(() => { btn.textContent = 'Test Connection'; btn.className = 'test-btn'; }, 3000);
}

function gatherConfig() {
    const cfg = { sonarr_instances: [], radarr_instances: [], sabnzbd_instances: [] };
    
    ['sonarr','radarr','sabnzbd'].forEach(svc => {
        instances[svc].forEach(inst => {
            const url = document.getElementById(`${svc}-${inst.id}-url`)?.value || '';
            const key = document.getElementById(`${svc}-${inst.id}-key`)?.value || '';
            const name = document.getElementById(`${svc}-${inst.id}-name`)?.value || `${svc} ${inst.id}`;
            if (inst.on && url && key) {
                cfg[svc + '_instances'].push({ url, api_key: key, name, enabled: true });
            }
        });
    });
    
    // Tier intervals and age ranges (in days)
    cfg.tiers = {
        hot: {
            min_days: parseInt(document.getElementById('tier-hot-min')?.value) || 0,
            max_days: parseInt(document.getElementById('tier-hot-max')?.value) || 90,
            interval_minutes: parseInt(document.getElementById('tier-hot')?.value) || 60
        },
        warm: {
            min_days: parseInt(document.getElementById('tier-warm-min')?.value) || 90,
            max_days: parseInt(document.getElementById('tier-warm-max')?.value) || 365,
            interval_minutes: parseInt(document.getElementById('tier-warm')?.value) || 360
        },
        cool: {
            min_days: parseInt(document.getElementById('tier-cool-min')?.value) || 365,
            max_days: parseInt(document.getElementById('tier-cool-max')?.value) || 1095,
            interval_minutes: parseInt(document.getElementById('tier-cool')?.value) || 1440
        },
        cold: {
            min_days: parseInt(document.getElementById('tier-cold-min')?.value) || 1095,
            max_days: null, // No upper limit
            interval_minutes: parseInt(document.getElementById('tier-cold')?.value) || 10080
        }
    };
    
    // Auto-resolution
    cfg.auto_resolution = {
        enabled: true,
        no_files_found: document.getElementById('ar-no_files_found')?.checked ?? true,
        sample_only: document.getElementById('ar-sample_only')?.checked ?? true,
        unknown_series: document.getElementById('ar-unknown_series')?.checked ?? true,
        unexpected_episode: document.getElementById('ar-unexpected_episode')?.checked ?? true,
        invalid_season_episode: document.getElementById('ar-invalid_season_episode')?.checked ?? true,
        no_audio_tracks: document.getElementById('ar-no_audio_tracks')?.checked ?? true,
        import_failed: document.getElementById('ar-import_failed')?.checked ?? true,
        download_failed: document.getElementById('ar-download_failed')?.checked ?? true,
        path_not_valid: document.getElementById('ar-path_not_valid')?.checked ?? false,
        wait_minutes_before_action: parseInt(document.getElementById('ar-wait')?.value) || 30,
    };
    
    // Search settings - API limit from welcome page
    cfg.search = {
        enabled: true,
        daily_api_limit: parseInt(document.getElementById('api-limit')?.value) || 500,
        searches_per_cycle: parseInt(document.getElementById('set-per-cycle')?.value) || 10,
        cycle_interval_minutes: parseInt(document.getElementById('set-interval')?.value) || 60,
    };
    
    // Email
    const emailHost = document.getElementById('email-host')?.value;
    cfg.email = {
        enabled: !!emailHost,
        smtp_host: emailHost || '',
        smtp_port: parseInt(document.getElementById('email-port')?.value) || 587,
        smtp_user: document.getElementById('email-user')?.value || '',
        smtp_password: document.getElementById('email-pass')?.value || '',
        smtp_tls: true,
        from_address: document.getElementById('email-from')?.value || '',
        to_address: document.getElementById('email-to')?.value || '',
    };
    
    return cfg;
}

async function next() {
    if (step === STEPS.length - 1) {
        const cfg = gatherConfig();
        cfg.setup_complete = true;
        try {
            const r = await fetch('/api/setup/complete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(cfg)
            });
            const data = await r.json();
            if (data.success) window.location.href = '/';
            else alert('Setup failed: ' + data.message);
        } catch(e) { alert('Error: ' + e.message); }
        return;
    }
    step++;
    renderSteps();
    renderContent();
}

function back() {
    if (step > 0) { step--; renderSteps(); renderContent(); }
}

renderSteps();
renderContent();
</script>
</body>
</html>
